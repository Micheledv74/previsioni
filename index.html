<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Previsioni Procida - Stile AccuWeather</title>
  <style>
    body { font-family: Arial, max-width: 920px; margin: auto; background: linear-gradient(#182948,#374058); color: #fff; padding: 30px;}
    .tabs { display: flex; gap: 8px; margin-bottom: 24px; }
    .tab { background: rgba(255,255,255,0.12); border: 1px solid #333b4a; padding: 16px 28px; border-radius: 8px; cursor: pointer;}
    .tab.active { background: #0580ff; color: #fff; border-bottom: 3px solid #fff;}
    .card { background: rgba(255,255,255,0.08); border-radius:16px; padding:24px; margin-bottom:18px; }
    .bigicon { font-size:68px; }
    .tempmax { font-size:32px; font-weight:bold; }
    .tempmin { font-size:20px; color:#9bdfff; }
    .details { font-size:17px; color:#b2b9cd;}
    .underline { border-bottom: 1.5px solid #224;}
    canvas { background: rgba(255,255,255,0.12); border-radius:8px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div id="tabbar" class="tabs"></div>
  <div id="daycard"></div>
  <div id="chartcontainer"></div>
  <script>
    // Mappa dei codici Open-Meteo → emoji
    function iconFromCode(code, hour) {
      if (code === 0) return hour >= 6 && hour < 20 ? "☀️" : "🌙";
      if (code === 1) return hour >= 6 && hour < 20 ? "🌤️" : "☁️";
      if ([2,3].includes(code)) return "⛅";
      if ([45,48].includes(code)) return "🌫️";
      if ([51,53,55].includes(code)) return "🌦️";
      if ([56,57].includes(code)) return "🌧️";
      if ([61,63,65].includes(code)) return "🌦️";
      if ([66,67].includes(code)) return "🌧️";
      if ([71,73,75,77,85,86].includes(code)) return "❄️";
      if ([80,81,82].includes(code)) return "🌧️";
      if ([95,96,99].includes(code)) return "🌩️";
      return "☁️";
    }

    // Estrai dati dal backend n8n
    const days = undefined;
    let current = 0;

    // Tab interattivi
    function renderTabs() {
      const tabbar = document.getElementById('tabbar');
      tabbar.innerHTML = '';
      days.forEach((d, idx) => {
        // Scegli l'ora delle 14 come ora centrale per l'icona (se disponibile)
        const middayIdx = d.hourly_labels.findIndex(h => h.startsWith('14')) !== -1
          ? d.hourly_labels.findIndex(h => h.startsWith('14'))
          : Math.floor(d.icons ? d.icons.length/2 : d.hourly_labels.length/2);
        const baseIcon = d.icons ? d.icons[middayIdx] : iconFromCode(d.weather_code ? d.weather_code : 0, 14);
        el = document.createElement('div');
        el.className = idx === current ? 'tab active' : 'tab';
        el.innerHTML = `<div class="bigicon">${d.icon || baseIcon}</div>
          <div>${d.day_label}</div>
          <div><span class="tempmax">${d.temp_max}°</span> <span class="tempmin">${d.temp_min}°</span></div>`;
        el.onclick = () => { current = idx; renderAll(); };
        tabbar.appendChild(el);
      });
    }

    // Card giorno
    function renderCard() {
      const d = days[current];
      document.getElementById('daycard').innerHTML = `<div class="card underline">
        <div style="display:flex;align-items:center;">
          <div class="bigicon">${d.icon}</div>
          <div style="margin-left:20px;">
            <div class="tempmax">${d.temp_max}°C <span class="tempmin">${d.temp_min}°C</span></div>
            <div class="details">Precipitazioni: ${d.precipitation} mm<br>
            Aggiornamento: 09/10/2025, 09:42:46</div>
          </div>
        </div>
      </div>`;
    }

    // Grafico temperatura, labels → bianche
    let chart = null;
    function renderChart() {
      const d = days[current];
      const chartDiv = document.getElementById('chartcontainer');
      chartDiv.innerHTML = `<div class="card"><canvas id="chart" width="775" height="240"></canvas></div>`;
      const ctx = document.getElementById('chart').getContext('2d');
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: d.hourly_labels,
          datasets: [{
            label: 'Temperatura (°C)',
            data: d.hourly_temps,
            borderColor: 'rgba(255,214,91,1)',
            backgroundColor: 'rgba(255,214,91,0.15)',
            fill: true,
            tension: 0.3,
            pointRadius: 2
          }]
        },
        options: {
          plugins: { 
            legend: { display:true, labels: { color:'#fff', font: {weight:'bold', size:16} } }
          },
          scales: {
            y: { beginAtZero: false, title: { display: true, text: '°C', color: '#fff' }, ticks: { color:'#fff', font: {weight:'bold'} }},
            x: { title: { display: true, text: 'Ora locale', color:'#fff' }, ticks: { color: '#fff', font: {weight:'bold', size:16}, maxRotation:0, minRotation:0 } }
          }
        }
      });
    }

    // Render
    function renderAll() {
      if (!days || days.length === 0) {
        document.body.innerHTML = "<h2 style='color:#fff'>Nessun dato meteo disponibile!</h2>";
        return;
      }
      renderTabs();
      renderCard();
      renderChart();
    }
    renderAll();
  </script>
</body>
</html>
