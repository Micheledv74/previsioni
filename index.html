<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes" />
  <title>Previsioni Procida - Dashboard Meteo</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Roboto&display=swap');
    html { box-sizing: border-box;} *,*:before,*:after { box-sizing: inherit; }
    body { font-family: 'Roboto', Arial, sans-serif; max-width: 1000px; margin: 0 auto;
      background: linear-gradient(135deg, #26365a, #3498db 92%); color: #f0f8ff;
      padding: 14px 2px 18px 2px; overflow-x: hidden; min-height: 100vh; }
    .header { font-family: 'Montserrat', sans-serif; font-size: 2.45em; font-weight: 900;
      text-align: center; color: #cfe9ff; text-shadow: 1px 2px 14px #09172a;
      letter-spacing: 2px; user-select: none; margin-bottom: 19px; }
    .dashboard { display: flex; flex-wrap: wrap; gap: 19px; justify-content: center; }
    .box { background: rgba(37,59,102,0.22); border-radius: 18px;
      box-shadow: 0 5px 26px #06214672; padding: 16px 14px 36px 14px;
      flex: 1 1 310px; max-width: 410px; min-width: 215px;
      display: flex; flex-direction: column; align-items: center; margin-bottom: 13px;
      position: relative; }
    .box-title { font-size: 1.17rem; font-weight: 900; color: #a9edff;
      letter-spacing: 1px; margin-bottom: 11px; font-family: 'Montserrat', sans-serif; }
    .box .main { font-weight: 700; font-size: 1.11em; color:#84dbff; text-align:center; }
    .box .desc { margin: 2px 0 0 0; font-size:1.01em; color:#c3ccdf; text-align:center; }
    .wind-info { font-weight: 700; font-size: 1.11em; margin: 0;
      display: flex; justify-content: center; gap: 12px; }
    .wind-info span { display: inline-block; }
    .wind-info .wind-speed { color: #84dbff; }
    .wind-info .wind-dir { color: #c3ccdf; }
    .folata-max { color: #84dbff; font-weight: 700; font-size: 1.11em; margin-top: 6px; }
    .box-summary { width: 97%; margin: 0 auto; margin-top: 13px;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      font-size: 1.01em; gap: 2px; }
    .box-summary-row { width: 100%; display: flex; flex-direction: row;
      justify-content: center; gap: 16px; flex-wrap: wrap; }
    .box-summary-row2 { text-align:center; width:100%; }
    .summary-label { font-weight: 700; }
    .summary-max { color: #ffd472; }
    .summary-min { color: #6fd7f8; }
    .summary-dir { color: #8effa6; }
    .summary-mean { color: #b6fffa; }
    .summary-range { color: #fee3a1; }
    .summary-std { color: #c2cafd;}
    .summary-trend-up { color: #09e889; }
    .summary-trend-down { color: #ff9a00; }
    .summary-trend-stable { color: #ffd472; }
    .summary-hour { color: #e0deff;}
    button.detail-btn { margin-top:9px; background: #127af7; color: #fff;
      font-weight:700; border: none; border-radius: 8px; padding: 11px 24px;
      cursor: pointer; transition: background 0.12s; }
    button.detail-btn:hover { background: #45bafe; }
    .detail-section { display: none; margin-top: 8px; width: 100%; }
    .detail-section.active { display: block; }
    .chart-wrap { width: 99%; max-width: 385px; margin: 0 auto 8px auto;
      border-radius: 13px; background: #213260d0; padding: 11px 5px 7px 5px; }
    .mini-days { display:flex; flex-wrap:wrap; gap:8px; margin:18px auto 7px auto;
      justify-content:center; }
    .mini-day { background: #0b1333b0; color: #c6f3ff; border-radius:11px;
      padding:9px 15px; font-size:1em; min-width:85px;
      box-shadow: 0 2px 8px #202b3b44; cursor: pointer; user-select: none; }
    .mini-day:hover { background: rgba(79, 117, 203, 0.47); }
    .mini-day.active { background: rgba(91, 144, 197, 0.78);
      box-shadow: 0 0 12px #dbefff; }
    .footer { margin-top: 32px; text-align: center; color: #dbefff;
      font-size: 17px; font-weight: 500; text-shadow: 0 2px 6px #283c5880; }
    @media (max-width: 800px) {
      .dashboard { gap: 12px; }
      .box { min-width: 180px; max-width: 97vw; }
    }
    @media (max-width: 650px) {
      .dashboard { flex-direction: column; align-items: center; gap: 14px; }
      .box { width: 100%; max-width: 98vw; }
      .header { font-size: 1.17em; }
    }
    @media (max-width: 510px) {
      .mini-day { padding: 6px 5px; font-size: 0.93em; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="header">PREVISIONI METEO PROCIDA</div>
  <div class="dashboard">
    <section class="box vento" id="windbox"></section>
    <section class="box pioggia" id="rainbox"></section>
    <section class="box mare" id="seabox"></section>
    <section class="box pressione" id="pressbox"></section>
  </div>
  <div class="mini-days" id="miniDaysBox"></div>
  <div class="footer" id="footer"></div>

  <script>
    // =========================================
    // INIEZIONE DINAMICA DEI DATI VIA N8N
    // =========================================
    const RAW_API_DATA = <%= JSON.stringify($json) %>;

    function processAPIData(apiData) {
      const data = Array.isArray(apiData) ? apiData[0] : apiData;
      // Raggruppa mare per data
      const seaGrouped = {};
      data.mergedHourly.forEach(e => {
        const day = e.time.split('T')[0];
        if (!seaGrouped[day]) seaGrouped[day] = [];
        seaGrouped[day].push({
          time: e.time.split('T')[1].slice(0,5),
          wave_height: e.wave_height,
          sea_surface_temperature: e.sea_surface_temperature,
          swell_height: e.swell_height,
          swell_direction: e.swell_direction
        });
      });
      const sea = Object.keys(seaGrouped).sort().map(d => seaGrouped[d]);

      // Processa giorni
      const days = data.days.map(day => {
        const windMax = Math.max(...day.hourly_winds);
        return {
          day_label: day.day_label,
          icon: day.icon,
          temp_max: day.temp_max,
          temp_min: day.temp_min,
          precipitation: day.precipitation,
          wind_max: Math.round(windMax),
          wind_gust: Math.round(windMax * 1.4),
          wind_min: Math.round(Math.min(...day.hourly_winds)),
          wind_dir: day.hourly_wind_directions[0],
          hourly_winds: day.hourly_winds,
          hourly_wind_directions: day.hourly_wind_directions,
          hourly_labels: day.hourly_labels,
          hourly_precips: day.hourly_precips,
          hourly_pressures: day.hourly_pressures
        };
      });

      return { days, sea, updated_at: data.updated_at || '' };
    }

    const DATA = processAPIData(RAW_API_DATA);
    let selectedDayIndex = 0;
    let windChart, rainChart, seaChart, pressChart;

    function rainIcon(val) {
      if (val<0.1) return ''; if (val<0.5) return 'üíß';
      if (val<1) return 'üíßüíß'; if (val<3) return 'üíßüíßüíß';
      if (val<10) return 'üíßüíßüíßüíß'; return 'üíßüíßüíßüíßüíß';
    }
    function windDirectionName(deg) {
      const winds=[
        {name:"Tramontana",abbr:"N"},{name:"Grecale",abbr:"NE"},
        {name:"Levante",abbr:"E"},{name:"Scirocco",abbr:"SE"},
        {name:"Ostro",abbr:"S"},{name:"Libeccio",abbr:"SO"},
        {name:"Ponente",abbr:"O"},{name:"Maestrale",abbr:"NO"}];
      return winds[Math.floor(((deg+22.5)%360)/45)]?.name+' ('+winds[Math.floor(((deg+22.5)%360)/45)].abbr+')'||'N/D';
    }
    function calculateMean(a){return a.reduce((x,y)=>x+y,0)/a.length;}
    function calculateRange(a){return Math.max(...a)-Math.min(...a);}
    function calculateStdDev(a){const m=calculateMean(a); return Math.sqrt(a.reduce((x,y)=>x+(y-m)**2,0)/a.length);}
    function pressureTrend(a){
      const s=(a[0]+a[1]+a[2])/3, e=(a[a.length-3]+a[a.length-2]+a[a.length-1])/3;
      if(e>s+1) return '<span style="color:#09e889">in aumento ‚ÜóÔ∏è</span>';
      if(s>e+1) return '<span style="color:#ff9a00">in calo ‚ÜòÔ∏è</span>';
      return '<span style="color:#ffd472">stabile ‚ÜîÔ∏è</span>';
    }

    function toggleDetail(id) {
      document.querySelectorAll('.detail-section').forEach(el=>{if(el.id!==id) el.classList.remove('active');});
      document.getElementById(id).classList.toggle('active');
    }

    function renderMiniDays(){
      const html=DATA.days.map((d,i)=>
        `<div class="mini-day${i===selectedDayIndex?' active':''}" onclick="selectDay(${i})">${d.day_label} <span class="icon">${d.icon}</span></div>`
      ).join('');
      document.getElementById('miniDaysBox').innerHTML=html;
    }
    function selectDay(i){selectedDayIndex=i; renderAll();}

    function renderWind(){
      const d=DATA.days[selectedDayIndex];
      document.getElementById('windbox').innerHTML=`
        <div class="box-title">üå¨Ô∏è Vento</div>
        <p class="wind-info">
          <span class="wind-speed">üçÉ ${d.hourly_winds[new Date().getHours()]} km/h</span>
          <span class="wind-dir">‚éã ${d.hourly_wind_directions[new Date().getHours()]}¬∞ ${windDirectionName(d.hourly_wind_directions[new Date().getHours()])}</span>
        </p>
        <div class="folata-max">Folata max: <b>${d.wind_gust} km/h</b></div>
        <button class="detail-btn" onclick="toggleDetail('wind-detail')">Dettagli / Grafico</button>
        <div id="wind-detail" class="detail-section"><div class="chart-wrap"><canvas id="windchart"></canvas></div></div>
        <div class="box-summary">
          <div class="box-summary-row">
            <span class="summary-label summary-max">Massimo: ${Math.max(...d.hourly_winds)} km/h</span>
            <span class="summary-label summary-min">Minimo: ${Math.min(...d.hourly_winds)} km/h</span>
          </div>
          <div class="box-summary-row2">
            <span class="summary-label summary-dir">Direzione max: ${windDirectionName(Math.max(...d.hourly_wind_directions))}</span>
          </div>
        </div>`;
      windChart?.destroy();
      windChart=new Chart(document.getElementById('windchart'),{
        type:'line',
        data:{labels:d.hourly_labels,datasets:[{data:d.hourly_winds,borderColor:'#66E5FF',backgroundColor:'rgba(90,184,255,0.12)',fill:true,tension:0.21,pointRadius:4,pointHoverRadius:7,pointBackgroundColor:'#66E5FF',pointBorderColor:'#fff',pointBorderWidth:2}]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{enabled:true,backgroundColor:'rgba(0,0,0,0.8)',padding:12,titleFont:{size:14,weight:'bold'},bodyFont:{size:13},borderColor:'#66E5FF',borderWidth:2}},scales:{y:{beginAtZero:true},x:{}}}
      });
    }

    function renderRain(){
      const d=DATA.days[selectedDayIndex];
      const maxH=Math.max(...d.hourly_precips);
      const hMax=d.hourly_labels[d.hourly_precips.indexOf(maxH)];
      document.getElementById('rainbox').innerHTML=`
        <div class="box-title">üåßÔ∏è Pioggia</div>
        <div class="main">Totale oggi: <b>${d.precipitation.toFixed(1)} mm</b> ${rainIcon(d.precipitation)}</div>
        <div class="desc"><b>Max oraria:</b> ${maxH.toFixed(1)} mm &nbsp;<b>Ora:</b> ${hMax}</div>
        <button class="detail-btn" onclick="toggleDetail('rain-detail')">Dettagli / Grafico</button>
        <div id="rain-detail" class="detail-section"><div class="chart-wrap"><canvas id="rainchart"></canvas></div></div>
        <div class="box-summary"><div class="box-summary-row">
          <span class="summary-label summary-max">Max oraria: ${maxH.toFixed(1)} mm</span>
          <span class="summary-label summary-hour">Ora: ${hMax}</span>
        </div></div>`;
      rainChart?.destroy();
      rainChart=new Chart(document.getElementById('rainchart'),{
        type:'bar',
        data:{labels:d.hourly_labels,datasets:[{data:d.hourly_precips,backgroundColor:'#52c5f7',borderColor:'#52afe7',borderWidth:2,hoverBackgroundColor:'#6ed5ff',hoverBorderColor:'#52afe7',hoverBorderWidth:3}]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{enabled:true,backgroundColor:'rgba(0,0,0,0.8)',padding:12,titleFont:{size:14,weight:'bold'},bodyFont:{size:13},borderColor:'#52c5f7',borderWidth:2}},scales:{y:{beginAtZero:true},x:{}}}
      });
    }

    function renderSea(){
      const merged=DATA.sea[selectedDayIndex];
      const mean=calculateMean(merged.map(h=>h.wave_height));
      const range=calculateRange(merged.map(h=>h.wave_height));
      const std=calculateStdDev(merged.map(h=>h.wave_height));
      const temp=calculateMean(merged.map(h=>h.sea_surface_temperature));
      document.getElementById('seabox').innerHTML=`
        <div class="box-title">üåä Mare</div>
        <div class="main">Altezza media onda: <b>${mean.toFixed(2)} m</b></div>
        <div class="desc">Temp. mare: <b>${temp.toFixed(1)} ¬∞C</b></div>
        <button class="detail-btn" onclick="toggleDetail('sea-detail')">Dettagli / Grafico</button>
        <div id="sea-detail" class="detail-section"><div class="chart-wrap"><canvas id="seachart"></canvas></div></div>
        <div class="box-summary"><div class="box-summary-row">
          <span class="summary-label summary-mean">Hsig: ${mean.toFixed(2)} m</span>
          <span class="summary-label summary-range">Range: ${range.toFixed(2)} m</span>
          <span class="summary-label summary-std">Dev.Std.: ${std.toFixed(2)} m</span>
        </div></div>`;
      seaChart?.destroy();
      seaChart=new Chart(document.getElementById('seachart'),{
        type:'line',
        data:{labels:merged.map(h=>h.time),datasets:[
          {data:merged.map(h=>h.wave_height),label:'Onda (m)',borderColor:'#41f8bd',backgroundColor:'rgba(34,255,170,0.10)',fill:true,tension:0.22,pointRadius:4,pointHoverRadius:7,pointBackgroundColor:'#25A9FA',pointBorderColor:'#fff',pointBorderWidth:2},
          {data:merged.map(h=>h.swell_height),label:'Swell (m)',borderColor:'#21D08A',backgroundColor:'rgba(34,255,170,0.06)',fill:true,tension:0.18,pointRadius:4,pointHoverRadius:7,pointBackgroundColor:'#21D08A',pointBorderColor:'#fff',pointBorderWidth:2}
        ]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true},tooltip:{enabled:true,backgroundColor:'rgba(0,0,0,0.8)',padding:12,titleFont:{size:14,weight:'bold'},bodyFont:{size:13},borderColor:'#41f8bd',borderWidth:2}},scales:{y:{beginAtZero:true},x:{}}}
      });
    }

    function renderPress(){
      const d=DATA.days[selectedDayIndex];
      const arr=d.hourly_pressures; const mean=calculateMean(arr);
      document.getElementById('pressbox').innerHTML=`
        <div class="box-title">üîΩ Pressione</div>
        <div class="main">Media: <b>${mean.toFixed(1)} hPa</b></div>
        <div class="desc">Tendenza: ${pressureTrend(arr)}</div>
        <button class="detail-btn" onclick="toggleDetail('press-detail')">Dettagli / Grafico</button>
        <div id="press-detail" class="detail-section"><div class="chart-wrap"><canvas id="presschart"></canvas></div></div>
        <div class="box-summary"><div class="box-summary-row">
          <span class="summary-label summary-max">Max: ${Math.max(...arr).toFixed(1)} hPa</span>
          <span class="summary-label summary-min">Min: ${Math.min(...arr).toFixed(1)} hPa</span>
        </div></div>`;
      pressChart?.destroy();
      pressChart=new Chart(document.getElementById('presschart'),{
        type:'line',
        data:{labels:d.hourly_labels,datasets:[{data:arr,label:'Pressione (hPa)',borderColor:'#ffd472',backgroundColor:'rgba(255,240,51,0.10)',fill:true,tension:0.22,pointRadius:4,pointHoverRadius:7,pointBackgroundColor:'#ffd472',pointBorderColor:'#fff',pointBorderWidth:2}]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{enabled:true,backgroundColor:'rgba(0,0,0,0.8)',padding:12,titleFont:{size:14,weight:'bold'},bodyFont:{size:13},borderColor:'#ffd472',borderWidth:2}},scales:{y:{beginAtZero:false},x:{}}}
      });
    }

    function renderFooter(){
      document.getElementById('footer').innerHTML=
        `Powered by Open-Meteo ‚Ä¢ UI by micheledv74 ‚Ä¢ Ultimo agg.: <span id="updated_stamp">${DATA.updated_at}</span>`;
    }

    function renderAll(){
      if(!DATA.days.length) return;
      renderWind(); renderRain(); renderSea(); renderPress(); renderMiniDays(); renderFooter();
    }

    renderAll();
  </script>
</body>
</html>
