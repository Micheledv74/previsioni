<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Meteo Procida</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#012549">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <meta name="description" content="Previsioni meteo dettagliate per Procida - Analisi AI multi-fonte">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Meteo Procida">
  <link rel="icon" type="image/png" href="apple-touch-icon.png">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: linear-gradient(135deg, #012549, #003d6b);
      color: white; margin: 0; padding: 0;
    }
    .container {
      max-width: 850px;
      margin: 40px auto;
      background: rgba(0,0,20,0.16);
      border-radius: 18px;
      box-shadow: 0 12px 32px #02153844;
      padding: 36px 28px 30px 28px;
    }
    h1 { font-size: 2.2em; margin-bottom: 10px; }
    .meta { margin-bottom: 12px; font-size: 1.09em; opacity: .77; }
    .grid-cards-days { display: flex; gap: 15px; flex-wrap: wrap; }
    .card-day {
      background: #003d69e8;
      border-radius: 13px;
      padding: 20px 14px 12px 14px;
      min-width: 205px;
      flex: 1 1 230px;
      margin-bottom: 18px;
      box-shadow: 0 2px 14px #01254933;
    }
    .card-day h3 { margin:0 0 10px 0; font-size:1.18em;font-weight:400;}
    .card-day .icon {font-size: 2.3em;}
    .card-day .temp {font-size: 1.7em; font-weight:600;}
    .badged {display:inline-block;padding:3px 10px;border-radius:7px;background:#084480;color:#fff;font-size:.89em;}
    .row-details {
      display: flex;
      gap: 16px;
      margin-top: 8px;
    }
    .advice, .alerts { margin:7px 0 0 22px; font-size:1em; }
    .advice li, .alerts li { margin-bottom: 3px; }
    .main-day {
      display: flex; align-items: center;
      gap: 18px;
      background: #012549;
      border-radius:11px;
      padding: 20px;
      margin-bottom:18px;
    }
    .main-day .icon {font-size:2.6em;}
    .main-day .temp {font-size:3em;font-weight:700;}
    .section {margin-bottom:17px;}
    .section-title {font-size:1.13em;font-weight:600;margin-bottom:10px;}
    .footnote {font-size:.94em;opacity:.67;margin-top:19px;}
    .chart-section {margin:30px 0; background:#01284966;padding:23px;border-radius:13px;}
    .card-aq { background:#083e4c;padding:13px 18px 8px 18px;border-radius:10px;font-size:1.02em;margin:12px 0 18px 0;}
    .aqi {font-size: 1.09em;font-weight:500;}
    .stat {padding:3px 9px;border-radius:7px;background:#042345;font-size:.98em;}
    .label {font-size:.95em;opacity:.6;margin-bottom:2px;}
    /* icone meteo */
    .icon-cloud {display: inline-block; width:28px; height:28px; background: url('https://raw.githubusercontent.com/Micheledv74/previsioni/main/cloud.svg') no-repeat center center / contain;}
    .icon-rain {display: inline-block; width:28px; height:28px; background: url('https://raw.githubusercontent.com/Micheledv74/previsioni/main/rain.svg') no-repeat center center / contain;}
    .icon-sun {display: inline-block; width:28px; height:28px; background: url('https://raw.githubusercontent.com/Micheledv74/previsioni/main/sun.svg') no-repeat center center / contain;}
    .icon-wave {display: inline-block; width:28px; height:28px; background: url('https://raw.githubusercontent.com/Micheledv74/previsioni/main/wave.svg') no-repeat center center / contain;}
  </style>
</head>
<body>
  <div class="container">
    <h1>Meteo Procida ⛅</h1>
    <div id="meta-main"></div>
    <div class="main-day" id="main-day"></div>
    <div class="section">
      <div class="section-title">Consigli per la giornata</div>
      <ul class="advice" id="advice-list"></ul>
    </div>
    <div class="section">
      <div class="section-title">Allerte</div>
      <ul class="alerts" id="alerts-list"></ul>
    </div>
    <div class="footnote" id="foot-stat"></div>
    <div class="chart-section">
      <div class="section-title">Temperature & Precipitazioni - 7 Giorni</div>
      <canvas id="chart-temp"></canvas>
    </div>
    <div class="chart-section">
      <div class="section-title">Pressione Atmosferica & Vento</div>
      <canvas id="chart-pressure"></canvas>
    </div>
    <div class="chart-section">
      <div class="section-title">Condizioni Meteomarine - 7 Giorni</div>
      <canvas id="chart-marine"></canvas>
    </div>
    <div class="section">
      <div class="section-title">Previsioni dettagliate prossimi giorni</div>
      <div class="grid-cards-days" id="cards-days"></div>
    </div>
    <div class="card-aq" id="aqinfo"></div>
  </div>
  <script>
    // === DATI METEO RAW (TUO JSON ORIGINALE AGGIORNATO) ===
    window.WEATHERDATA_RAW = `[{"location":{"name":"Procida","latitude":40.7584,"longitude":14.0166},"generated_at":"2025-10-23T11:58:34.891Z","days":[{"date":"2025-10-23", ...}, {... altre giornate ...}],"weekStats":{"maxTemp":22,"minTemp":17,"avgTemp":20,"rainyDays":4},"source":"openweathermap_airquality","timestamp":"2025-10-23T11:58:34.778Z","air_quality":{"aqi":2,"aqi_description":"Discreta","timestamp":"2025-10-23T11:58:34.000Z","components":{"co":101.04,"no":0.03,"no2":0.31,"o3":77.2,"so2":0.4,"pm2_5":3.59,"pm10":14.42,"nh3":0.13},"assessment":{"pm2_5_level":"Ottimo","pm10_level":"Ottimo","o3_level":"Buono","no2_level":"Ottimo"}}}]`;

    let dataArr = [];
    try { dataArr = JSON.parse(window.WEATHERDATA_RAW); } catch(e){ }
    let data = dataArr[0] || {};

    // === METADATA, HEADER ===
    const metaMain = document.getElementById("meta-main");
    metaMain.innerHTML = `
      <div class="meta">Ultimo aggiornamento: ${new Date(data.generated_at).toLocaleString('it-IT')}</div>
      <div class="meta">Forecast da fonti: ${data.source || "-"}<br>
      Coordinate: ${data.location?.latitude || ""}, ${data.location?.longitude || ""}</div>
    `;

    // === MAIN DAY CARD ===
    function meteoIcon(today) {
      if (today.rain?.total_mm > 20) return "<span class='icon-rain'></span>";
      if (today.rain?.total_mm > 5) return "<span class='icon-cloud'></span>";
      if (today.sea?.wave_height_m > 2) return "<span class='icon-wave'></span>";
      return "<span class='icon-sun'></span>";
    }
    const today = (data.days && data.days.length) ? data.days[0] : {};

    document.getElementById("main-day").innerHTML = `
      <div class="icon">${meteoIcon(today)}</div>
      <div class="temp">${today.temp ? today.temp.max+"°" : ""}</div>
      <div>
        <div>${today.summary || ""}</div>
        <div>Umidità: ${today.humidity || ""}%</div>
        <div>Pressione: ${today.pressure?.value_hPa || ""} hPa (${today.pressure?.trend || ""})</div>
        <div>Vento max: ${today.wind && today.wind.periods ? Math.max(...today.wind.periods.map(x=>x.speed_kmh))+'km/h' : ''}</div>
        <div>Alba: ${today.sunrise || ""} - Tramonto: ${today.sunset || ""}</div>
        <div>Mare: ${today.sea?.condition || ""} (${today.sea?.wave_height_m||""}m)</div>
      </div>
    `;

    // === CONSIGLI & ALLERTE ===
    const adviceList = today.advice ? today.advice.map(a=>'<li>'+a+'</li>').join('') : '<li>Nessun consiglio</li>';
    document.getElementById("advice-list").innerHTML = adviceList;

    const alertsList = today.alerts ? today.alerts.map(a=>'<li>'+a+'</li>').join('') : '<li>Nessuna allerta</li>';
    document.getElementById("alerts-list").innerHTML = alertsList;

    // === STATISTICHE SETTIMANA ===
    document.getElementById("foot-stat").innerHTML =
      `Statistiche settimanali: Massima ${data.weekStats?.maxTemp||""}°C, 
      Minima ${data.weekStats?.minTemp||""}°C, 
      ${data.weekStats?.rainyDays||""} giorni di pioggia`;

    // === QUALITA' DELL'ARIA ===
    let aq = data.air_quality || {};
    document.getElementById("aqinfo").innerHTML = `
      <strong>Indice qualità aria:</strong>
      <div class="aqi">AQI: ${aq.aqi || ""} / ${aq.aqi_description || ""}</div>
      <div>PM2.5: ${aq.components?.pm2_5||""} μg/m³ - Livello: ${aq.assessment?.pm2_5_level||""}</div>
      <div>PM10: ${aq.components?.pm10||""} μg/m³ - Livello: ${aq.assessment?.pm10_level||""}</div>
    `;
    // === RENDER CARD PER CIASCUN GIORNO ===
    const days = (data.days || []);
    const cardsContainer = document.getElementById("cards-days");
    let cardsHTML = "";
    days.forEach(day => {
      cardsHTML += `
        <div class="card-day">
          <h3>${day.date}</h3>
          <div class="icon">${meteoIcon(day)}</div>
          <div class="temp">${day.temp ? day.temp.max+"°" : ""}</div>
          <div class="label">Min: ${day.temp?.min||""}°</div>
          <div class="badged">Umi: ${day.humidity||""}%</div>
          <div class="badged">Press: ${day.pressure?.value_hPa||""} hPa</div>
          <div class="badged">Vento: ${day.wind && day.wind.periods ? Math.max(...day.wind.periods.map(x=>x.speed_kmh))+'km/h' : ""}</div>
          <div class="badged">Mare: ${day.sea?.condition||""} (${day.sea?.wave_height_m||""}m)</div>
          <div class="label">Alba: ${day.sunrise||""} - Tramonto: ${day.sunset||""}</div>
          <div style="margin-top:7px;color:#ffe;">${day.summary||""}</div>
          <div style="font-size:.96em;color:#9cf;">
            Allerte: ${day.alerts && day.alerts.length ? day.alerts.join("<br>") : "Nessuna"}
          </div>
        </div>
      `;
    });
    cardsContainer.innerHTML = cardsHTML;

    // === CHART TEMP & PRECIPITAZIONI 7 GIORNI ===
    const ctxTemp = document.getElementById('chart-temp').getContext('2d');
    new Chart(ctxTemp, {
      type: 'line',
      data: {
        labels: days.map(d=>d.date),
        datasets: [
          {
            label: "Temp Max (°C)",
            data: days.map(d=>d.temp?.max||0),
            borderColor: "#ffc300",
            backgroundColor: "rgba(255,195,0,0.2)",
            tension: 0.2,
            fill: false
          },
          {
            label: "Temp Min (°C)",
            data: days.map(d=>d.temp?.min||0),
            borderColor: "#279cf0",
            backgroundColor: "rgba(39,156,240,0.18)",
            tension: 0.18,
            fill: false
          },
          {
            label: "Pioggia (mm)",
            data: days.map(d=>d.rain?.total_mm||0),
            borderColor: "#5beaff",
            backgroundColor: "rgba(91,234,255,0.18)",
            type: 'bar',
            fill: true,
            yAxisID: 'y-rain'
          }
        ]
      },
      options: {
        responsive: true,
        scales: { 
          y: { beginAtZero:true, title:{display:true,text:'Temp(°C)'} },
          "y-rain": { position: "right", beginAtZero:true, title:{display:true,text:"Pioggia(mm)"}, grid:{drawOnChartArea:false} }
        }
      }
    });

    // === CHART PRESSIONE & VENTO ===
    const ctxPressure = document.getElementById('chart-pressure').getContext('2d');
    new Chart(ctxPressure, {
      type: 'line',
      data: {
        labels: days.map(d=>d.date),
        datasets: [
          {
            label: "Pressione (hPa)",
            data: days.map(d=>d.pressure?.value_hPa||0),
            borderColor: "#77ff83",
            backgroundColor: "rgba(119,255,131,0.18)",
            tension: 0.25,
            fill: false
          },
          {
            label: "Vento max (km/h)",
            data: days.map(d=>d.wind && d.wind.periods ? Math.max(...d.wind.periods.map(x=>x.speed_kmh)) : 0),
            borderColor: "#03f1fe",
            backgroundColor: "rgba(3,241,254,0.17)",
            tension: 0.21,
            fill: false,
            yAxisID: 'y-wind'
          }
        ]
      },
      options: {
        responsive: true,
        scales: { 
          y: { beginAtZero:true, title:{display:true,text:'Pressione(hPa)'} },
          "y-wind": { position: "right", beginAtZero:true, title:{display:true,text:"Vento max(km/h)"}, grid:{drawOnChartArea:false} }
        }
      }
    });

    // === CHART METEOMARINE ===
    const ctxMarine = document.getElementById('chart-marine').getContext('2d');
    new Chart(ctxMarine, {
      type: 'line',
      data: {
        labels: days.map(d=>d.date),
        datasets: [
          {
            label: "Altezza Onde (m)",
            data: days.map(d=>d.sea?.wave_height_m||0),
            borderColor: "#93caff",
            backgroundColor: "rgba(147,202,255,0.16)",
            tension: 0.22,
            fill: true
          },
          {
            label: "Temp Mare (°C)",
            data: days.map(d=>d.sea?.temperature_c||0),
            borderColor: "#fad689",
            backgroundColor: "rgba(250,214,137,0.13)",
            tension: 0.18,
            fill: true,
            yAxisID: 'y-temp'
          }
        ]
      },
      options: {
        responsive: true,
        scales: { 
          y: { beginAtZero:true, title:{display:true,text:'Altezza Onde (m)'} },
          "y-temp": { position: "right", beginAtZero:true, title:{display:true,text:"Temp Mare(°C)"}, grid:{drawOnChartArea:false} }
        }
      }
    });
    // --- FINE RENDER & LOGICA ---
  </script>
</body>
</html>
