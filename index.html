<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#012549">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" href="apple-touch-icon.png">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
  <meta name="description" content="Previsioni meteo dettagliate per Procida - Analisi AI multi-fonte">
  
  <!-- PWA Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Meteo Procida">
  
  <!-- Icons per PWA -->
  <link rel="icon" type="image/png" href="apple-touch-icon.png">
<link rel="apple-touch-icon" href="apple-touch-icon.png">

  
  <title>Meteo Procida - Previsioni 7 Giorni</title>
  
  <!-- Weather Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/weather-icons/2.0.12/css/weather-icons.min.css">
  
  <!-- Chart.js Library -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      /* === COLORI DAL LOGO METEO PROCIDA === */
      --primary-blue: #012549;
      --primary-blue-light: #003d6b;
      --accent-orange: #faa202;
      --accent-cyan: #08a5e8;
      
      /* Gradazioni */
      --bg-gradient-start: #012549;
      --bg-gradient-end: #003d6b;
      --card-bg: rgba(255, 255, 255, 0.1);
      --card-border: rgba(255, 255, 255, 0.2);
      
      /* Testo */
      --text-primary: #ffffff;
      --text-secondary: #a0c4d8;
      --text-tertiary: #6a8da8;
      
      /* Accenti semantici */
      --accent-green: #34c759;
      --accent-red: #ff3b30;
      --accent-yellow: #ffcc00;
      
      /* Spacing */
      --spacing-xs: 8px;
      --spacing-sm: 12px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 0;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: var(--spacing-md);
    }

    /* === NOTIFICATION TOGGLE === */
    .notification-toggle {
      position: fixed;
      bottom: var(--spacing-lg);
      right: var(--spacing-lg);
      background: linear-gradient(135deg, var(--accent-cyan) 0%, #0077cc 100%);
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 16px rgba(8, 165, 232, 0.4);
      cursor: pointer;
      z-index: 999;
      transition: all 0.3s ease;
      font-size: 1.5rem;
    }

    .notification-toggle:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(8, 165, 232, 0.6);
    }

    .notification-toggle.active {
      background: linear-gradient(135deg, var(--accent-green) 0%, #2ea043 100%);
      animation: pulse 2s infinite;
    }

    /* === HEADER === */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-lg);
      padding: var(--spacing-md);
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      border: 1px solid var(--card-border);
      animation: fadeInUp 0.6s ease-out;
    }

    .header-logo {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .logo-icon {
      font-size: 2.5rem;
    }

    .header-title h1 {
      font-size: 1.8rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--accent-orange) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header-subtitle {
      font-size: 0.9rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .header-actions {
      display: flex;
      gap: var(--spacing-sm);
    }

    .action-button {
      background: linear-gradient(135deg, var(--accent-orange) 0%, #ff8800 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(250, 162, 2, 0.3);
    }

    .action-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(250, 162, 2, 0.5);
    }

    .action-button.secondary {
      background: linear-gradient(135deg, var(--accent-cyan) 0%, #0077cc 100%);
      box-shadow: 0 4px 12px rgba(8, 165, 232, 0.3);
    }

    .action-button.secondary:hover {
      box-shadow: 0 6px 20px rgba(8, 165, 232, 0.5);
    }

    /* === ANIMATIONS === */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideInLeft {
      from { opacity: 0; transform: translateX(-30px); }
      to { opacity: 1; transform: translateX(0); }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }

    /* === HERO CARD === */
    .hero-card {
      background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);
      border-radius: 24px;
      padding: var(--spacing-xl);
      margin-bottom: var(--spacing-lg);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
      position: relative;
      overflow: hidden;
      min-height: 50vh;
      animation: fadeInUp 0.8s ease-out;
      border: 1px solid rgba(8, 165, 232, 0.2);
    }

    .hero-card.hot { background: linear-gradient(135deg, #ff6b6b 0%, var(--accent-orange) 100%); }
    .hero-card.warm { background: linear-gradient(135deg, var(--accent-orange) 0%, #ff6348 100%); }
    .hero-card.mild { background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%); }
    .hero-card.cool { background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--primary-blue-light) 100%); }
    .hero-card.cold { background: linear-gradient(135deg, #a8edea 0%, var(--accent-cyan) 100%); }

    .hero-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-lg);
    }

    .hero-location {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      font-size: 1.1rem;
      font-weight: 500;
      opacity: 0.9;
    }

    .hero-date {
      font-size: 0.95rem;
      opacity: 0.8;
    }

    .hero-main {
      text-align: center;
      margin: var(--spacing-xl) 0;
    }

    .hero-temp {
      font-size: 80px;
      font-weight: 700;
      line-height: 1;
      margin-bottom: var(--spacing-sm);
      text-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      animation: fadeIn 1s ease-out;
    }

    .hero-condition {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-sm);
      font-size: 1.5rem;
      font-weight: 500;
      margin-bottom: var(--spacing-md);
    }

    .hero-condition i {
      font-size: 3rem;
      animation: fadeIn 1.2s ease-out;
    }

    .hero-minmax {
      display: flex;
      justify-content: center;
      gap: var(--spacing-lg);
      font-size: 1.2rem;
      margin-bottom: var(--spacing-lg);
    }

    .hero-minmax span {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      transition: transform 0.3s ease;
    }

    .hero-minmax span:hover {
      transform: translateY(-2px);
    }

    .hero-summary {
      background: rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: var(--spacing-md);
      font-size: 1.05rem;
      line-height: 1.6;
      margin-bottom: var(--spacing-md);
      animation: slideInLeft 0.8s ease-out;
    }

    /* === AQI WIDGET === */
    .aqi-widget {
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-md);
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      animation: slideInLeft 0.9s ease-out;
    }

    .aqi-icon {
      font-size: 3rem;
      opacity: 0.9;
    }

    .aqi-content {
      flex: 1;
    }

    .aqi-title {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.8;
      margin-bottom: 4px;
    }

    .aqi-value {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .aqi-level {
      font-size: 0.95rem;
      font-weight: 500;
    }

    .aqi-good { border-left: 4px solid var(--accent-green); color: var(--accent-green); }
    .aqi-moderate { border-left: 4px solid var(--accent-yellow); color: var(--accent-yellow); }
    .aqi-unhealthy-sensitive { border-left: 4px solid var(--accent-orange); color: var(--accent-orange); }
    .aqi-unhealthy { border-left: 4px solid var(--accent-red); color: var(--accent-red); }

    /* === ADVICE PILLS === */
    .advice-pills {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-xs);
      margin-bottom: var(--spacing-md);
    }

    .advice-pill {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: var(--spacing-xs) var(--spacing-md);
      font-size: 0.9rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .advice-pill:hover {
      background: rgba(255, 255, 255, 0.35);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    /* === DETAILS PILLS === */
    .details-pills {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: var(--spacing-sm);
    }

    .detail-pill {
      background: rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: var(--spacing-sm);
      text-align: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .detail-pill:hover {
      background: rgba(0, 0, 0, 0.3);
      transform: translateY(-4px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    .detail-pill i {
      font-size: 1.8rem;
      display: block;
      margin-bottom: 4px;
      opacity: 0.9;
      transition: transform 0.3s ease;
    }

    .detail-pill:hover i {
      transform: scale(1.1);
    }

    .detail-pill .value {
      font-size: 1.1rem;
      font-weight: 600;
      display: block;
      margin-bottom: 2px;
    }

    .detail-pill .label {
      font-size: 0.75rem;
      opacity: 0.8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .detail-pill.rain-detail i { color: var(--accent-cyan); }
    .detail-pill.temp-detail i { color: var(--accent-orange); }

    /* === MOON PHASE === */
    .moon-phase-pill {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .moon-emoji {
      font-size: 2rem;
      display: block;
      margin-bottom: 4px;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    /* === WIND ROSE === */
    .wind-rose-container {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .wind-rose-svg {
      width: 100%;
      height: 100%;
      transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .detail-pill:hover .wind-rose-svg {
      transform: rotate(15deg);
    }

    /* === CHARTS CONTAINER === */
    .charts-section {
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
      animation: fadeInUp 0.6s ease-out;
      animation-delay: 0.3s;
      opacity: 0;
      animation-fill-mode: forwards;
    }

    .chart-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: var(--spacing-md);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      color: var(--accent-cyan);
    }

    .chart-canvas {
      max-height: 300px;
    }

    /* === STATS GRID === */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-lg);
    }

    .stat-card {
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: var(--spacing-md);
      text-align: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      opacity: 0;
      animation: fadeInUp 0.6s ease-out forwards;
    }

    .stat-card:nth-child(1) { animation-delay: 0.5s; }
    .stat-card:nth-child(2) { animation-delay: 0.6s; }
    .stat-card:nth-child(3) { animation-delay: 0.7s; }
    .stat-card:nth-child(4) { animation-delay: 0.8s; }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      background: rgba(255, 255, 255, 0.12);
    }

    .stat-card i {
      font-size: 2rem;
      margin-bottom: var(--spacing-xs);
      display: block;
      transition: transform 0.3s ease;
    }

    .stat-card:hover i {
      transform: scale(1.1) rotate(5deg);
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      margin: var(--spacing-xs) 0;
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    /* === SECTION TITLE === */
    .section-title {
      font-size: 1.3rem;
      font-weight: 600;
      margin: var(--spacing-xl) 0 var(--spacing-md) 0;
      padding-left: var(--spacing-xs);
      animation: slideInLeft 0.6s ease-out;
    }

    /* === DAY CARDS === */
    .days-grid {
      display: grid;
      gap: var(--spacing-md);
    }

    .day-card-compact {
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--card-border);
      border-radius: 20px;
      padding: var(--spacing-lg);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      opacity: 0;
      animation: fadeInUp 0.6s ease-out forwards;
    }

    .day-card-compact:nth-child(1) { animation-delay: 0.9s; }
    .day-card-compact:nth-child(2) { animation-delay: 1.0s; }
    .day-card-compact:nth-child(3) { animation-delay: 1.1s; }
    .day-card-compact:nth-child(4) { animation-delay: 1.2s; }
    .day-card-compact:nth-child(5) { animation-delay: 1.3s; }
    .day-card-compact:nth-child(6) { animation-delay: 1.4s; }

    .day-card-compact:hover {
      transform: translateY(-6px);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.4);
      background: rgba(255, 255, 255, 0.14);
      border-color: rgba(8, 165, 232, 0.4);
    }

    .day-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
    }

    .day-name {
      font-size: 1.2rem;
      font-weight: 600;
      transition: color 0.3s ease;
    }

    .day-card-compact:hover .day-name {
      color: var(--accent-cyan);
    }

    .day-temps-compact {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      font-size: 1.5rem;
    }

    .temp-max { 
      font-weight: 700; 
      color: var(--accent-orange);
      transition: transform 0.3s ease;
    }

    .day-card-compact:hover .temp-max {
      transform: scale(1.1);
    }

    .temp-min { 
      color: var(--text-secondary); 
    }

    .day-summary-short {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-md);
      line-height: 1.5;
    }

    .day-details-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: var(--spacing-sm);
      margin-top: var(--spacing-md);
    }

    .detail-compact {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      padding: var(--spacing-sm);
      text-align: center;
      font-size: 0.85rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .detail-compact:hover {
      background: rgba(0, 0, 0, 0.35);
      transform: translateY(-2px);
    }

    .detail-compact i {
      display: block;
      font-size: 1.3rem;
      margin-bottom: 4px;
      opacity: 0.8;
      transition: transform 0.3s ease;
    }

    .detail-compact:hover i {
      transform: scale(1.15);
    }

    .detail-compact .value {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .detail-compact .label {
      font-size: 0.75rem;
      opacity: 0.7;
    }

    /* === ALERTS === */
    .alerts {
      background: rgba(255, 59, 48, 0.15);
      border-left: 4px solid var(--accent-red);
      border-radius: 12px;
      padding: var(--spacing-md);
      margin: var(--spacing-md) 0;
      font-size: 0.9rem;
      animation: pulse 2s ease-in-out infinite;
    }

    .alerts strong {
      display: block;
      margin-bottom: var(--spacing-xs);
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    /* === FOOTER === */
    footer {
      text-align: center;
      margin-top: var(--spacing-xl);
      padding: var(--spacing-lg);
      color: var(--text-secondary);
      font-size: 0.85rem;
      opacity: 0;
      animation: fadeIn 1s ease-out forwards;
      animation-delay: 1.5s;
    }

    footer p {
      margin: 6px 0;
    }

    .error-message {
      background: rgba(255, 59, 48, 0.2);
      border: 1px solid var(--accent-red);
      border-radius: 20px;
      padding: var(--spacing-xl);
      text-align: center;
      margin: var(--spacing-lg) 0;
      animation: fadeInUp 0.6s ease-out;
    }

    /* === RESPONSIVE === */
    @media (max-width: 768px) {
      .container { padding: var(--spacing-sm); }
      header { flex-direction: column; gap: var(--spacing-md); }
      .header-actions { width: 100%; }
      .action-button { flex: 1; justify-content: center; }
      .hero-card { padding: var(--spacing-lg); min-height: 60vh; }
      .hero-temp { font-size: 72px; }
      .hero-condition { font-size: 1.3rem; }
      .hero-condition i { font-size: 2.5rem; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .details-pills { grid-template-columns: repeat(3, 1fr); }
      .day-details-row { grid-template-columns: repeat(2, 1fr); }
      .notification-toggle { bottom: 100px; }
    }

    @media (max-width: 390px) {
      .hero-temp { font-size: 64px; }
      .details-pills { grid-template-columns: repeat(2, 1fr); }
    }

    /* === PRINT STYLES === */
    @media print {
      body { background: white; color: black; }
      header .action-button, footer, .notification-toggle { display: none; }
      .hero-card, .day-card-compact { page-break-inside: avoid; border: 1px solid #ddd; }
      * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
  </style>
</head>
<body>
  <!-- Notification Toggle Button -->
  <div class="notification-toggle" id="notificationToggle" onclick="toggleNotifications()" title="Attiva notifiche meteo">
    🔔
  </div>

  <div class="container">
    <!-- HEADER -->
    <header>
      <div class="header-logo">
        <div class="logo-icon">🌊</div>
        <div>
          <h1>Meteo Procida</h1>
          <div class="header-subtitle">
            <i class="wi wi-day-sunny"></i>
            <span>Previsioni 7 giorni - Analisi AI</span>
          </div>
        </div>
      </div>
      <div class="header-actions">
        <button class="action-button secondary" onclick="shareWeather()">
          📤 Condividi
        </button>
        <button class="action-button" onclick="exportToPDF()">
          📥 PDF
        </button>
      </div>
    </header>

    <!-- HERO CARD -->
    <div id="hero-container"></div>

    <!-- CHARTS AVANZATI (Chart.js) -->
    <div class="charts-section">
      <div class="chart-title">
        <i class="wi wi-thermometer"></i>
        Temperature & Precipitazioni - 7 Giorni
      </div>
      <canvas id="weatherChart" class="chart-canvas"></canvas>
    </div>

    <div class="charts-section">
      <div class="chart-title">
        <i class="wi wi-barometer"></i>
        Pressione Atmosferica & Vento
      </div>
      <canvas id="pressureWindChart" class="chart-canvas"></canvas>
    </div>

    <!-- STATS -->
    <div id="stats-container"></div>

    <!-- GIORNI 2-7 -->
    <h2 class="section-title">📅 Prossimi 6 giorni</h2>
    <div id="forecast-container"></div>

    <footer>
      <p>Dati aggregati da Open-Meteo, Marine Open-Meteo, Weatherbit, Meteoblue e ilmeteo.it</p>
      <p>Analisi meteorologica professionale powered by AI</p>
      <p id="last-update"></p>
      <p style="margin-top: 10px; opacity: 0.6;">
        <span id="notification-status">Notifiche: Disattivate</span>
      </p>
    </footer>
  </div>

  <script>
    // === DATI METEO ===
    const weatherData = {"location":"Procida, Italia","generatedAt":"2024-07-20T10:00:00Z","totalDays":8,"weekStats":{"maxTemp":31,"minTemp":20,"avgTemp":"28.9","rainyDays":2},"days":[{"date":"2024-07-20","temp":{"min":20,"max":28,"feels_like":26},"rain":{"probability":60,"total_mm":4,"periods":[{"start":"17:00","end":"20:00","intensity":"leggera"}]},"wind":{"periods":[{"start":"00:00","end":"12:00","speed_kmh":12,"gusts_kmh":20,"direction":"SE","intensity":"leggero"},{"start":"12:00","end":"23:59","speed_kmh":25,"gusts_kmh":40,"direction":"SW","intensity":"moderato"}]},"pressure":{"value_hPa":1014,"trend":"in calo"},"sea":{"condition":"mosso","wave_height_m":1.2,"swell_direction":"Sud-Ovest"},"humidity":78,"uv_index":7,"sunrise":"05:45","sunset":"20:20","moon_phase":"Luna crescente","air_quality":{"aqi":150,"level":"Malsana per sensibili","pm25":30.5,"pm10":45.1,"no2":25,"o3":60},"summary":"La giornata odierna a Procida inizia con condizioni di bel tempo e temperature gradevoli, con venti leggeri da Sud-Est. Nel pomeriggio assisteremo a un aumento della nuvolosità e a un rinforzo dei venti da Sud-Ovest, che si faranno moderati con raffiche fino a 40 km/h. Si prevede l'arrivo di piogge leggere tra le 17:00 e le 20:00. Il mare, inizialmente poco mosso, tenderà a diventare mosso in serata, con onde che potranno raggiungere 1.2 metri. L'indice UV sarà alto a metà giornata. La qualità dell'aria è valutata come malsana per i gruppi sensibili, con valori elevati di PM2.5 e PM10.","advice":["Si consiglia di avere un ombrello a portata di mano per le piogge pomeridiane e di assicurare eventuali oggetti esposti al vento","Per le attività nautiche, attenzione all'aumento del moto ondoso e del vento da Sud-Ovest nel pomeriggio; si sconsigliano uscite in mare per piccole imbarcazioni.","Dato il livello di qualità dell'aria (malsana per sensibili), le persone con malattie respiratorie o cardiache dovrebbero limitare l'attività fisica intensa all'aperto."],"alerts":[]},{"date":"2024-07-21","temp":{"min":22,"max":25,"feels_like":23},"rain":{"probability":90,"total_mm":28,"periods":[{"start":"06:00","end":"14:00","intensity":"moderata"}]},"wind":{"periods":[{"start":"00:00","end":"16:00","speed_kmh":35,"gusts_kmh":55,"direction":"SW","intensity":"molto forte"},{"start":"16:00","end":"23:59","speed_kmh":25,"gusts_kmh":40,"direction":"O","intensity":"moderato"}]},"pressure":{"value_hPa":1009,"trend":"in risalita"},"sea":{"condition":"molto mosso","wave_height_m":2.2,"swell_direction":"Sud-Ovest"},"humidity":88,"uv_index":3,"sunrise":"05:46","sunset":"20:19","moon_phase":"Luna crescente","summary":"La giornata di domenica sarà caratterizzata da maltempo. Precipitazioni moderate interesseranno l'isola fin dalle prime ore del mattino e persisteranno fino al primo pomeriggio, con accumuli significativi. Il vento sarà il protagonista, soffiando molto forte da Sud-Ovest con raffiche che potranno superare i 50 km/h, per poi attenuarsi leggermente in serata e girare a Ovest. Il mare sarà molto mosso per gran parte della giornata, rendendo la navigazione estremamente pericolosa. Le temperature saranno in lieve calo rispetto a sabato.","advice":["Evitare qualsiasi attività all'aperto, in particolare quelle in prossimità del mare o in quota, a causa del forte vento e delle piogge.","Massima cautela alla guida e evitare spostamenti non essenziali. Verificare la tenuta di tendoni, teloni e oggetti sul balcone.","Le condizioni marine saranno proibitive: si sconsiglia categoricamente la navigazione e l'avvicinamento a coste esposte."],"alerts":["Allerta meteo per vento molto forte e mare molto mosso."]},{"date":"2024-07-22","temp":{"min":20,"max":29,"feels_like":27},"rain":{"probability":0,"total_mm":0,"periods":[]},"wind":{"periods":[{"start":"00:00","end":"08:00","speed_kmh":20,"gusts_kmh":30,"direction":"O","intensity":"moderato"},{"start":"08:00","end":"23:59","speed_kmh":10,"gusts_kmh":18,"direction":"NW","intensity":"leggero"}]},"pressure":{"value_hPa":1015,"trend":"in aumento"},"sea":{"condition":"poco mosso","wave_height_m":0.8,"swell_direction":"Nord-Ovest"},"humidity":68,"uv_index":8,"sunrise":"05:47","sunset":"20:19","moon_phase":"Primo quarto","summary":"Dopo il maltempo di domenica, il lunedì vedrà un deciso miglioramento delle condizioni meteo. Il cielo sarà sereno o poco nuvoloso per tutta la giornata, con temperature in sensibile rialzo, raggiungendo i 29°C nel pomeriggio. I venti, seppur ancora moderati da Ovest nelle prime ore, tenderanno a diminuire e a ruotare da Nord-Ovest, diventando leggeri. Il mare, pur restando inizialmente poco mosso, tenderà a calmarsi gradualmente. L'indice UV sarà elevato, indicando una forte irradiazione solare.","advice":["Godetevi la giornata di sole, ma non dimenticate la protezione solare ad alto fattore e cappelli, specialmente nelle ore centrali.","Le condizioni marine miglioreranno rendendo più favorevoli le attività in mare, ma si raccomanda comunque prudenza.","Mantenere una buona idratazione bevendo molta acqua, soprattutto durante le ore più calde."],"alerts":[]},{"date":"2024-07-23","temp":{"min":21,"max":30,"feels_like":28},"rain":{"probability":0,"total_mm":0,"periods":[]},"wind":{"periods":[{"start":"00:00","end":"23:59","speed_kmh":8,"gusts_kmh":15,"direction":"N","intensity":"leggero"}]},"pressure":{"value_hPa":1016,"trend":"stabile"},"sea":{"condition":"calmo","wave_height_m":0.3,"swell_direction":"Nord"},"humidity":60,"uv_index":9,"sunrise":"05:48","sunset":"20:18","moon_phase":"Primo quarto","summary":"Martedì si preannuncia una giornata estiva tipica di Procida, con cielo limpido e sole splendente. Le temperature massime toccheranno i 30°C, con una sensazione di caldo accentuata dalla quasi totale assenza di vento, che spirerà molto debolmente da Nord. La pressione atmosferica rimarrà stabile su valori elevati, garantendo stabilità. Il mare sarà calmo, ideale per la balneazione e le attività acquatiche. L'indice UV raggiungerà il suo picco, richiedendo massima attenzione all'esposizione solare.","advice":["Si raccomanda di usare creme solari con SPF alto, occhiali da sole e cappelli, evitando l'esposizione diretta al sole nelle ore centrali della giornata.","Le condizioni marine sono perfette per nuotare e fare snorkeling; godetevi la giornata in spiaggia o in barca.","Mantenere un'adeguata idratazione è fondamentale, bere molta acqua e consumare frutta e verdura fresca."],"alerts":[]},{"date":"2024-07-24","temp":{"min":22,"max":31,"feels_like":29},"rain":{"probability":0,"total_mm":0,"periods":[]},"wind":{"periods":[{"start":"00:00","end":"23:59","speed_kmh":10,"gusts_kmh":18,"direction":"NW","intensity":"leggero"}]},"pressure":{"value_hPa":1015,"trend":"stabile"},"sea":{"condition":"calmo","wave_height_m":0.4,"swell_direction":"Nord-Ovest"},"humidity":58,"uv_index":9,"sunrise":"05:49","sunset":"20:17","moon_phase":"Primo quarto","summary":"Anche mercoledì l'estate sarà protagonista a Procida, con un'ulteriore lieve aumento delle temperature massime che potranno toccare i 31°C. Il cielo si manterrà sereno o poco nuvoloso per l'intera giornata. Il vento sarà leggero, spirando da Nord-Ovest, contribuendo a mantenere le condizioni di calma sul mare. La pressione atmosferica sarà stabile. L'indice UV rimarrà molto alto, quindi la protezione solare sarà indispensabile. Le condizioni marine saranno ottimali, invitando a godere delle acque cristalline dell'isola.","advice":["Protezione solare e idratazione restano le priorità per affrontare le alte temperature e l'elevato indice UV.","Le condizioni di mare calmo sono perfette per escursioni in barca o per chi pratica sport acquatici leggeri.","Evitare attività fisiche intense all'aperto nelle ore di punta del calore."],"alerts":[]},{"date":"2024-07-25","temp":{"min":23,"max":30,"feels_like":28.5},"rain":{"probability":20,"total_mm":0.5,"periods":[]},"wind":{"periods":[{"start":"00:00","end":"23:59","speed_kmh":15,"gusts_kmh":25,"direction":"SW","intensity":"leggero"}]},"pressure":{"value_hPa":1013,"trend":"in calo"},"sea":{"condition":"poco mosso","wave_height_m":0.7,"swell_direction":"Sud-Ovest"},"humidity":72,"uv_index":8,"sunrise":"05:50","sunset":"20:16","moon_phase":"Gibbosa crescente","summary":"Giovedì vedrà un leggero cambiamento nel tempo, con un aumento dell'umidità e della nuvolosità, seppur parziale. Le temperature si manterranno alte, intorno ai 30°C. C'è una debole probabilità di isolate e brevissime piogge nel pomeriggio, con accumuli minimi. Il vento, leggero da Sud-Ovest, contribuirà a rendere il mare poco mosso. La pressione atmosferica inizierà a scendere lentamente. L'indice UV rimarrà elevato, sebbene leggermente inferiore rispetto ai giorni precedenti.","advice":["Nonostante la lieve probabilità di pioggia, l'ombrello non sarà strettamente necessario, ma è consigliabile rimanere aggiornati.","Le condizioni marine restano buone per la maggior parte delle attività acquatiche, ma si consiglia attenzione a eventuali leggere correnti dovute al vento da Sud-Ovest.","Attenzione al caldo umido che potrebbe aumentare la percezione del disagio, specialmente per gli anziani e i bambini."],"alerts":[]},{"date":"2024-07-26","temp":{"min":22,"max":29,"feels_like":27},"rain":{"probability":0,"total_mm":0,"periods":[]},"wind":{"periods":[{"start":"00:00","end":"23:59","speed_kmh":12,"gusts_kmh":20,"direction":"O","intensity":"leggero"}]},"pressure":{"value_hPa":1014,"trend":"in risalita"},"sea":{"condition":"poco mosso","wave_height_m":0.6,"swell_direction":"Ovest"},"humidity":68,"uv_index":8,"sunrise":"05:51","sunset":"20:15","moon_phase":"Gibbosa crescente","summary":"Il venerdì segnerà un ritorno a condizioni di tempo più stabile e soleggiato, con ampi spazi di cielo sereno. Le temperature si manterranno su valori estivi, con massime intorno ai 29°C. Il vento sarà leggero, spirando da Ovest, e contribuirà a rendere la giornata piacevole. La pressione atmosferica tornerà a salire leggermente. Il mare sarà poco mosso, con condizioni favorevoli per godere delle spiagge e delle attività in acqua. L'indice UV sarà ancora elevato.","advice":["Un'altra ottima giornata per il mare: si raccomandano le consuete precauzioni contro il sole intenso.","Ideale per passeggiate all'aria aperta e per godere dei paesaggi dell'isola senza l'eccessivo calore dei giorni precedenti.","Verificare gli orari dei traghetti o aliscafi, in quanto le condizioni marine favorevoli potrebbero rendere i viaggi più confortevoli."],"alerts":[]},{"date":"2024-07-27","temp":{"min":22,"max":29,"feels_like":27.5},"rain":{"probability":0,"total_mm":0,"periods":[]},"wind":{"periods":[{"start":"00:00","end":"23:59","speed_kmh":10,"gusts_kmh":18,"direction":"NW","intensity":"leggero"}]},"pressure":{"value_hPa":1015,"trend":"stabile"},"sea":{"condition":"poco mosso","wave_height_m":0.5,"swell_direction":"Nord-Ovest"},"humidity":65,"uv_index":8,"sunrise":"05:52","sunset":"20:14","moon_phase":"Gibbosa crescente","summary":"Il weekend inizia con un sabato all'insegna del bel tempo e del sole su Procida. Le temperature massime si manterranno intorno ai 29°C, garantendo una giornata piacevole. Il vento sarà leggero, spirando prevalentemente da Nord-Ovest, senza creare particolari disagi. La pressione atmosferica si manterrà stabile. Il mare sarà poco mosso, con condizioni ideali per tutte le attività balneari e nautiche. L'indice UV si manterrà su valori elevati, rendendo necessaria la protezione solare.","advice":["Si consiglia di dedicare la giornata al mare o ad attività all'aperto, godendo delle ottime condizioni meteo.","Non dimenticare di proteggere la pelle e gli occhi dai raggi solari, specialmente durante le ore di punta.","Ideale per escursioni via mare verso le spiagge nascoste o per un giro dell'isola in barca."],"alerts":[]}],"processedAt":"2025-10-21T20:39:53.170Z"};

    // === GLOBALS ===
    let notificationsEnabled = false;

    // === HELPER FUNCTIONS ===
    function formatDate(dateStr) {
      const date = new Date(dateStr);
      const giorni = ['Domenica', 'Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato'];
      const mesi = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
      return `${giorni[date.getDay()]} ${date.getDate()} ${mesi[date.getMonth()]}`;
    }

    function getShortDate(dateStr) {
      const date = new Date(dateStr);
      const giorni = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];
      return giorni[date.getDay()];
    }

    function getWeatherIcon(summary) {
      const text = (summary || '').toLowerCase();
      if (text.includes('temporale')) return 'wi-thunderstorm';
      if (text.includes('pioggia forte')) return 'wi-rain';
      if (text.includes('pioggia')) return 'wi-showers';
      if (text.includes('neve')) return 'wi-snow';
      if (text.includes('nebbia')) return 'wi-fog';
      if (text.includes('nuvoloso')) return 'wi-cloudy';
      if (text.includes('parzialmente')) return 'wi-day-cloudy';
      if (text.includes('sereno')) return 'wi-day-sunny';
      return 'wi-day-cloudy';
    }

    function getTempClass(temp) {
      if (temp >= 28) return 'hot';
      if (temp >= 22) return 'warm';
      if (temp >= 15) return 'mild';
      if (temp >= 8) return 'cool';
      return 'cold';
    }

    function getMoonPhaseEmoji(phaseText) {
      if (!phaseText) return '🌕';
      const phase = phaseText.toLowerCase();
      if (phase.includes('nuova')) return '🌑';
      if (phase.includes('crescente') && phase.includes('primo')) return '🌓';
      if (phase.includes('crescente')) return '🌒';
      if (phase.includes('gibbosa') && phase.includes('crescente')) return '🌔';
      if (phase.includes('piena')) return '🌕';
      if (phase.includes('gibbosa') && phase.includes('calante')) return '🌖';
      if (phase.includes('calante') && phase.includes('ultimo')) return '🌗';
      if (phase.includes('calante')) return '🌘';
      return '🌕';
    }

    function createWindRoseSVG(direction, speed) {
      const angle = getWindAngle(direction);
      return `
        <svg class="wind-rose-svg" viewBox="0 0 100 100" style="transform: rotate(${angle}deg)">
          <circle cx="50" cy="50" r="48" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="2"/>
          <text x="50" y="12" text-anchor="middle" fill="rgba(255,255,255,0.6)" font-size="10" font-weight="600">N</text>
          <path d="M 50 20 L 55 40 L 50 35 L 45 40 Z" fill="#08a5e8" opacity="0.9"/>
          <path d="M 50 35 L 50 70" stroke="#08a5e8" stroke-width="3" stroke-linecap="round"/>
          <circle cx="50" cy="50" r="5" fill="#08a5e8"/>
        </svg>
      `;
    }

    function getWindAngle(direction) {
      const directions = {
        'N': 0, 'NE': 45, 'E': 90, 'SE': 135, 'S': 180, 'SW': 225, 'W': 270, 'NW': 315,
        'NNE': 22.5, 'ENE': 67.5, 'ESE': 112.5, 'SSE': 157.5,
        'SSW': 202.5, 'WSW': 247.5, 'WNW': 292.5, 'NNW': 337.5,
        'SSO': 202.5, 'SO': 225, 'OSO': 247.5, 'O': 270, 'ONO': 292.5, 'NO': 315, 'NNO': 337.5
      };
      return directions[direction?.toUpperCase()] || 0;
    }

    function getAQIClass(aqi) {
      if (aqi <= 50) return 'aqi-good';
      if (aqi <= 100) return 'aqi-moderate';
      if (aqi <= 150) return 'aqi-unhealthy-sensitive';
      return 'aqi-unhealthy';
    }

    function getAQILevel(aqi) {
      if (aqi <= 50) return 'Buona';
      if (aqi <= 100) return 'Moderata';
      if (aqi <= 150) return 'Malsana per sensibili';
      return 'Malsana';
    }

    function getAQIIcon(aqi) {
      if (aqi <= 50) return '😊';
      if (aqi <= 100) return '😐';
      if (aqi <= 150) return '😷';
      return '😨';
    }

    // === FUNCTIONS ===
    function exportToPDF() {
      window.print();
    }

    async function shareWeather() {
      if (!weatherData || !weatherData.days || weatherData.days.length === 0) return;
      const today = weatherData.days[0];
      const text = `Meteo Procida oggi: ${Math.round(today.temp?.max || 20)}°C\n${today.summary || 'Consulta le previsioni complete'}`;
      
      if (navigator.share) {
        try {
          await navigator.share({
            title: 'Meteo Procida',
            text: text,
            url: window.location.href
          });
        } catch (err) {
          console.log('Share cancelled');
        }
      } else {
        alert('Condivisione non supportata su questo browser');
      }
    }

    // === NOTIFICHE ===
    async function toggleNotifications() {
      if (!('Notification' in window)) {
        alert('Notifiche non supportate su questo browser');
        return;
      }

      if (Notification.permission === 'granted') {
        notificationsEnabled = !notificationsEnabled;
        updateNotificationUI();
        if (notificationsEnabled) {
          sendTestNotification();
        }
      } else if (Notification.permission !== 'denied') {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
          notificationsEnabled = true;
          updateNotificationUI();
          sendTestNotification();
        }
      } else {
        alert('Notifiche bloccate. Abilitale dalle impostazioni del browser.');
      }
    }

    function updateNotificationUI() {
      const toggle = document.getElementById('notificationToggle');
      const status = document.getElementById('notification-status');
      
      if (notificationsEnabled) {
        toggle.classList.add('active');
        toggle.innerHTML = '🔔';
        status.textContent = 'Notifiche: Attive ✓';
      } else {
        toggle.classList.remove('active');
        toggle.innerHTML = '🔕';
        status.textContent = 'Notifiche: Disattivate';
      }
    }

    function sendTestNotification() {
      if (!weatherData || !weatherData.days || weatherData.days.length === 0) return;
      const today = weatherData.days[0];
      
      new Notification('Meteo Procida', {
        body: `Oggi: ${Math.round(today.temp?.max || 20)}°C - ${today.summary?.substring(0, 100) || 'Consulta le previsioni'}`,
        icon: 'apple-touch-icon.jpg',
        badge: 'apple-touch-icon.jpg',
        tag: 'meteo-update'
      });
    }

    function checkWeatherAlerts() {
      if (!notificationsEnabled || !weatherData) return;
      
      weatherData.days.forEach((day, index) => {
        if (day.alerts && day.alerts.length > 0 && index === 0) {
          new Notification('⚠️ Allerta Meteo Procida', {
            body: day.alerts[0],
            icon: 'apple-touch-icon.jpg',
            tag: 'weather-alert',
            requireInteraction: true
          });
        }
      });
    }

    // === RENDER HERO ===
    function renderHero() {
      if (!weatherData || !weatherData.days || weatherData.days.length === 0) return;
      
      const today = weatherData.days[0];
      const tempClass = getTempClass(today.temp?.max || 20);
      const weatherIcon = getWeatherIcon(today.summary);
      const moonEmoji = getMoonPhaseEmoji(today.moon_phase);
      
      let aqiWidget = '';
      if (today.air_quality && today.air_quality.aqi) {
        const aqi = today.air_quality.aqi;
        const aqiClass = getAQIClass(aqi);
        const aqiLevel = getAQILevel(aqi);
        const aqiIcon = getAQIIcon(aqi);
        
        aqiWidget = `
          <div class="aqi-widget ${aqiClass}">
            <div class="aqi-icon">${aqiIcon}</div>
            <div class="aqi-content">
              <div class="aqi-title">Qualità dell'Aria</div>
              <div class="aqi-value">${aqi}</div>
              <div class="aqi-level">${aqiLevel}</div>
            </div>
          </div>
        `;
      }
      
      const html = `
        <div class="hero-card ${tempClass}">
          <div class="hero-header">
            <div class="hero-location">
              <i class="wi wi-horizon"></i>
              ${weatherData.location || 'Procida'}
            </div>
            <div class="hero-date">${formatDate(today.date)}</div>
          </div>

          <div class="hero-main">
            <div class="hero-temp">${Math.round(today.temp?.max || 20)}°</div>
            <div class="hero-condition">
              <i class="wi ${weatherIcon}"></i>
              <span>${getConditionText(today)}</span>
            </div>
            <div class="hero-minmax">
              <span><i class="wi wi-direction-down"></i>${Math.round(today.temp?.min || 15)}°</span>
              <span><i class="wi wi-direction-up"></i>${Math.round(today.temp?.max || 20)}°</span>
            </div>
          </div>

          ${today.summary ? `<div class="hero-summary">${today.summary}</div>` : ''}
          ${aqiWidget}

          ${today.advice && today.advice.length > 0 ? `
            <div class="advice-pills">
              ${today.advice.map(a => `<div class="advice-pill">💡 ${a}</div>`).join('')}
            </div>
          ` : ''}

          ${today.alerts && today.alerts.length > 0 ? `
            <div class="alerts">
              <strong>⚠️ ALLERTE METEO</strong>
              ${today.alerts.map(a => `<p>${a}</p>`).join('')}
            </div>
          ` : ''}

          <div class="details-pills">
            ${today.rain && today.rain.probability > 0 ? `
              <div class="detail-pill rain-detail">
                <i class="wi wi-raindrop"></i>
                <span class="value">${today.rain.probability}%</span>
                <span class="label">Pioggia</span>
              </div>
            ` : ''}
            
            ${today.wind && today.wind.periods && today.wind.periods[0] ? `
              <div class="detail-pill">
                <div class="wind-rose-container">
                  ${createWindRoseSVG(today.wind.periods[0].direction, today.wind.periods[0].speed_kmh)}
                </div>
                <span class="value">${today.wind.periods[0].speed_kmh} km/h</span>
                <span class="label">${today.wind.periods[0].direction}</span>
              </div>
            ` : ''}

            ${today.humidity ? `
              <div class="detail-pill">
                <i class="wi wi-humidity"></i>
                <span class="value">${today.humidity}%</span>
                <span class="label">Umidità</span>
              </div>
            ` : ''}

            ${today.uv_index ? `
              <div class="detail-pill temp-detail">
                <i class="wi wi-day-sunny"></i>
                <span class="value">${today.uv_index}</span>
                <span class="label">UV</span>
              </div>
            ` : ''}

            ${today.pressure ? `
              <div class="detail-pill">
                <i class="wi wi-barometer"></i>
                <span class="value">${today.pressure.value_hPa}</span>
                <span class="label">hPa</span>
              </div>
            ` : ''}

            ${today.sea ? `
              <div class="detail-pill rain-detail">
                <i class="wi wi-tsunami"></i>
                <span class="value">${today.sea.wave_height_m}m</span>
                <span class="label">${today.sea.condition}</span>
              </div>
            ` : ''}

            ${today.sunrise ? `
              <div class="detail-pill temp-detail">
                <i class="wi wi-sunrise"></i>
                <span class="value">${today.sunrise}</span>
                <span class="label">Alba</span>
              </div>
            ` : ''}

            ${today.sunset ? `
              <div class="detail-pill temp-detail">
                <i class="wi wi-sunset"></i>
                <span class="value">${today.sunset}</span>
                <span class="label">Tramonto</span>
              </div>
            ` : ''}

            ${today.moon_phase ? `
              <div class="detail-pill moon-phase-pill">
                <span class="moon-emoji">${moonEmoji}</span>
                <span class="label">${today.moon_phase}</span>
              </div>
            ` : ''}
          </div>
        </div>
      `;
      
      document.getElementById('hero-container').innerHTML = html;
    }

    function getConditionText(day) {
      if (day.rain && day.rain.probability > 70) return 'Pioggia';
      if (day.rain && day.rain.probability > 40) return 'Possibile pioggia';
      const summary = (day.summary || '').toLowerCase();
      if (summary.includes('sereno')) return 'Sereno';
      if (summary.includes('nuvoloso')) return 'Nuvoloso';
      return 'Variabile';
    }

    // === CHART.JS GRAFICI CORRETTI ===
    function renderCharts() {
      if (!weatherData || !weatherData.days || weatherData.days.length === 0) {
        console.warn('❌ Dati meteo non disponibili per i grafici');
        return;
      }

      console.log('🎨 Creazione grafici...', weatherData.days.length, 'giorni');
      console.log('📊 Dati temperature:', weatherData.days.map(d => d.temp?.max));

      const labels = weatherData.days.map(d => getShortDate(d.date));
      const temps = weatherData.days.map(d => d.temp?.max || 20);
      const tempsMins = weatherData.days.map(d => d.temp?.min || 15);
      const rains = weatherData.days.map(d => d.rain?.total_mm || 0);
      const pressures = weatherData.days.map(d => d.pressure?.value_hPa || 1013);
      const winds = weatherData.days.map(d => d.wind?.periods?.[0]?.speed_kmh || 0);

      try {
        // Grafico 1: Temperature & Precipitazioni
        const ctx1 = document.getElementById('weatherChart');
        if (!ctx1) {
          console.error('❌ Canvas weatherChart non trovato!');
          return;
        }
        
        console.log('✅ Canvas weatherChart trovato');
        new Chart(ctx1.getContext('2d'), {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'Temp Max (°C)',
                data: temps,
                borderColor: '#faa202',
                backgroundColor: 'rgba(250, 162, 2, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 7
              },
              {
                label: 'Temp Min (°C)',
                data: tempsMins,
                borderColor: '#08a5e8',
                backgroundColor: 'rgba(8, 165, 232, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 7
              },
              {
                label: 'Pioggia (mm)',
                data: rains,
                type: 'bar',
                backgroundColor: 'rgba(8, 165, 232, 0.6)',
                borderColor: '#08a5e8',
                borderWidth: 2,
                yAxisID: 'y1'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: { color: '#a0c4d8', font: { size: 12 } }
              },
              tooltip: {
                backgroundColor: 'rgba(1, 37, 73, 0.9)',
                titleColor: '#fff',
                bodyColor: '#a0c4d8',
                borderColor: '#08a5e8',
                borderWidth: 1
              }
            },
            scales: {
              y: {
                type: 'linear',
                display: true,
                position: 'left',
                ticks: { color: '#a0c4d8' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
              },
              y1: {
                type: 'linear',
                display: true,
                position: 'right',
                ticks: { color: '#08a5e8' },
                grid: { drawOnChartArea: false }
              },
              x: {
                ticks: { color: '#a0c4d8' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
              }
            }
          }
        });
        console.log('✅ Grafico Temperature creato');
      } catch (error) {
        console.error('❌ Errore grafico Temperature:', error);
      }

      try {
        // Grafico 2: Pressione & Vento
        const ctx2 = document.getElementById('pressureWindChart');
        if (!ctx2) {
          console.error('❌ Canvas pressureWindChart non trovato!');
          return;
        }
        
        console.log('✅ Canvas pressureWindChart trovato');
        new Chart(ctx2.getContext('2d'), {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'Pressione (hPa)',
                data: pressures,
                borderColor: '#34c759',
                backgroundColor: 'rgba(52, 199, 89, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 7
              },
              {
                label: 'Vento (km/h)',
                data: winds,
                borderColor: '#faa202',
                backgroundColor: 'rgba(250, 162, 2, 0.1)',
                borderWidth: 3,
                fill: false,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 7,
                yAxisID: 'y1'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: { color: '#a0c4d8', font: { size: 12 } }
              },
              tooltip: {
                backgroundColor: 'rgba(1, 37, 73, 0.9)',
                titleColor: '#fff',
                bodyColor: '#a0c4d8',
                borderColor: '#08a5e8',
                borderWidth: 1
              }
            },
            scales: {
              y: {
                ticks: { color: '#34c759' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
              },
              y1: {
                type: 'linear',
                display: true,
                position: 'right',
                ticks: { color: '#faa202' },
                grid: { drawOnChartArea: false }
              },
              x: {
                ticks: { color: '#a0c4d8' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
              }
            }
          }
        });
        console.log('✅ Grafico Pressione creato');
      } catch (error) {
        console.error('❌ Errore grafico Pressione:', error);
      }
    }

    // === RENDER STATS ===
    function renderStats() {
      if (!weatherData || !weatherData.weekStats) return;
      const stats = weatherData.weekStats;
      
      const html = `
        <div class="stats-grid">
          <div class="stat-card">
            <i class="wi wi-thermometer" style="color: var(--accent-orange);"></i>
            <div class="stat-value">${stats.maxTemp}°C</div>
            <div class="stat-label">Max Settimana</div>
          </div>
          <div class="stat-card">
            <i class="wi wi-thermometer-exterior" style="color: var(--accent-cyan);"></i>
            <div class="stat-value">${stats.minTemp}°C</div>
            <div class="stat-label">Min Settimana</div>
          </div>
          <div class="stat-card">
            <i class="wi wi-thermometer" style="color: var(--accent-green);"></i>
            <div class="stat-value">${stats.avgTemp}°C</div>
            <div class="stat-label">Media</div>
          </div>
          <div class="stat-card">
            <i class="wi wi-rain" style="color: var(--accent-cyan);"></i>
            <div class="stat-value">${stats.rainyDays}</div>
            <div class="stat-label">Giorni Pioggia</div>
          </div>
        </div>
      `;
      
      document.getElementById('stats-container').innerHTML = html;
    }

    // === RENDER FORECAST ===
    function renderForecast() {
      if (!weatherData || !weatherData.days || weatherData.days.length < 2) {
        document.getElementById('forecast-container').innerHTML = `
          <div class="error-message">
            <h2>⚠️ Errore nel caricamento dei dati</h2>
            <p>Impossibile recuperare le previsioni meteo. Riprova più tardi.</p>
          </div>
        `;
        return;
      }

      const futureDays = weatherData.days.slice(1);
      const html = futureDays.map(day => {
        const moonEmoji = getMoonPhaseEmoji(day.moon_phase);
        
        return `
        <div class="day-card-compact">
          <div class="day-card-header">
            <div class="day-name">${formatDate(day.date)}</div>
            <div class="day-temps-compact">
              <span class="temp-max">${Math.round(day.temp?.max || 20)}°</span>
              <span class="temp-min">${Math.round(day.temp?.min || 15)}°</span>
            </div>
          </div>

          ${day.summary ? `<div class="day-summary-short">${day.summary}</div>` : ''}

          ${day.advice && day.advice.length > 0 ? `
            <div class="advice-pills">
              ${day.advice.slice(0, 2).map(a => `<div class="advice-pill">💡 ${a}</div>`).join('')}
            </div>
          ` : ''}

          ${day.alerts && day.alerts.length > 0 ? `
            <div class="alerts">
              <strong>⚠️ ALLERTE</strong>
              ${day.alerts.map(a => `<p>${a}</p>`).join('')}
            </div>
          ` : ''}

          <div class="day-details-row">
            ${day.rain && day.rain.probability > 0 ? `
              <div class="detail-compact">
                <i class="wi wi-raindrop" style="color: var(--accent-cyan);"></i>
                <div class="value">${day.rain.probability}%</div>
                <div class="label">${day.rain.total_mm}mm</div>
              </div>
            ` : ''}

            ${day.wind && day.wind.periods && day.wind.periods[0] ? `
              <div class="detail-compact">
                <div style="width: 40px; height: 40px; margin: 0 auto 4px;">
                  ${createWindRoseSVG(day.wind.periods[0].direction, day.wind.periods[0].speed_kmh)}
                </div>
                <div class="value">${day.wind.periods[0].speed_kmh} km/h</div>
                <div class="label">${day.wind.periods[0].direction}</div>
              </div>
            ` : ''}

            ${day.sea ? `
              <div class="detail-compact">
                <i class="wi wi-tsunami" style="color: var(--accent-cyan);"></i>
                <div class="value">${day.sea.wave_height_m}m</div>
                <div class="label">${day.sea.condition}</div>
              </div>
            ` : ''}

            ${day.humidity ? `
              <div class="detail-compact">
                <i class="wi wi-humidity"></i>
                <div class="value">${day.humidity}%</div>
                <div class="label">Umidità</div>
              </div>
            ` : ''}

            ${day.uv_index ? `
              <div class="detail-compact">
                <i class="wi wi-day-sunny" style="color: var(--accent-orange);"></i>
                <div class="value">${day.uv_index}</div>
                <div class="label">UV Index</div>
              </div>
            ` : ''}

            ${day.pressure ? `
              <div class="detail-compact">
                <i class="wi wi-barometer"></i>
                <div class="value">${day.pressure.value_hPa}</div>
                <div class="label">${day.pressure.trend || 'hPa'}</div>
              </div>
            ` : ''}

            ${day.moon_phase ? `
              <div class="detail-compact">
                <span style="font-size: 1.5rem; display: block; margin-bottom: 4px;">${moonEmoji}</span>
                <div class="label">${day.moon_phase}</div>
              </div>
            ` : ''}
          </div>
        </div>
      `}).join('');

      document.getElementById('forecast-container').innerHTML = `<div class="days-grid">${html}</div>`;
    }

    function updateTimestamp() {
      if (weatherData && weatherData.generatedAt) {
        const date = new Date(weatherData.generatedAt);
        document.getElementById('last-update').textContent = 
          `Ultimo aggiornamento: ${date.toLocaleString('it-IT')}`;
      }
    }

    // === INIZIALIZZAZIONE ===
    renderHero();
    renderCharts(); // ← GRAFICI CORRETTI
    renderStats();
    renderForecast();
    updateTimestamp();
    
    // Check alerts
    setTimeout(checkWeatherAlerts, 2000);

    // Register Service Worker per PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(reg => console.log('Service Worker registrato'))
        .catch(err => console.log('Service Worker errore:', err));
    }
  </script>
</body>
</html>