<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes" />
  <title>Previsioni Procida - Dashboard Meteo</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Roboto&display=swap');
    html { box-sizing: border-box;} *,*:before,*:after { box-sizing: inherit; }
    body { font-family: 'Roboto', Arial, sans-serif; max-width: 1000px; margin: 0 auto; background: linear-gradient(135deg, #242e47, #3498db 92%); color: #e0f6ff; padding: 14px 2px 18px 2px; overflow-x: hidden; min-height: 100vh; }
    .header { font-family: 'Montserrat', sans-serif; font-size: 2.45em; font-weight: 900; text-align: center; color: #d2f6ff; text-shadow: 1px 2px 14px #09172a; letter-spacing: 2px; user-select: none; margin-bottom: 23px; }
    .dashboard { display: flex; flex-wrap: wrap; gap: 19px; justify-content: center; }
    .box { background: rgba(37,59,102,0.22); border-radius: 19px; box-shadow: 0 5px 26px #06214642; padding: 17px 14px 22px 14px; flex: 1 1 340px; max-width: 440px; min-width: 215px; display: flex; flex-direction: column; align-items: center; margin-bottom: 13px; position: relative;}
    .box-title { font-size: 1.19rem; font-weight: 900; color: #a3e8ff; letter-spacing: 1px; margin-bottom: 11px; font-family: 'Montserrat', sans-serif; }
    .box .main { font-weight: 700; font-size: 1.13em; color: #85dffd;}
    .box .desc { margin: 2px 0 0 0; font-size: 1.01em; color:#bcd3e3;}
    button.detail-btn { margin-top:9px; background: #129cf7; color: #fff; font-weight:700; border: none; border-radius: 8px; padding: 11px 24px; cursor: pointer; transition: background 0.14s;}
    button.detail-btn.active, button.detail-btn:hover { background: #49bcf8;}
    .detail-section { max-height: 0; opacity: 0; overflow: hidden; transition: max-height 0.25s, opacity 0.18s; margin-top: 12px;width: 100%;}
    .detail-section.active { max-height: 420px; opacity: 1; }
    .chart-wrap { width: 99%; max-width: 385px; margin: 0 auto 18px auto; border-radius: 13px; background: #1d2c56d0; padding: 11px 5px 7px 5px;}
    .fixed-info { width: 98%; position: absolute; bottom: 16px; left: 0; display: flex; justify-content: space-around; font-weight:700; font-size:1em;}
    .fixed-info .info { padding: 4px 12px; border-radius: 7px; margin: 0 2px;}
    .info-wind { background: #41d7e580; color:#16345c;}
    .info-sea { background: #62fae320; color:#1a3f44;}
    .info-press { background: #ffd47282; color:#55430a;}
    .info-rain { background: #45bafe72; color:#194058;}
    .wind-rose { margin-top: 9px; width: 88px; height: 88px; display: flex;justify-content:center;align-items:center; background: #fff2; border-radius: 50%; position: relative;}
    .wind-arrow { width:38px; height:38px; position: absolute; left:50%;top:50%;transform:translate(-50%,-50%) rotate(0deg); transform-origin: 50% 80%;transition:transform 0.18s;}
    .wind-arrow svg { width:100%; height:100%;}
    .wind-rose-label { position: absolute; font-size:0.70em;color:#ffffffd8;font-family:'Montserrat';}
    .wind-rose-label.n { top:6px; left:50%; transform:translateX(-50%);}
    .wind-rose-label.s { bottom:6px; left:50%; transform:translateX(-50%);}
    .wind-rose-label.e { left:70px; top:50%; transform:translateY(-50%);}
    .wind-rose-label.w { left:5px; top:50%; transform:translateY(-50%);}
    .mini-days { display: flex; flex-wrap: wrap; gap:8px; margin:22px auto 7px auto; justify-content: center;}
    .mini-day { background: #0b1333b0; color: #c6f3ff; border-radius:11px; padding:9px 15px; font-size:1em; min-width:90px; box-shadow: 0 2px 8px #202b3b44;cursor: pointer;transition:background 0.2s, color 0.16s;}
    .mini-day.selected { background: #61cfff; color: #fff2c2; box-shadow:0 0 12px #75eafd88; font-weight:900;}
    .mini-day .daylabel { font-weight:700; color:#fff;}
    .mini-day .icon {font-size:1.22em; vertical-align:-3px;}
    .mini-day .tmax {color:#ffd472;}
    .mini-day .tmin {color:#6fd7f8;}
    .mini-day .wind {color:#86caff;}
    .mini-day .rain {color:#7fffd4;}
    .big-today { grid-column: span 3; background: #2564a8d1; box-shadow:0 0 14px #75eafd52; }
    .footer { margin-top: 32px; text-align: center; color: #dbefff; font-size:17px; font-weight:500; text-shadow:0 2px 6px #283c5880;}
    @media (max-width:950px){ .dashboard{gap:14px;} .box{min-width:180px;max-width:97vw;} }
    @media (max-width:740px){ .dashboard{flex-direction:column;align-items:center;gap:13px;} .box{width:100%;max-width:98vw;} .header{font-size:1.17em;} }
    @media (max-width:510px){ .mini-day{padding:6px 5px;font-size:0.93em;} }
    .alert-box, .advice-box {width: 90%;margin:8px auto 9px auto;font-size:1.08em;border-radius:7px;padding:9px 12px;text-align:center;font-weight:700;}
    .alert-box {background:#fff3c238;color:#7a3d14;}
    .advice-box {background:#c2fff842;color:#1a7352;}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="header">PREVISIONI METEO PROCIDA</div>
  <div class="mini-days" id="miniDaysBox"></div>
  <div class="dashboard" id="dashboard">
    <section class="box vento" id="windbox"></section>
    <section class="box pioggia" id="rainbox"></section>
    <section class="box mare" id="seabox"></section>
    <section class="box pressione" id="pressbox"></section>
  </div>
  <div class="footer" id="footer"></div>
<script>
// ==== DATI SIMULATI (SOSTITUISCI CON TUO JSON DA n8n) ====
const DATA = {
  days:[
    {day_label:"14/10",icon:"☀️",temp_max:22,temp_min:18,precipitation:2.3,wind_max:13,wind_gust:19,wind_min:6,wind_dir:90,hourly_winds:[7,9,11,13,12,10,7,6,10,12,9,8,7,6,6,7,8,9,11,12,13,12,10,9],hourly_wind_directions:[80,90,90,100,110,120,120,130,140,150,150,155,160,160,170,170,180,180,180,180,170,160,150,140],hourly_labels:["00","01","02","03","04","05","06","07","08","09","10","11","12","13","14","15","16","17","18","19","20","21","22","23"],hourly_precips:[0,0,0,0,0,0.4,0.8,0.0,0,0,0,0,0.2,0,0,0,0.7,0,0,0,0,0,0,0],pressure_avg:1017,hourly_pressures:[1017,1018,1018,1018,1018,1018,1017,1017,1017,1017,1018,1019,1020,1019,1018,1018,1017,1016,1016,1016,1016,1016,1017,1017]},
    {day_label:"15/10",icon:"⛅",temp_max:21,temp_min:15,precipitation:0.5,wind_max:10,wind_gust:17,wind_min:5,wind_dir:70},
    {day_label:"16/10",icon:"🌤️",temp_max:20,temp_min:14,precipitation:0,wind_max:12,wind_gust:16,wind_min:5,wind_dir:60},
    {day_label:"17/10",icon:"🌧️",temp_max:18,temp_min:13,precipitation:5.6,wind_max:15,wind_gust:22,wind_min:9,wind_dir:120},
    {day_label:"18/10",icon:"⛅",temp_max:19,temp_min:15,precipitation:0.8,wind_max:11,wind_gust:15,wind_min:6,wind_dir:105},
    {day_label:"19/10",icon:"🌦️",temp_max:20,temp_min:14,precipitation:1.2,wind_max:8,wind_gust:12,wind_min:4,wind_dir:90}
  ],
  mergedHourly:[
    {wave_height:0.05,sea_surface_temperature:21.7,time:"2025-10-14T00:00",swell_height:0.02,swell_direction:209},
    {wave_height:0.06,sea_surface_temperature:21.9,time:"2025-10-14T03:00",swell_height:0.02,swell_direction:212},
    {wave_height:0.04,sea_surface_temperature:21.8,time:"2025-10-14T06:00",swell_height:0.02,swell_direction:215},
    {wave_height:0.05,sea_surface_temperature:22.0,time:"2025-10-14T09:00",swell_height:0.02,swell_direction:218},
    {wave_height:0.08,sea_surface_temperature:22.4,time:"2025-10-14T12:00",swell_height:0.03,swell_direction:215},
    {wave_height:0.09,sea_surface_temperature:22.6,time:"2025-10-14T15:00",swell_height:0.04,swell_direction:222},
    {wave_height:0.06,sea_surface_temperature:22.3,time:"2025-10-14T18:00",swell_height:0.03,swell_direction:223},
    {wave_height:0.04,sea_surface_temperature:21.9,time:"2025-10-14T21:00",swell_height:0.02,swell_direction:220}
  ],
  alerts:["Nessuna allerta"],
  advice:"Giornata perfetta per attività all'aperto!",
  updated_at:"14/10/2025, 23:12"
};

let selectedDayIndex = 0;
let windChart, rainChart, seaChart, pressChart;

// --- Logica palette e funzioni utility ---
function windDirectionName(deg) {
  if(deg==null) return "--";
  const winds = [
    {name:"Tramontana",abbr:"N"}, {name:"Grecale",abbr:"NE"},
    {name:"Levante",abbr:"E"}, {name:"Scirocco",abbr:"SE"},
    {name:"Ostro",abbr:"S"}, {name:"Libeccio",abbr:"SO"},
    {name:"Ponente",abbr:"O"}, {name:"Maestrale",abbr:"NO"}];
  const idx = Math.floor(((deg+22.5)%360)/45);
  return winds[idx]?winds[idx].name+" ("+winds[idx].abbr+")":"N/D";
}
function calculateMean(arr){if(!arr.length)return 0;return arr.reduce((a,b)=>a+b,0)/arr.length;}
function calculateRange(arr){if(!arr.length)return 0;return Math.max(...arr)-Math.min(...arr);}
function calculateStdDev(arr){if(!arr.length)return 0;const m=calculateMean(arr);return Math.sqrt(arr.reduce((a,b)=>a+(b-m)**2,0)/arr.length);}
function rainIcon(valmm){if(valmm<0.1)return'';if(valmm<0.5)return'💧';if(valmm<1)return'💧💧';if(valmm<3)return'💧💧💧';if(valmm<10)return'💧💧💧💧';return'💧💧💧💧💧';}
function pressureTrend(arr){
  if (!arr || arr.length < 5) return "N/D";
  const meanStart = (arr[0]+arr[1]+arr[2])/3, meanEnd = (arr[arr.length-3]+arr[arr.length-2]+arr[arr.length-1])/3;
  if (meanEnd > meanStart + 1) return 'in aumento ⬆️ (alta)';
  if (meanStart > meanEnd + 1) return 'in calo ⬇️ (bassa)';
  return 'stabile ◼️';
}

// --- Funzione Toggle con animazione espansione/chiusura ---
function toggleDetail(id){
  const section = document.getElementById(id);
  const button = section.previousElementSibling;
  // Deselect all
  document.querySelectorAll('.detail-section').forEach(e=>e.classList.remove('active'));
  document.querySelectorAll('.detail-btn').forEach(btn=>btn.classList.remove('active'));
  // Toggle selected
  section.classList.toggle('active');
  if(section.classList.contains('active')) button.classList.add('active');
}

// Continuiamo nella prossima parte...
// ------------ Render Wind con Rosa dei venti ------------
function renderWind() {
  const d = DATA.days[selectedDayIndex];
  const windSpeed = d.hourly_winds ? d.hourly_winds[new Date().getHours()] : d.wind_max || "--";
  const windDeg = d.hourly_wind_directions ? d.hourly_wind_directions[new Date().getHours()] : d.wind_dir || "--";
  const windDirTxt = windDirectionName(windDeg);
  document.getElementById("windbox").innerHTML = `
    <div class="box-title">🌬️ Vento</div>
    <div class="main">Corrente: <b>${windSpeed} km/h</b></div>
    <div class="desc">Direzione: <b>${windDeg}°</b> ${windDirTxt}</div>
    <div class="wind-rose" id="windRose">
      <span class="wind-rose-label n">N</span>
      <span class="wind-rose-label s">S</span>
      <span class="wind-rose-label e">E</span>
      <span class="wind-rose-label w">O</span>
      <div class="wind-arrow" id="windArrow">
        <svg viewBox="0 0 32 32"><polygon points="16,2 22,22 16,18 10,22" fill="#61cfff" stroke="#145377" stroke-width="1"/></svg>
      </div>
    </div>
    <div class="main">Folata max: <b>${d.wind_gust||d.wind_max||"--"} km/h</b></div>
    <button class="detail-btn" onclick="toggleDetail('wind-detail')">Dettagli / Grafico</button>
    <div class="detail-section" id="wind-detail">
      <div class="chart-wrap"><canvas id="windchart"></canvas></div>
      <div class="fixed-info">
        <span class="info info-wind">Massimo: ${d.hourly_winds?Math.max(...d.hourly_winds):"--"} km/h</span>
        <span class="info info-wind">Minimo: ${d.hourly_winds?Math.min(...d.hourly_winds):"--"} km/h</span>
        <span class="info info-wind">Dir. max: ${windDirectionName(d.hourly_wind_directions?Math.max(...d.hourly_wind_directions):d.wind_dir)}</span>
      </div>
    </div>
  `;
  document.getElementById("windArrow").style.transform = `translate(-50%,-50%) rotate(${windDeg}deg)`;
  setTimeout(()=>{
    if(windChart){windChart.destroy();}
    const ctx=document.getElementById('windchart').getContext('2d');
    windChart = new Chart(ctx,{
      type:'line',
      data:{
        labels:d.hourly_labels||[], 
        datasets:[{label:'Vento (km/h)',data:d.hourly_winds||[],borderColor:'#66E5FF',backgroundColor:'rgba(90,184,255,0.12)',fill:true,tension:0.21,pointRadius:1}]
      },
      options:{
        responsive:true,maintainAspectRatio:false,
        plugins:{legend:{display:false},tooltip:{enabled:true,mode:'nearest',intersect:false}},
        onHover:event=>{
          const points = windChart.getElementsAtEventForMode(event, 'nearest', { intersect: false }, false);
          if(points.length){
            const idx = points[0].index;
            document.getElementById("windArrow").style.transform = `translate(-50%,-50%) rotate(${d.hourly_wind_directions[idx]}deg)`;
          }
        },
        scales:{y:{beginAtZero:true},x:{}}
      }
    });
  },130);
}

// ------------ Render Rain con tooltip ------------
function renderRain(){
  const d = DATA.days[selectedDayIndex];
  const pioggia = d.precipitation || 0;
  document.getElementById("rainbox").innerHTML = `
    <div class="box-title">🌧️ Pioggia</div>
    <div class="main">Totale oggi: <b>${pioggia.toFixed(1)} mm</b> ${rainIcon(pioggia)}</div>
    <div class="desc">Previsione: ${pioggia > 0 ? "Possibile precipitazione" : "Nessuna pioggia significativa"}</div>
    <button class="detail-btn" onclick="toggleDetail('rain-detail')">Dettagli / Grafico</button>
    <div class="detail-section" id="rain-detail">
      <div class="chart-wrap"><canvas id="rainchart"></canvas></div>
      <div class="fixed-info">
        <span class="info info-rain">Ora più piovosa: ${d.hourly_labels && d.hourly_precips ? d.hourly_labels[d.hourly_precips.indexOf(Math.max(...d.hourly_precips))] : "--"}</span>
        <span class="info info-rain">Max: ${d.hourly_precips?Math.max(...d.hourly_precips):"--"} mm</span>
      </div>
    </div>
  `;
  setTimeout(()=>{
    if(rainChart){rainChart.destroy();}
    const ctx=document.getElementById('rainchart').getContext('2d');
    rainChart = new Chart(ctx,{
      type:'bar',
      data:{
        labels:d.hourly_labels||[], 
        datasets:[{label:'Precipitazioni (mm)',data:d.hourly_precips||[],backgroundColor:'#45bafe',borderColor:'#52afe7',borderWidth:2}]
      },
      options:{
        responsive:true,maintainAspectRatio:false,
        plugins:{legend:{display:false},tooltip:{enabled:true,mode:'nearest',intersect:false}},
        scales:{y:{beginAtZero:true},x:{}}
      }
    });
  },100);
}

// ------------ Render Sea ------------
function renderSea(){
  const arr = DATA.mergedHourly||[];
  const waveMean = calculateMean(arr.map(h=>h.wave_height));
  const waveRange = calculateRange(arr.map(h=>h.wave_height));
  const waveStdDev = calculateStdDev(arr.map(h=>h.wave_height));
  const seaTemp = calculateMean(arr.map(h=>h.sea_surface_temperature));
  document.getElementById("seabox").innerHTML = `
    <div class="box-title">🌊 Mare</div>
    <div class="main">Altezza media onda: <b>${waveMean.toFixed(2)} m</b></div>
    <div class="desc">Temperatura mare: <b>${seaTemp.toFixed(1)} °C</b></div>
    <button class="detail-btn" onclick="toggleDetail('sea-detail')">Dettagli / Grafico</button>
    <div class="detail-section" id="sea-detail">
      <div class="chart-wrap"><canvas id="seachart"></canvas></div>
      <div class="fixed-info">
        <span class="info info-sea">Hsig: ${waveMean.toFixed(2)} m</span>
        <span class="info info-sea">Range: ${waveRange.toFixed(2)} m</span>
        <span class="info info-sea">Dev Std: ${waveStdDev.toFixed(2)} m</span>
      </div>
    </div>
  `;
  setTimeout(()=>{
    if(seaChart){seaChart.destroy();}
    const ctx=document.getElementById('seachart').getContext('2d');
    seaChart = new Chart(ctx,{
      type:'line',
      data:{
        labels:arr.map(h=>h.time.slice(11,16)),
        datasets:[
          {label:'Onda (m)',data:arr.map(h=>h.wave_height),borderColor:'#41f8bd',backgroundColor:'rgba(34,255,170,0.10)',fill:true,tension:0.22,pointRadius:2,pointBackgroundColor:'#25A9FA'},
          {label:'Swell (m)',data:arr.map(h=>h.swell_height),borderColor:'#21D08A',backgroundColor:'rgba(34,255,170,0.06)',fill:true,tension:0.18,pointRadius:2,pointBackgroundColor:'#21D08A'}
        ]
      },
      options:{
        responsive:true,maintainAspectRatio:false,
        plugins:{legend:{display:true},tooltip:{enabled:true,mode:'nearest',intersect:false}},
        scales:{y:{beginAtZero:true},x:{}}
      }
    });
  },100);
}

// ------------ Render Pressure ------------
function renderPress(){
  const d = DATA.days[selectedDayIndex];
  const arr = d.hourly_pressures||[];
  const pressMean = calculateMean(arr);
  const pressTrendTxt = pressureTrend(arr);
  document.getElementById("pressbox").innerHTML = `
    <div class="box-title">🔽 Pressione</div>
    <div class="main">Media oggi: <b>${pressMean.toFixed(1)} hPa</b></div>
    <div class="desc">Tendenza: ${pressTrendTxt}</div>
    <button class="detail-btn" onclick="toggleDetail('press-detail')">Dettagli / Grafico</button>
    <div class="detail-section" id="press-detail">
      <div class="chart-wrap"><canvas id="presschart"></canvas></div>
      <div class="fixed-info">
        <span class="info info-press">Max: ${arr.length?Math.max(...arr):"--"} hPa</span>
        <span class="info info-press">Min: ${arr.length?Math.min(...arr):"--"} hPa</span>
      </div>
    </div>
  `;
  setTimeout(()=>{
    if(pressChart){pressChart.destroy();}
    const ctx=document.getElementById('presschart').getContext('2d');
    pressChart = new Chart(ctx,{
      type:'line',
      data:{
        labels:d.hourly_labels||[], 
        datasets:[{label:'Pressione (hPa)',data:arr,borderColor:'#ffd472',backgroundColor:'rgba(255,240,51,0.10)',fill:true,tension:0.22,pointRadius:1}]
      },
      options:{
        responsive:true,maintainAspectRatio:false,
        plugins:{legend:{display:false},tooltip:{enabled:true,mode:'nearest',intersect:false}},
        scales:{y:{beginAtZero:false},x:{}}
      }
    });
  },100);
}

// --- Render MiniCards Giorni --- 
function renderMiniDays(){
  let html="";
  DATA.days.slice(0,7).forEach((d,idx)=>{
    html+=`
      <div class="mini-day${selectedDayIndex==idx?' selected':''}" onclick="selectDay(${idx})">
        <div class="daylabel">${d.day_label} <span class="icon">${d.icon}</span></div>
        <div><span class="tmax">↑ ${d.temp_max}°</span> <span class="tmin">↓ ${d.temp_min}°</span></div>
        <div><span class="wind">💨 ${d.wind_max} km/h</span> <span class="rain">${rainIcon(d.precipitation||0)} ${d.precipitation||0}mm</span></div>
      </div>
    `;
  });
  document.getElementById("miniDaysBox").innerHTML=html;
}

// --- Gestore Selezione Giorno + Propagazione ---
function selectDay(idx){
  selectedDayIndex = idx;
  renderAll();
}

// --- Render Footer ---
function renderFooter(){
  document.getElementById("footer").innerHTML = `Powered by Open-Meteo • UI by micheledv74 • Ultimo agg.: <span id="updated_stamp">${DATA.updated_at}</span>`;
}

// --- Render Messaggi di Consiglio e Alert ---
function renderTodayMessages(){
  const d = DATA;
  let area = document.getElementById('dashboard');
  if(selectedDayIndex === 0){
    area.insertAdjacentHTML('afterbegin',
      `<div class="advice-box">${d.advice||''}</div>
       <div class="alert-box">${d.alerts && d.alerts[0] ? d.alerts[0] : ''}</div>`
    );
  }else{
    let adv = document.querySelector('.advice-box'), al = document.querySelector('.alert-box');
    if(adv) adv.remove(); if(al) al.remove();
  }
}

// --- Render Completo ---
function renderAll(){
  renderMiniDays();
  renderWind();renderRain();renderSea();renderPress();
  renderFooter();
  renderTodayMessages();
}

renderAll();
</script>
</body>
</html>
