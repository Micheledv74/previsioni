// ===================================================================
// EXTRACT DATA FROM INPUT
// ===================================================================
const inputData = $json;
const meteoData = Array.isArray(inputData) ? inputData[0] : inputData;

if (!meteoData || !meteoData.days) {
  throw new Error('‚ùå Dati meteo non validi!');
}

console.log('‚úÖ Generazione HTML con', meteoData.days.length, 'giorni');

// ===================================================================
// HTML TEMPLATE COMPLETO
// ===================================================================
const html = `<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#012549">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <meta name="description" content="Previsioni meteo dettagliate per Procida - Analisi AI multi-fonte">
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Meteo Procida">
  <link rel="icon" type="image/png" href="apple-touch-icon.png">
  
  <title>Meteo Procida - Previsioni 7 Giorni</title>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #012549;
      --secondary: #1a4d7a;
      --accent: #3b82f6;
      --text-primary: #f8fafc;
      --text-secondary: #cbd5e1;
      --bg-card: rgba(255, 255, 255, 0.05);
      --bg-hover: rgba(255, 255, 255, 0.1);
      --border: rgba(255, 255, 255, 0.1);
      --shadow: rgba(0, 0, 0, 0.3);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 30px;
      padding: 20px;
      background: var(--bg-card);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      border: 1px solid var(--border);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo {
      width: 60px;
      height: 60px;
      background: white;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
    }

    .header-info h1 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .header-actions {
      display: flex;
      gap: 10px;
    }

    .icon-btn {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text-primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .icon-btn:hover {
      background: var(--bg-hover);
      transform: translateY(-2px);
    }

    .hero-card {
      padding: 30px;
      background: var(--bg-card);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      border: 1px solid var(--border);
      margin-bottom: 20px;
      text-align: center;
    }

    .temp-display {
      font-size: 72px;
      font-weight: 700;
      margin: 20px 0;
    }

    .weather-icon-large {
      font-size: 120px;
      margin: 20px 0;
    }

    .mini-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .mini-card {
      padding: 20px;
      background: var(--bg-card);
      border-radius: 16px;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }

    .mini-card:hover {
      background: var(--bg-hover);
      transform: translateY(-4px);
    }

    .info-pills {
      display: flex;
      gap: 10px;
      margin: 20px 0;
      flex-wrap: wrap;
      justify-content: center;
    }

    .info-pill {
      padding: 12px 24px;
      background: var(--bg-card);
      border-radius: 20px;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.3s;
    }

    .info-pill:hover {
      background: var(--bg-hover);
      transform: scale(1.05);
    }

    .chart-section {
      margin: 20px 0;
      padding: 20px;
      background: var(--bg-card);
      border-radius: 20px;
      border: 1px solid var(--border);
    }

    .chart-section h3 {
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .stat-card {
      padding: 20px;
      background: var(--bg-card);
      border-radius: 16px;
      border: 1px solid var(--border);
      text-align: center;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 700;
      margin: 10px 0;
    }

    .day-cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .day-card {
      padding: 20px;
      background: var(--bg-card);
      border-radius: 16px;
      border: 1px solid var(--border);
      transition: all 0.3s;
    }

    .day-card:hover {
      background: var(--bg-hover);
      transform: translateY(-4px);
    }

    .popup-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .popup-overlay.active {
      display: flex;
    }

    .popup {
      background: var(--secondary);
      border-radius: 24px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px var(--shadow);
    }

    .popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .popup-header h3 {
      font-size: 24px;
    }

    .close-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--bg-card);
      border: none;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 20px;
    }

    footer {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
      font-size: 14px;
    }

    .notification-toggle {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--accent);
      border: none;
      color: white;
      font-size: 28px;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
      transition: all 0.3s;
      z-index: 999;
    }

    .notification-toggle:hover {
      transform: scale(1.1);
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      header {
        flex-direction: column;
        gap: 15px;
      }
      
      .temp-display {
        font-size: 56px;
      }
      
      .weather-icon-large {
        font-size: 80px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-left">
        <div class="logo">‚òÄÔ∏è</div>
        <div class="header-info">
          <h1>Meteo Procida</h1>
          <div class="subtitle">
            ‚≠ê Previsioni 7 giorni - Analisi AI
          </div>
        </div>
      </div>
      <div class="header-actions">
        <button class="icon-btn" onclick="window.print()" title="Stampa">üìÑ</button>
        <button class="icon-btn" onclick="shareWeather()" title="Condividi">üì§</button>
      </div>
    </header>

    <div id="hero" class="hero-card"></div>

    <div class="mini-cards">
      <div class="mini-card" onclick="showRainPopup()">
        <div style="font-size: 32px;">üíß</div>
        <div id="rain-info">Caricamento...</div>
      </div>
      <div class="mini-card" onclick="showWindPopup()">
        <div style="font-size: 32px;">üí®</div>
        <div id="wind-info">Caricamento...</div>
      </div>
    </div>

    <div class="info-pills">
      <div class="info-pill" onclick="showSummaryPopup()">üìã Riepilogo</div>
      <div class="info-pill" onclick="showAdvicePopup()">üí° Consigli</div>
      <div class="info-pill" onclick="showAlertsPopup()">‚ö†Ô∏è Allerte</div>
    </div>

    <div class="chart-section">
      <h3>üå°Ô∏è Temperature & Precipitazioni - 7 Giorni</h3>
      <canvas id="tempRainChart" height="80"></canvas>
    </div>

    <div class="chart-section">
      <h3>üí® Pressione Atmosferica & Vento</h3>
      <canvas id="pressureWindChart" height="80"></canvas>
    </div>

    <div class="chart-section">
      <h3>üåä Condizioni Meteomarine - 7 Giorni</h3>
      <canvas id="seaChart" height="80"></canvas>
    </div>

    <div class="stats-grid" id="stats"></div>

    <h2 style="margin: 30px 0 20px; text-align: center;">üìÖ Prossimi 6 giorni</h2>
    <div class="day-cards-container" id="forecast"></div>

    <footer>
      <p>Dati aggregati da Open-Meteo, Marine Open-Meteo, Weatherbit, Meteoblue e ilmeteo.it</p>
      <p>Analisi meteorologica professionale powered by AI</p>
      <p id="timestamp">Notifiche: Disattivate</p>
    </footer>
  </div>

  <button class="notification-toggle" onclick="toggleNotifications()">
    <span id="notif-icon">üîî</span>
  </button>

  <!-- Popups -->
  <div id="rainPopup" class="popup-overlay" onclick="closePopup('rainPopup')">
    <div class="popup" onclick="event.stopPropagation()">
      <div class="popup-header">
        <h3>üíß Dettaglio Pioggia</h3>
        <button class="close-btn" onclick="closePopup('rainPopup')">√ó</button>
      </div>
      <canvas id="rainChart" height="200"></canvas>
    </div>
  </div>

  <div id="windPopup" class="popup-overlay" onclick="closePopup('windPopup')">
    <div class="popup" onclick="event.stopPropagation()">
      <div class="popup-header">
        <h3>üí® Dettaglio Vento</h3>
        <button class="close-btn" onclick="closePopup('windPopup')">√ó</button>
      </div>
      <canvas id="windChart" height="200"></canvas>
      <div id="windStats" style="margin-top: 20px;"></div>
    </div>
  </div>

  <div id="summaryPopup" class="popup-overlay" onclick="closePopup('summaryPopup')">
    <div class="popup" onclick="event.stopPropagation()">
      <div class="popup-header">
        <h3>üìã Riepilogo</h3>
        <button class="close-btn" onclick="closePopup('summaryPopup')">√ó</button>
      </div>
      <div id="summaryContent"></div>
    </div>
  </div>

  <div id="advicePopup" class="popup-overlay" onclick="closePopup('advicePopup')">
    <div class="popup" onclick="event.stopPropagation()">
      <div class="popup-header">
        <h3>üí° Consigli</h3>
        <button class="close-btn" onclick="closePopup('advicePopup')">√ó</button>
      </div>
      <div id="adviceContent"></div>
    </div>
  </div>

  <div id="alertsPopup" class="popup-overlay" onclick="closePopup('alertsPopup')">
    <div class="popup" onclick="event.stopPropagation()">
      <div class="popup-header">
        <h3>‚ö†Ô∏è Allerte</h3>
        <button class="close-btn" onclick="closePopup('alertsPopup')">√ó</button>
      </div>
      <div id="alertsContent"></div>
    </div>
  </div>

  <script>
    // ‚úÖ‚úÖ‚úÖ DATI METEO INIETTATI DA N8N ‚úÖ‚úÖ‚úÖ
    const weatherData = ${JSON.stringify(meteoData, null, 2)};
    
    console.log('üìä Weather data loaded:', weatherData);
    console.log('üìÖ Days:', weatherData.days ? weatherData.days.length : 0);
    
    let notificationsEnabled = false;
    let rainChartInstance = null;
    let windChartInstance = null;

    // Render Hero
    function renderHero() {
      if (!weatherData || !weatherData.days || weatherData.days.length === 0) {
        document.getElementById('hero').innerHTML = '<p>‚ùå Dati meteo non disponibili</p>';
        return;
      }

      const today = weatherData.days[0];
      const html = \`
        <div class="weather-icon-large">\${getWeatherIcon(today)}</div>
        <div class="temp-display">\${Math.round(today.temp.max)}¬∞</div>
        <p style="font-size: 18px; color: var(--text-secondary);">\${today.summary || 'Previsioni meteo'}</p>
      \`;
      document.getElementById('hero').innerHTML = html;
      
      document.getElementById('rain-info').innerHTML = \`<strong>\${today.rain.probability}%</strong><br>\${today.rain.total_mm}mm\`;
      const maxWind = Math.max(...today.wind.periods.map(p => p.speed_kmh));
      document.getElementById('wind-info').innerHTML = \`<strong>\${maxWind}km/h</strong><br>Max\`;
    }

    // Render Charts
    function renderCharts() {
      if (!weatherData || !weatherData.days) return;

      const labels = weatherData.days.map(d => new Date(d.date).toLocaleDateString('it-IT', { weekday: 'short', day: 'numeric' }));
      
      new Chart(document.getElementById('tempRainChart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Max ¬∞C',
            data: weatherData.days.map(d => d.temp.max),
            borderColor: '#ef4444',
            backgroundColor: 'rgba(239, 68, 68, 0.1)',
            yAxisID: 'y'
          }, {
            label: 'Min ¬∞C',
            data: weatherData.days.map(d => d.temp.min),
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            yAxisID: 'y'
          }, {
            label: 'Pioggia (mm)',
            data: weatherData.days.map(d => d.rain.total_mm),
            type: 'bar',
            backgroundColor: 'rgba(59, 130, 246, 0.5)',
            yAxisID: 'y1'
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { labels: { color: '#f8fafc' }}},
          scales: {
            y: { type: 'linear', position: 'left', ticks: { color: '#f8fafc' }, grid: { color: 'rgba(255,255,255,0.1)' }},
            y1: { type: 'linear', position: 'right', ticks: { color: '#f8fafc' }, grid: { display: false }},
            x: { ticks: { color: '#f8fafc' }, grid: { color: 'rgba(255,255,255,0.1)' }}
          }
        }
      });

      new Chart(document.getElementById('pressureWindChart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Pressione (hPa)',
            data: weatherData.days.map(d => d.pressure.value_hPa),
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            yAxisID: 'y'
          }, {
            label: 'Vento Max (km/h)',
            data: weatherData.days.map(d => Math.max(...d.wind.periods.map(p => p.speed_kmh))),
            borderColor: '#8b5cf6',
            backgroundColor: 'rgba(139, 92, 246, 0.1)',
            yAxisID: 'y1'
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { labels: { color: '#f8fafc' }}},
          scales: {
            y: { type: 'linear', position: 'left', ticks: { color: '#f8fafc' }, grid: { color: 'rgba(255,255,255,0.1)' }},
            y1: { type: 'linear', position: 'right', ticks: { color: '#f8fafc' }, grid: { display: false }},
            x: { ticks: { color: '#f8fafc' }, grid: { color: 'rgba(255,255,255,0.1)' }}
          }
        }
      });

      if (weatherData.days[0].sea) {
        new Chart(document.getElementById('seaChart'), {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Altezza Onde (m)',
              data: weatherData.days.map(d => d.sea ? d.sea.wave_height_m : 0),
              borderColor: '#06b6d4',
              backgroundColor: 'rgba(6, 182, 212, 0.1)',
              yAxisID: 'y'
            }, {
              label: 'Temp Mare (¬∞C)',
              data: weatherData.days.map(d => d.sea ? d.sea.temperature_c : 0),
              borderColor: '#f59e0b',
              backgroundColor: 'rgba(245, 158, 11, 0.1)',
              yAxisID: 'y1'
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { labels: { color: '#f8fafc' }}},
            scales: {
              y: { type: 'linear', position: 'left', ticks: { color: '#f8fafc' }, grid: { color: 'rgba(255,255,255,0.1)' }},
              y1: { type: 'linear', position: 'right', ticks: { color: '#f8fafc' }, grid: { display: false }},
              x: { ticks: { color: '#f8fafc' }, grid: { color: 'rgba(255,255,255,0.1)' }}
            }
          }
        });
      }
    }

    // Render Stats
    function renderStats() {
      if (!weatherData || !weatherData.weekStats) return;

      const html = \`
        <div class="stat-card">
          <div>üå°Ô∏è Max Settimana</div>
          <div class="stat-value">\${weatherData.weekStats.maxTemp}¬∞</div>
        </div>
        <div class="stat-card">
          <div>‚ùÑÔ∏è Min Settimana</div>
          <div class="stat-value">\${weatherData.weekStats.minTemp}¬∞</div>
        </div>
        <div class="stat-card">
          <div>üìä Media Settimana</div>
          <div class="stat-value">\${weatherData.weekStats.avgTemp}¬∞</div>
        </div>
        <div class="stat-card">
          <div>üíß Giorni Pioggia</div>
          <div class="stat-value">\${weatherData.weekStats.rainyDays}</div>
        </div>
      \`;
      document.getElementById('stats').innerHTML = html;
    }

    // Render Forecast
    function renderForecast() {
      if (!weatherData || !weatherData.days) return;

      const html = weatherData.days.slice(1).map(day => \`
        <div class="day-card">
          <div style="font-size: 14px; color: var(--text-secondary);">
            \${new Date(day.date).toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'short' })}
          </div>
          <div style="font-size: 48px; margin: 10px 0;">\${getWeatherIcon(day)}</div>
          <div style="font-size: 24px; font-weight: 700;">
            \${Math.round(day.temp.max)}¬∞ / \${Math.round(day.temp.min)}¬∞
          </div>
          <div style="margin-top: 10px; font-size: 14px; color: var(--text-secondary);">
            üíß \${day.rain.probability}% - \${day.rain.total_mm}mm<br>
            üí® Max \${Math.max(...day.wind.periods.map(p => p.speed_kmh))}km/h
          </div>
        </div>
      \`).join('');
      document.getElementById('forecast').innerHTML = html;
    }

    // Get Weather Icon
    function getWeatherIcon(day) {
      if (day.rain.total_mm > 5) return 'üåßÔ∏è';
      if (day.rain.total_mm > 0) return 'üå¶Ô∏è';
      return '‚òÄÔ∏è';
    }

    // Show Rain Popup
    function showRainPopup() {
      document.getElementById('rainPopup').classList.add('active');
      
      if (rainChartInstance) rainChartInstance.destroy();
      
      const today = weatherData.days[0];
      const hours = Array.from({length: 24}, (_, i) => \`\${i}:00\`);
      const rainData = new Array(24).fill(0);
      
      today.rain.periods.forEach(period => {
        const start = parseInt(period.start.split(':')[0]);
        const end = parseInt(period.end.split(':')[0]);
        const intensity = period.intensity === 'forte' ? 10 : period.intensity === 'moderata' ? 5 : 2;
        for (let h = start; h <= end; h++) {
          if (h < 24) rainData[h] = intensity;
        }
      });

      rainChartInstance = new Chart(document.getElementById('rainChart'), {
        type: 'bar',
        data: {
          labels: hours,
          datasets: [{
            label: 'Intensit√† Pioggia (mm/h)',
            data: rainData,
            backgroundColor: 'rgba(59, 130, 246, 0.6)',
            borderColor: '#3b82f6',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { labels: { color: '#f8fafc' }}},
          scales: {
            y: { ticks: { color: '#f8fafc' }, grid: { color: 'rgba(255,255,255,0.1)' }},
            x: { ticks: { color: '#f8fafc' }, grid: { color: 'rgba(255,255,255,0.1)' }}
          }
        }
      });
    }

    // Show Wind Popup
    function showWindPopup() {
      document.getElementById('windPopup').classList.add('active');
      
      if (windChartInstance) windChartInstance.destroy();
      
      const today = weatherData.days[0];
      const hours = today.wind.periods.map(p => p.time);
      const speeds = today.wind.periods.map(p => p.speed_kmh);

      windChartInstance = new Chart(document.getElementById('windChart'), {
        type: 'line',
        data: {
          labels: hours,
          datasets: [{
            label: 'Velocit√† Vento (km/h)',
            data: speeds,
            borderColor: '#8b5cf6',
            backgroundColor: 'rgba(139, 92, 246, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { labels: { color: '#f8fafc' }}},
          scales: {
            y: { ticks: { color: '#f8fafc' }, grid: { color: 'rgba(255,255,255,0.1)' }},
            x: { ticks: { color: '#f8fafc' }, grid: { color: 'rgba(255,255,255,0.1)' }}
          }
        }
      });

      const maxSpeed = Math.max(...speeds);
      const avgSpeed = Math.round(speeds.reduce((a,b) => a+b, 0) / speeds.length);
      document.getElementById('windStats').innerHTML = \`
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center;">
          <div>
            <div style="font-size: 12px; color: var(--text-secondary);">Max</div>
            <div style="font-size: 24px; font-weight: 700;">\${maxSpeed} km/h</div>
          </div>
          <div>
            <div style="font-size: 12px; color: var(--text-secondary);">Media</div>
            <div style="font-size: 24px; font-weight: 700;">\${avgSpeed} km/h</div>
          </div>
        </div>
      \`;
    }

    // Show Popups
    function showSummaryPopup() {
      document.getElementById('summaryPopup').classList.add('active');
      const today = weatherData.days[0];
      document.getElementById('summaryContent').innerHTML = \`<p style="font-size: 16px; line-height: 1.8;">\${today.summary}</p>\`;
    }

    function showAdvicePopup() {
      document.getElementById('advicePopup').classList.add('active');
      const today = weatherData.days[0];
      const html = today.advice.map(adv => \`<p style="padding: 15px; background: var(--bg-card); border-radius: 12px; margin: 10px 0;">\${adv}</p>\`).join('');
      document.getElementById('adviceContent').innerHTML = html;
    }

    function showAlertsPopup() {
      document.getElementById('alertsPopup').classList.add('active');
      const today = weatherData.days[0];
      const html = today.alerts.length > 0 
        ? today.alerts.map(alert => \`<p style="padding: 15px; background: rgba(239, 68, 68, 0.2); border-radius: 12px; margin: 10px 0; border-left: 4px solid #ef4444;">\${alert}</p>\`).join('')
        : '<p>‚úÖ Nessuna allerta meteo attiva</p>';
      document.getElementById('alertsContent').innerHTML = html;
    }

    // Close Popup
    function closePopup(id) {
      document.getElementById(id).classList.remove('active');
    }

    // Toggle Notifications
    function toggleNotifications() {
      notificationsEnabled = !notificationsEnabled;
      document.getElementById('notif-icon').textContent = notificationsEnabled ? 'üîï' : 'üîî';
      document.getElementById('timestamp').textContent = 'Notifiche: ' + (notificationsEnabled ? 'Attivate' : 'Disattivate');
    }

    // Share Weather
    function shareWeather() {
      if (navigator.share) {
        navigator.share({
          title: 'Meteo Procida',
          text: weatherData.days[0].summary,
          url: window.location.href
        });
      } else {
        alert('Condivisione non supportata su questo dispositivo');
      }
    }

    // Update Timestamp
    function updateTimestamp() {
      const now = new Date(weatherData.generated_at).toLocaleString('it-IT');
      document.getElementById('timestamp').innerHTML += \`<br>Ultimo aggiornamento: \${now}\`;
    }

    // Initialize
    if (weatherData && weatherData.days && weatherData.days.length > 0) {
      console.log('‚úÖ Inizializzazione UI con', weatherData.days.length, 'giorni');
      renderHero();
      renderCharts();
      renderStats();
      renderForecast();
      updateTimestamp();
    } else {
      console.error('‚ùå Weather data non valido:', weatherData);
      document.body.innerHTML = '<div style="text-align:center; margin-top: 50px; padding: 20px;"><h1 style="color:#ef4444;">‚ùå Errore Dati Meteo</h1><p>Impossibile caricare le previsioni. Riprova pi√π tardi.</p></div>';
    }
  </script>
</body>
</html>`;

// ===================================================================
// RETURN HTML
// ===================================================================
return [{
  json: {
    content: html
  }
}];
