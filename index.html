// ===================================================================
// NODO HTML - TUO VECCHIO HTML FUNZIONANTE + FIX INJECTION
// ===================================================================

const inputData = $json;
const meteoData = Array.isArray(inputData) ? inputData[0] : inputData;

if (!meteoData || !meteoData.days) {
  throw new Error('‚ùå Dati meteo mancanti! Verifica collegamento con "Add Air Quality to Final"');
}

console.log('‚úÖ Dati meteo:', meteoData.days.length, 'giorni');

// ‚úÖ FIX: Escape JSON per evitare syntax error
const weatherDataJSON = JSON.stringify(meteoData)
  .replace(/</g, '\\u003c')
  .replace(/>/g, '\\u003e');

const html = \`<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#012549">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <meta name="description" content="Previsioni meteo dettagliate per Procida - Analisi AI multi-fonte">
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Meteo Procida">
  <link rel="icon" type="image/png" href="apple-touch-icon.png">
  
  <title>Meteo Procida - Previsioni 7 Giorni</title>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"><\/script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary-blue: #012549;
      --primary-blue-light: #003d6b;
      --accent-orange: #faa202;
      --accent-cyan: #08a5e8;
      --bg-gradient-start: #012549;
      --bg-gradient-end: #003d6b;
      --card-bg: rgba(255, 255, 255, 0.1);
      --card-border: rgba(255, 255, 255, 0.2);
      --text-primary: #ffffff;
      --text-secondary: #a0c4d8;
      --text-tertiary: #6b8ca8;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 0;
      margin: 0;
      line-height: 1.6;
      overflow-x: hidden;
    }
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      margin-bottom: 30px;
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      border: 1px solid var(--card-border);
    }
    .header-left { display: flex; align-items: center; gap: 15px; }
    .logo {
      width: 70px;
      height: 70px;
      background: white;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .logo img { width: 100%; height: 100%; object-fit: contain; }
    .header-info h1 {
      font-size: 28px;
      font-weight: 700;
      margin: 0 0 5px 0;
      color: var(--text-primary);
    }
    .subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .header-actions { display: flex; gap: 10px; }
    .icon-btn {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      color: var(--text-primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      font-size: 24px;
    }
    .icon-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }
    .section {
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 25px;
      border: 1px solid var(--card-border);
    }
    .section h2 {
      font-size: 22px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text-primary);
    }
    canvas { width: 100% !important; height: auto !important; }
    @media (max-width: 768px) {
      .container { padding: 10px; }
      header { flex-direction: column; gap: 15px; text-align: center; }
      .header-left { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-left">
        <div class="logo">
          <img src="apple-touch-icon.png" alt="Meteo Procida">
        </div>
        <div class="header-info">
          <h1>Meteo Procida</h1>
          <div class="subtitle">‚≠ê Previsioni 7 giorni - Analisi AI</div>
        </div>
      </div>
      <div class="header-actions">
        <button class="icon-btn" onclick="window.print()" title="Stampa">üìÑ</button>
        <button class="icon-btn" onclick="shareWeather()" title="PDF">üì§</button>
      </div>
    </header>

    <div id="app"></div>

    <footer style="text-align: center; padding: 40px 20px; color: var(--text-secondary); font-size: 14px;">
      <p>Dati aggregati da Open-Meteo, Marine Open-Meteo, Weatherbit, Meteoblue e ilmeteo.it</p>
      <p>Analisi meteorologica professionale powered by AI</p>
      <p id="timestamp">Notifiche: Disattivate</p>
    </footer>
  </div>

  <button class="icon-btn" onclick="toggleNotifications()" style="position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--accent-cyan); box-shadow: 0 4px 20px rgba(8, 165, 232, 0.4); z-index: 999;">
    <span id="notif-icon">üîî</span>
  </button>

  <script>
    // ‚úÖ‚úÖ‚úÖ DATI INIETTATI DA N8N - FIXED! ‚úÖ‚úÖ‚úÖ
    const weatherData = \${weatherDataJSON};
    
    console.log('‚úÖ Weather data caricato:', weatherData);
    
    let notificationsEnabled = false;

    function renderApp() {
      if (!weatherData || !weatherData.days) {
        document.getElementById('app').innerHTML = \`
          <div class="section" style="text-align: center; padding: 60px 20px;">
            <h2 style="color: #ef4444;">‚ö†Ô∏è Errore nel caricamento dei dati</h2>
            <p style="color: var(--text-secondary);">Impossibile recuperare le previsioni meteo. Riprova pi√π tardi.</p>
          </div>
        \`;
        return;
      }

      const today = weatherData.days[0];
      const tempMax = Math.round(today.temp.max);
      const tempMin = Math.round(today.temp.min);
      const icon = today.rain && today.rain.total_mm > 5 ? 'üåßÔ∏è' : today.rain && today.rain.total_mm > 0 ? 'üå¶Ô∏è' : '‚òÄÔ∏è';
      
      document.getElementById('app').innerHTML = \`
        <div class="section" style="text-align: center;">
          <div style="font-size: 120px; margin: 20px 0;">\${icon}</div>
          <div style="font-size: 72px; font-weight: 700; margin: 20px 0;">\${tempMax}¬∞</div>
          <div style="font-size: 24px; color: var(--accent-cyan); margin-bottom: 20px;">\${tempMin}¬∞</div>
          <p style="font-size: 18px; color: var(--text-secondary);">\${today.summary || 'Previsioni meteo per Procida'}</p>
        </div>

        <div class="section">
          <h2>üå°Ô∏è Temperature & Precipitazioni - 7 Giorni</h2>
          <canvas id="tempChart" height="100"></canvas>
        </div>

        <div class="section">
          <h2>üí® Pressione Atmosferica & Vento</h2>
          <canvas id="pressureChart" height="100"></canvas>
        </div>

        <div class="section">
          <h2>üåä Condizioni Meteomarine - 7 Giorni</h2>
          <canvas id="seaChart" height="100"></canvas>
        </div>

        <div class="section">
          <h2>üìÖ Prossimi 6 giorni</h2>
          <div id="forecast"></div>
        </div>
      \`;

      renderCharts();
      renderForecast();
      updateTimestamp();
    }

    function renderCharts() {
      const labels = weatherData.days.map(d => {
        const date = new Date(d.date);
        return date.toLocaleDateString('it-IT', { weekday: 'short', day: 'numeric' });
      });

      // Temperature Chart
      new Chart(document.getElementById('tempChart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Temp Max (¬∞C)',
            data: weatherData.days.map(d => d.temp.max),
            borderColor: '#faa202',
            backgroundColor: 'rgba(250, 162, 2, 0.1)',
            tension: 0.4,
            yAxisID: 'y'
          }, {
            label: 'Temp Min (¬∞C)',
            data: weatherData.days.map(d => d.temp.min),
            borderColor: '#08a5e8',
            backgroundColor: 'rgba(8, 165, 232, 0.1)',
            tension: 0.4,
            yAxisID: 'y'
          }, {
            label: 'Pioggia (mm)',
            data: weatherData.days.map(d => d.rain.total_mm),
            type: 'bar',
            backgroundColor: 'rgba(8, 165, 232, 0.5)',
            yAxisID: 'y1'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { labels: { color: '#ffffff' }}},
          scales: {
            y: { type: 'linear', position: 'left', ticks: { color: '#ffffff' }, grid: { color: 'rgba(255,255,255,0.1)' }},
            y1: { type: 'linear', position: 'right', ticks: { color: '#ffffff' }, grid: { display: false }},
            x: { ticks: { color: '#ffffff' }, grid: { color: 'rgba(255,255,255,0.1)' }}
          }
        }
      });

      // Pressure Chart
      new Chart(document.getElementById('pressureChart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Pressione (hPa)',
            data: weatherData.days.map(d => d.pressure.value_hPa),
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            tension: 0.4,
            yAxisID: 'y'
          }, {
            label: 'Vento Max (km/h)',
            data: weatherData.days.map(d => Math.max(...d.wind.periods.map(p => p.speed_kmh))),
            borderColor: '#faa202',
            backgroundColor: 'rgba(250, 162, 2, 0.1)',
            tension: 0.4,
            yAxisID: 'y1'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { labels: { color: '#ffffff' }}},
          scales: {
            y: { type: 'linear', position: 'left', ticks: { color: '#ffffff' }, grid: { color: 'rgba(255,255,255,0.1)' }},
            y1: { type: 'linear', position: 'right', ticks: { color: '#ffffff' }, grid: { display: false }},
            x: { ticks: { color: '#ffffff' }, grid: { color: 'rgba(255,255,255,0.1)' }}
          }
        }
      });

      // Sea Chart
      if (weatherData.days[0].sea) {
        new Chart(document.getElementById('seaChart'), {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Altezza Onde (m)',
              data: weatherData.days.map(d => d.sea ? d.sea.wave_height_m : 0),
              borderColor: '#08a5e8',
              backgroundColor: 'rgba(8, 165, 232, 0.1)',
              tension: 0.4,
              yAxisID: 'y'
            }, {
              label: 'Temp Mare (¬∞C)',
              data: weatherData.days.map(d => d.sea ? d.sea.temperature_c : 0),
              borderColor: '#faa202',
              backgroundColor: 'rgba(250, 162, 2, 0.1)',
              tension: 0.4,
              yAxisID: 'y1'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#ffffff' }}},
            scales: {
              y: { type: 'linear', position: 'left', ticks: { color: '#ffffff' }, grid: { color: 'rgba(255,255,255,0.1)' }},
              y1: { type: 'linear', position: 'right', ticks: { color: '#ffffff' }, grid: { display: false }},
              x: { ticks: { color: '#ffffff' }, grid: { color: 'rgba(255,255,255,0.1)' }}
            }
          }
        });
      }
    }

    function renderForecast() {
      const forecastHTML = weatherData.days.slice(1).map(day => {
        const date = new Date(day.date);
        const dateStr = date.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'short' });
        const tempMax = Math.round(day.temp.max);
        const tempMin = Math.round(day.temp.min);
        const icon = day.rain && day.rain.total_mm > 5 ? 'üåßÔ∏è' : day.rain && day.rain.total_mm > 0 ? 'üå¶Ô∏è' : '‚òÄÔ∏è';
        const maxWind = Math.max(...day.wind.periods.map(p => p.speed_kmh));
        
        return \`
          <div style="padding: 20px; background: rgba(255,255,255,0.05); border-radius: 16px; margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <div style="font-size: 18px; font-weight: 600; text-transform: capitalize;">\${dateStr}</div>
              <div style="font-size: 24px; font-weight: 700; color: #faa202;">\${tempMax}¬∞ <span style="color: #08a5e8;">\${tempMin}¬∞</span></div>
            </div>
            <div style="font-size: 48px; text-align: center; margin: 15px 0;">\${icon}</div>
            <p style="color: var(--text-secondary); margin-bottom: 15px; min-height: 50px;">\${day.summary || ''}</p>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center;">
              <div><div>üíß</div><div style="font-weight: 700; margin: 5px 0;">\${day.rain.probability}%</div><div style="font-size: 12px;">\${day.rain.total_mm}mm</div></div>
              <div><div>üí®</div><div style="font-weight: 700; margin: 5px 0;">\${maxWind}</div><div style="font-size: 12px;">km/h</div></div>
              <div><div>üíß</div><div style="font-weight: 700; margin: 5px 0;">\${day.humidity}%</div><div style="font-size: 12px;">Umidit√†</div></div>
            </div>
          </div>
        \`;
      }).join('');
      
      document.getElementById('forecast').innerHTML = forecastHTML;
    }

    function toggleNotifications() {
      notificationsEnabled = !notificationsEnabled;
      document.getElementById('notif-icon').textContent = notificationsEnabled ? 'üîï' : 'üîî';
      document.getElementById('timestamp').textContent = 'Notifiche: ' + (notificationsEnabled ? 'Attivate' : 'Disattivate');
    }

    function shareWeather() {
      if (navigator.share) {
        navigator.share({
          title: 'Meteo Procida',
          text: weatherData.days[0].summary,
          url: window.location.href
        });
      } else {
        window.print();
      }
    }

    function updateTimestamp() {
      const now = new Date(weatherData.generated_at).toLocaleString('it-IT');
      document.getElementById('timestamp').innerHTML += '<br>Ultimo aggiornamento: ' + now;
    }

    // Initialize
    try {
      renderApp();
      console.log('‚úÖ App inizializzata con successo');
    } catch (error) {
      console.error('‚ùå Errore inizializzazione:', error);
      document.getElementById('app').innerHTML = \`
        <div class="section" style="text-align: center; padding: 60px 20px;">
          <h2 style="color: #ef4444;">‚ö†Ô∏è Errore nel caricamento dei dati</h2>
          <p style="color: var(--text-secondary);">Impossibile recuperare le previsioni meteo. Riprova pi√π tardi.</p>
        </div>
      \`;
    }
  <\/script>
</body>
</html>\`;

return [{ json: { content: html }}];
