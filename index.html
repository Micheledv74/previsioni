<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#012549">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <meta name="description" content="Previsioni meteo dettagliate per Procida - Analisi AI multi-fonte">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Meteo Procida">
  <link rel="icon" type="image/png" href="apple-touch-icon.png">
  <title>Meteo Procida - Previsioni 7 Giorni</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    /* Tuo CSS originale rimane invariato qui (riporto solo le prime righe per esempio) */
    body {margin:0;padding:0;box-sizing:border-box;}
    /* ... segue tutto il CSS originale paste.txt ... */
  </style>
</head>
<body>
  <div class="container" id="main-box">
    <!-- Tutti i contenuti, grafici e modali vengono renderizzati automaticamente dal JS in fondo -->
    <header class="main-header">
      <div class="logo-title">
        <img src="apple-touch-icon.png" width="54" height="54" alt="Logo" />
        <div>
          <div class="title">Meteo Procida</div>
          <div class="subtitle">Previsioni 7 giorni Â· Analisi AI</div>
        </div>
      </div>
      <div class="nav-tools">
        <button class="pdf-btn" onclick="window.print()" title="Stampa/PDF">PDF</button>
        <button class="share-btn" onclick="shareForecast()" title="Condividi">ðŸ”—</button>
      </div>
    </header>

    <!-- Tab navigazione -->
    <nav class="tabs">
      <button class="tab-btn active" id="tab-summary" onclick="showTab('summary')">Riepilogo</button>
      <button class="tab-btn" id="tab-advices" onclick="showTab('advices')">Consigli AI</button>
      <button class="tab-btn" id="tab-alerts" onclick="showTab('alerts')">Allerte</button>
      <button class="tab-btn" id="tab-daily" onclick="showTab('daily')">7 Giorni</button>
      <button class="tab-btn" id="tab-charts" onclick="showTab('charts')">Grafici</button>
    </nav>

    <!-- Container dei contenuti tab -->
    <div id="tab-content">
      <!-- Ogni tab viene riempito dal JS -->
    </div>
    <!-- MODALI/PPOPUP dinamici -->
    <div id="modal-bg" class="modal-bg" style="display:none;"></div>
    <div id="modal" class="modal" style="display:none;">
      <div id="modal-content" class="modal-content"></div>
      <button id="close-modal" class="close-modal" onclick="closeModal()">Ã—</button>
    </div>

    <!-- Tooltip AI (se usato nel template) -->
    <div id="ai-tooltip" class="ai-tooltip" style="display:none;"></div>

    <footer class="footer">
      <div>
        Dati aggregati da Open-Meteo, Marine Open-Meteo, Weatherbit, Meteoblue e ilmeteo.it<br>
        Analisi meteorologica professionale powered by AI<br>
        Ultimo aggiornamento: <span id="last-update"></span>
      </div>
    </footer>
  <script>
    // Inserisci qui il tuo oggetto weatherData completo (dall'output Code n8n, con .ai)
    const weatherData = window.weatherData || /* fetch dei dati reali da backend! */ {};

    // Aggiorna timestamp ultimo aggiornamento (footer)
    document.addEventListener("DOMContentLoaded", function() {
      const ts = weatherData?.generated_at || weatherData?.generatedAt || "";
      if (ts) document.getElementById("last-update").textContent = ts.replace("T", " ").substring(0,19);
    });

    // --- Funzione rendering AI agent ---
    function renderAISummaryAdviceAlerts(aiBlock) {
      if (!aiBlock) return '';
      const summary = aiBlock.summary || '';
      const adviceArr = Array.isArray(aiBlock.advice) ? aiBlock.advice : [];
      const alertsArr = Array.isArray(aiBlock.alerts) ? aiBlock.alerts : [];
      let html = '';
      if (summary) html += `<div class="ai-summary">${summary}</div>`;
      if (adviceArr.length) {
        html += `<ul class="ai-advice">`;
        adviceArr.forEach(c => html += `<li>${c}</li>`);
        html += `</ul>`;
      }
      if (alertsArr.length) {
        html += `<div class="ai-alerts">`;
        alertsArr.forEach(a => {
          const radarMatch = a.match(/\[(https[^\]]+)\]/);
          let txt = a.replace(/\[https[^\]]+\]/, "").trim();
          let link = radarMatch ? radarMatch[1] : null;
          html += `<div class="ai-alert">${txt}${link ? ` <button onclick="window.open('${link}')">Radar</button>` : ""}</div>`;
        });
        html += `</div>`;
      }
      return html;
    }

    // --- Tab management ---
    function showTab(tab) {
      document.querySelectorAll(".tab-btn").forEach(e => e.classList.remove("active"));
      document.getElementById("tab-" + tab).classList.add("active");
      renderTabContent(tab);
    }

    function renderTabContent(tab) {
      let html = '';
      if (!weatherData || Object.keys(weatherData).length === 0) {
        html = `<div class="error-box">Errore caricamento dati meteo.<br>Verifica la pipeline n8n e riprova.</div>`;
        document.getElementById("tab-content").innerHTML = html;
        return;
      }
      if (tab === "summary") {
        html += `<h2>Riepilogo</h2>`;
        html += renderAISummaryAdviceAlerts(weatherData.ai);
        html += `<div class="card"><div class="forecast-date">${weatherData.days?.[0]?.date || ""}</div>
                   <div class="forecast-summary">${weatherData.days?.[0]?.summary || ""}</div></div>`;
      } else if (tab === "advices") {
        html += `<h2>Consigli AI</h2>`;
        html += renderAISummaryAdviceAlerts({
          advice: weatherData.ai?.advice || weatherData.days?.[0]?.advice
        });
      } else if (tab === "alerts") {
        html += `<h2>Allerte AI & Meteo</h2>`;
        html += renderAISummaryAdviceAlerts({
          alerts: weatherData.ai?.alerts || weatherData.days?.[0]?.alerts
        });
      } else if (tab === "daily") {
        html += `<h2>Previsioni 7 Giorni</h2>`;
        html += `<table class="weather-table">
        <tr>
          <th>Data</th>
          <th>Temp Max</th>
          <th>Temp Min</th>
          <th>Pioggia</th>
          <th>Vento max</th>
          <th>Allerta</th>
        </tr>`;
        (weatherData.days || []).forEach(day => {
          html += `<tr>
            <td>${day.date || ''}</td>
            <td>${day.temp?.max || '-'}Â°C</td>
            <td>${day.temp?.min || '-'}Â°C</td>
            <td>${day.rain?.total_mm || '0'}mm (${day.rain?.probability || '-'}%)</td>
            <td>${(day.wind?.periods || []).reduce((a,b)=>Math.max(a,b.speed_kmh),0) || '-'}km/h</td>
            <td>${day.alerts?.length ? day.alerts.join("<br>") : '-'}</td>
          </tr>`;
        });
        html += `</table>`;
      } else if (tab === "charts") {
        html += `<h2>Grafici Meteo</h2>`;
        html += `<canvas id="chart-1" width="800" height="300"></canvas>`;
        // Puoi aggiungere qui logica Chart.js per pressione, pioggia, vento ecc.
      }
      document.getElementById("tab-content").innerHTML = html;
      // Aggiorna grafici se tab == "charts"
      if (tab === "charts") renderCharts();
    }

    // Setup charts (esempio)
    function renderCharts() {
      // ... chart rendering usando (weatherData.days)
    }

    // Setup tab e rendering iniziale
    document.addEventListener("DOMContentLoaded", function() {
      showTab('summary');
    });

    // Modal management
    function openModal(content) {
      document.getElementById("modal-content").innerHTML = content;
      document.getElementById("modal-bg").style.display = "block";
      document.getElementById("modal").style.display = "block";
    }
    function closeModal() {
      document.getElementById("modal-bg").style.display = "none";
      document.getElementById("modal").style.display = "none";
    }

    // Condivisione semplice
    function shareForecast() {
      navigator.clipboard.writeText(document.location.href + "\nPrevisioni AI Meteo Procida");
      alert("Link condiviso negli appunti!");
    }
  </script>
</body>
</html>

