// ===================================================================
// NODO HTML - FIX SYNTAX ERROR
// ===================================================================

const inputData = $json;
const meteoData = Array.isArray(inputData) ? inputData[0] : inputData;

if (!meteoData || !meteoData.days) {
  throw new Error('Dati meteo mancanti!');
}

console.log('Dati meteo:', meteoData.days.length, 'giorni');

// ‚ö†Ô∏è ESCAPE: Sostituisci caratteri problematici
const weatherDataJSON = JSON.stringify(meteoData)
  .replace(/\\/g, '\\\\')   // Escape backslash
  .replace(/'/g, "\\'")     // Escape apici singoli
  .replace(/"/g, '\\"')     // Escape apici doppi
  .replace(/\n/g, '\\n')    // Escape newline
  .replace(/\r/g, '\\r');   // Escape carriage return

const html = "<!DOCTYPE html><html lang=\"it\"><head><meta charset=\"UTF-8\"><meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"><title>Meteo Procida</title><script src=\"https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js\"></script><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,\"Segoe UI\",sans-serif;background:linear-gradient(135deg,#012549 0%,#003d6b 100%);color:#fff;min-height:100vh;padding:20px}.container{max-width:1200px;margin:0 auto}h1{text-align:center;margin:30px 0}</style></head><body><div class=\"container\"><h1>Meteo Procida ‚õÖ</h1><div id=\"app\">Caricamento...</div></div><script>const weatherData=" + weatherDataJSON + ";console.log('Weather data:',weatherData);if(!weatherData||!weatherData.days){document.getElementById('app').innerHTML='<p style=\"color:red;\">Errore: dati non validi</p>'}else{const today=weatherData.days[0];const temp=Math.round(today.temp.max);const icon=today.rain&&today.rain.total_mm>5?'üåßÔ∏è':'‚òÄÔ∏è';const summary=today.summary||'Previsioni meteo';document.getElementById('app').innerHTML='<div style=\"background:rgba(255,255,255,0.1);padding:30px;border-radius:20px;text-align:center\"><div style=\"font-size:80px\">'+icon+'</div><div style=\"font-size:60px;margin:20px 0\">'+temp+'¬∞</div><p>'+summary+'</p></div>'}</script></body></html>";

return [{ json: { content: html }}];
