// ===================================================================
// SOLUZIONE BRUTALE MA FUNZIONANTE
// ===================================================================

const inputData = $json;
const meteoData = Array.isArray(inputData) ? inputData[0] : inputData;

if (!meteoData || !meteoData.days) {
  throw new Error('Dati meteo mancanti!');
}

// ✅ CONVERTI IN STRINGA E FAI REPLACE MANUALE DI CARATTERI SPECIALI
let weatherDataJSON = JSON.stringify(meteoData);
weatherDataJSON = weatherDataJSON.replace(/</g, '&lt;').replace(/>/g, '&gt;');

const html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Meteo</title></head><body><script id="data" type="application/json">' + weatherDataJSON + '</script><div id="app"></div><script>var d=JSON.parse(document.getElementById("data").textContent.replace(/&lt;/g,"<").replace(/&gt;/g,">"));if(d&&d.days){var t=d.days[0];document.getElementById("app").innerHTML="<h1>"+Math.round(t.temp.max)+"° - "+(t.summary||"Meteo")+"</h1>"}else{document.getElementById("app").innerHTML="Errore"}</script></body></html>';

return [{ json: { content: html }}];
