<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Previsioni Procida - Meteo MultiFonte & AI</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/weather-icons/2.0.12/css/weather-icons.min.css">
  <style>
    /* ... il CSS dal template precedente ... */
  </style>
</head>
<body>
  <div class="header">PREVISIONI METEO PROCIDA <i class="wi wi-day-sunny"></i> MultiFonte & AI</div>
  <div class="mini-days" id="miniDaysBox"></div>
  <button class="det-btn" onclick="document.getElementById('aiPopup').style.display='block'">
    <i class="wi wi-forecast-io-partly-cloudy-day icon"></i> Sintesi e Dettaglio AI
  </button>
  <div id="aiPopup" role="dialog" aria-labelledby="aiTitle">
    <div class="mod-content">
      <button class="close" title="Chiudi" onclick="document.getElementById('aiPopup').style.display='none'">&times;</button>
      <h2 id="aiTitle">Sintesi AI Multi-Sorgente</h2>
      <div id="ai-popup-content">undefined</div>
    </div>
  </div>
  <div class="dashboard">
    <section class="box vento" id="windbox"></section>
    <section class="box pioggia" id="rainbox"></section>
    <section class="box mare" id="seabox"></section>
    <section class="box pressione" id="pressbox"></section>
  </div>
  <div class="footer">Powered by n8n + Gemini & fonti meteo â€¢ Ultimo aggiornamento: <span id="updated_stamp"></span></div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const DATA = undefined;

    function windDirName(deg){
      const w=["N","NE","E","SE","S","SO","O","NO"];
      return w[Math.round((deg%360)/45)%8]||"N/D";
    }

    let sel = 0;
    function renderMiniDays(){
      document.getElementById("miniDaysBox").innerHTML =
        DATA.days.map((d,i)=>
          `<div class="mini-day${i===sel?" active":""}" onclick="selectDay(${i})">
             <span class="icon"><i class="wi ${d.icon}"></i></span>${d.day_label}
           </div>`
        ).join("");
    }
    function selectDay(i){ sel=i; renderAll(); }

    function toggleDetail(id){
      document.querySelectorAll(".detail-section")
        .forEach(e=> e.id!==id? e.style.display="none": null);
      const el=document.getElementById(id);
      el.style.display = el.style.display==="block"? "none":"block";
    }

    function renderWind(){
      const d=DATA.days[sel]||{};
      document.getElementById("windbox").innerHTML = `
        <div class="box-title"><i class="wi wi-strong-wind"></i> Vento</div>
        <div class="summ"><i class="wi wi-wind-direction wi-from-${d.wind_dir||0}-deg"></i>
          ${d.wind_max||"--"} km/h (${windDirName(d.wind_dir)})<br>Folata max: ${d.wind_gust||"--"} km/h
        </div>
        <button class="det-btn" onclick="toggleDetail('wind-detail')">Dettagli / Grafico</button>
        <div class="detail-section" id="wind-detail"><canvas id="windchart"></canvas></div>`;
      setTimeout(()=>{
        if(d.hourly_winds){
          new Chart(document.getElementById("windchart"),{
            type:"line",
            data:{labels:d.hourly_labels,datasets:[{data:d.hourly_winds,borderColor:"#66E5FF",backgroundColor:"rgba(90,184,255,0.09)",fill:true}]},
            options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
          });
        }
      },300);
    }

    function renderRain(){
      const d=DATA.days[sel]||{};
      document.getElementById("rainbox").innerHTML = `
        <div class="box-title"><i class="wi wi-rain"></i> Pioggia</div>
        <div class="summ">${d.precipitation||"--"} mm</div>
        <button class="det-btn" onclick="toggleDetail('rain-detail')">Dettagli / Grafico</button>
        <div class="detail-section" id="rain-detail"><canvas id="rainchart"></canvas></div>`;
      setTimeout(()=>{
        if(d.hourly_precips){
          new Chart(document.getElementById("rainchart"),{
            type:"bar",
            data:{labels:d.hourly_labels,datasets:[{data:d.hourly_precips,backgroundColor:"#52c5f7"}]},
            options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
          });
        }
      },300);
    }

    function renderSea(){
      document.getElementById("seabox").innerHTML = `
        <div class="box-title"><i class="wi wi-waves"></i> Mare</div>
        <div class="summ">N/D</div>
        <button class="det-btn" onclick="toggleDetail('sea-detail')">Dettagli / Grafico</button>
        <div class="detail-section" id="sea-detail"></div>`;
    }

    function renderPress(){
      const d=DATA.days[sel]||{};
      const arr=d.hourly_pressures||[];
      const avg=arr.length? Math.round(arr.reduce((a,b)=>a+b,0)/arr.length):"--";
      document.getElementById("pressbox").innerHTML = `
        <div class="box-title"><i class="wi wi-barometer"></i> Pressione</div>
        <div class="summ">${avg} hPa</div>
        <button class="det-btn" onclick="toggleDetail('press-detail')">Dettagli / Grafico</button>
        <div class="detail-section" id="press-detail"><canvas id="presschart"></canvas></div>`;
      setTimeout(()=>{
        if(arr.length){
          new Chart(document.getElementById("presschart"),{
            type:"line",
            data:{labels:d.hourly_labels,datasets:[{data:arr,borderColor:"#ffd472",backgroundColor:"rgba(255,240,51,0.10)",fill:true}]},
            options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:false}}}
          });
        }
      },300);
    }

    function renderAll(){
      renderMiniDays();
      renderWind();
      renderRain();
      renderSea();
      renderPress();
    }

    renderAll();
    document.getElementById("updated_stamp").innerText =
      new Date().toLocaleString("it-IT",{dateStyle:"short",timeStyle:"medium"});
  </script>
</body>
</html>
