<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes" />
  <title>Previsioni Procida - Dashboard Meteo</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Roboto&display=swap');
    html { box-sizing: border-box;} *,*:before,*:after { box-sizing: inherit; }
    body { font-family: 'Roboto', Arial, sans-serif; max-width: 1000px; margin: 0 auto; background: linear-gradient(135deg, #26365a, #3498db 92%); color: #f0f8ff; padding: 14px 2px 18px 2px; overflow-x: hidden; min-height: 100vh; }
    .header { font-family: 'Montserrat', sans-serif; font-size: 2.45em; font-weight: 900; text-align: center; color: #cfe9ff; text-shadow: 1px 2px 14px #09172a; letter-spacing: 2px; user-select: none; margin-bottom: 19px; }
    .dashboard { display: flex; flex-wrap: wrap; gap: 19px; justify-content: center; }
    .box { background: rgba(37,59,102,0.22); border-radius: 18px; box-shadow: 0 5px 26px #06214672; padding: 16px 14px 36px 14px; flex: 1 1 310px; max-width: 410px; min-width: 215px; display: flex; flex-direction: column; align-items: center; margin-bottom: 13px; position: relative;}
    .box-title { font-size: 1.17rem; font-weight: 900; color: #a9edff; letter-spacing: 1px; margin-bottom: 11px; font-family: 'Montserrat', sans-serif; }
    .box .main { font-weight: 700; font-size: 1.11em; color:#84dbff;}
    .box .desc { margin: 2px 0 0 0; font-size:1.01em; color:#c3ccdf;}
    .wind-info { font-weight: 700; font-size: 1.11em; margin: 0; display: flex; justify-content: center; gap: 12px; }
    .wind-info span { display: inline-block; }
    .wind-info .wind-speed { color: #84dbff; }
    .wind-info .wind-dir { color: #c3ccdf; }
    .folata-max { color: #84dbff; font-weight: 700; font-size: 1.11em; margin-top: 6px; }
    .box-summary { 
      width: 97%; 
      margin: 0 auto; 
      margin-top: 13px; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      justify-content: center;
      font-size: 1.01em;
      gap: 2px;
    }
    .box-summary-row {
      width: 100%;
      display: flex;
      flex-direction: row;
      justify-content: center;
      gap: 16px;
      flex-wrap: wrap;
    }
    .box-summary-row2 {
      text-align:center;
      width:100%;
    }
    .summary-label { font-weight: 700; }
    .summary-max { color: #ffd472; }
    .summary-min { color: #6fd7f8; }
    .summary-dir { color: #8effa6; }
    .summary-mean { color: #b6fffa; }
    .summary-range { color: #fee3a1; }
    .summary-std { color: #c2cafd;}
    .summary-trend-up { color: #09e889; }
    .summary-trend-down { color: #ff9a00; }
    .summary-trend-stable { color: #ffd472; }
    .summary-max-mm { color: #a1b4ff; }
    .summary-min-mm { color: #72b6cc; }
    .summary-hour { color: #e0deff;}
    .summary-temp { color: #ffb2e6;}
    .summary-celeste { color: #6fd7f8; }
    button.detail-btn { margin-top:9px; background: #127af7; color: #fff; font-weight:700; border: none; border-radius: 8px; padding: 11px 24px; cursor: pointer; transition: background 0.12s;}
    button.detail-btn:hover { background: #45bafe;}
    .detail-section { display: none; margin-top: 8px; width: 100%; }
    .detail-section.active { display: block; }
    .chart-wrap { width: 99%; max-width: 385px; margin: 0 auto 8px auto; border-radius: 13px; background: #213260d0; padding: 11px 5px 7px 5px;}
    .mini-days { display:flex; flex-wrap:wrap; gap:8px; margin:18px auto 7px auto; justify-content:center;}
    .mini-day { background: #0b1333b0; color: #c6f3ff; border-radius:11px; padding:9px 15px; font-size:1em; min-width:85px; box-shadow: 0 2px 8px #202b3b44; cursor: pointer; user-select: none; }
    .mini-day:hover { background: rgba(79, 117, 203, 0.47); }
    .mini-day.active { background: rgba(91, 144, 197, 0.78); box-shadow: 0 0 12px #dbefff; }
    .footer { margin-top: 32px; text-align: center; color: #dbefff; font-size: 17px; font-weight: 500; text-shadow: 0 2px 6px #283c5880; }
    @media (max-width: 800px) {
      .dashboard {
        gap: 12px;
      }
      .box {
        min-width: 180px;
        max-width: 97vw;
      }
    }
    @media (max-width: 650px) {
      .dashboard {
        flex-direction: column;
        align-items: center;
        gap: 14px;
      }
      .box {
        width: 100%;
        max-width: 98vw;
      }
      .header {
        font-size: 1.17em;
      }
    }
    @media (max-width: 510px) {
      .mini-day {
        padding: 6px 5px;
        font-size: 0.93em;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="header">PREVISIONI METEO PROCIDA</div>
  <div class="dashboard">
    <section class="box vento" id="windbox"></section>
    <section class="box pioggia" id="rainbox"></section>
    <section class="box mare" id="seabox"></section>
    <section class="box pressione" id="pressbox"></section>
  </div>
  <div class="mini-days" id="miniDaysBox"></div>
  <div class="footer" id="footer"></div>
  <script>
    // QUESTA VARIABILE SARA' POPOLATA DAI DATI PROVENIENTI DA N8N
    // Sostituisci il contenuto di RAW_API_DATA con i dati JSON dal tuo nodo n8n
    const RAW_API_DATA = [
      {
        "mergedHourly": [], // Inserisci qui l'array mergedHourly dal JSON
        "days": [],         // Inserisci qui l'array days dal JSON
        "updated_at": ""    // Inserisci qui la data di aggiornamento
      }
    ];

    // Funzione per processare i dati dall'API e crearli nel formato necessario
function processAPIData(apiData) {
  const data = apiData[0];  // ‚úÖ CORRETTO - prende il primo elemento dell'array
      
      // Processa i dati mare: raggruppa per giorno
      const seaByDay = [];
      const mergedHourly = data.mergedHourly || [];
      
      // Crea un oggetto per raggruppare i dati mare per data
      const seaGrouped = {};
      mergedHourly.forEach(entry => {
        const date = entry.time.split('T'); // Estrai solo la data (YYYY-MM-DD)
        if (!seaGrouped[date]) {
          seaGrouped[date] = [];
        }
        seaGrouped[date].push({
          time: entry.time.split('T').substring(0, 5), // Estrai solo HH:MM
          wave_height: entry.wave_height,
          sea_surface_temperature: entry.sea_surface_temperature,
          swell_height: entry.swell_height,
          swell_direction: entry.swell_direction
        });
      });
      
      // Converte l'oggetto in array ordinato per data
      Object.keys(seaGrouped).sort().forEach(date => {
        seaByDay.push(seaGrouped[date]);
      });
      
      // Processa i giorni con calcolo folata max (raffica)
      const days = (data.days || []).map(day => {
        // Calcola la folata massima (raffica) dai dati di vento orari
        // Tipicamente √® circa 1.3-1.5 volte il vento massimo
        const windMax = Math.max(...day.hourly_winds);
        const windGust = Math.round(windMax * 1.4); // Stima folata
        
        return {
          day_label: day.day_label,
          icon: day.icon,
          temp_max: parseFloat(day.temp_max),
          temp_min: parseFloat(day.temp_min),
          precipitation: parseFloat(day.precipitation),
          wind_max: Math.round(windMax),
          wind_gust: windGust,
          wind_min: Math.round(Math.min(...day.hourly_winds)),
          wind_dir: day.hourly_wind_directions, // Direzione prevalente
          hourly_winds: day.hourly_winds.map(w => Math.round(w)),
          hourly_wind_directions: day.hourly_wind_directions,
          hourly_labels: day.hourly_labels,
          hourly_precips: day.hourly_precips,
          hourly_pressures: day.hourly_pressures,
          pressure_avg: day.pressure_avg
        };
      });
      
      return {
        days: days,
        sea: seaByDay,
        updated_at: data.updated_at || ''
      };
    }

    // Carica i dati processati
    let DATA;
    try {
      DATA = processAPIData(RAW_API_DATA);
    } catch (e) {
      console.error("Errore nel processare i dati API:", e);
      // Fallback a dati vuoti in caso di errore
      DATA = { days: [], sea: [], updated_at: '' };
    }

    let selectedDayIndex = 0;
    let windChart, rainChart, seaChart, pressChart;

    function rainIcon(valmm) {
      if (valmm < 0.1) return '';
      if (valmm < 0.5) return 'üíß';
      if (valmm < 1) return 'üíßüíß';
      if (valmm < 3) return 'üíßüíßüíß';
      if (valmm < 10) return 'üíßüíßüíßüíß';
      return 'üíßüíßüíßüíßüíß';
    }

    function windDirectionName(deg) {
      const winds = [
        { name: "Tramontana", abbr: "N" }, { name: "Grecale", abbr: "NE" },
        { name: "Levante", abbr: "E" }, { name: "Scirocco", abbr: "SE" },
        { name: "Ostro", abbr: "S" }, { name: "Libeccio", abbr: "SO" },
        { name: "Ponente", abbr: "O" }, { name: "Maestrale", abbr: "NO" }
      ];
      const idx = Math.floor(((deg + 22.5) % 360) / 45);
      return winds[idx] ? winds[idx].name + " (" + winds[idx].abbr + ")" : "N/D";
    }

    function calculateMean(arr) { if (!arr.length) return 0; return arr.reduce((a, b) => a + b, 0) / arr.length; }
    function calculateRange(arr) { if (!arr.length) return 0; return Math.max(...arr) - Math.min(...arr); }
    function calculateStdDev(arr) { if (!arr.length) return 0; const m = calculateMean(arr); return Math.sqrt(arr.reduce((a, b) => a + (b - m) ** 2, 0) / arr.length); }

    function pressureTrend(arr) {
      if (!arr || arr.length < 5) return "N/D";
      const meanStart = (arr + arr + arr) / 3, meanEnd = (arr[arr.length - 3] + arr[arr.length - 2] + arr[arr.length - 1]) / 3;
      if (meanEnd > meanStart + 1) return '<span class="summary-trend-up">in aumento ‚¨ÜÔ∏è (alta)</span>';
      if (meanStart > meanEnd + 1) return '<span class="summary-trend-down">in calo ‚¨áÔ∏è (bassa)</span>';
      return '<span class="summary-trend-stable">stabile ‚ÜîÔ∏è</span>';
    }

    function toggleDetail(id) {
      let el = document.getElementById(id);
      document.querySelectorAll('.detail-section').forEach(e => {
        if (e !== el) e.classList.remove('active');
      });
      el.classList.toggle('active');
    }

    function renderMiniDays() {
      let html = "";
      DATA.days.forEach((d, i) => {
        html += `<div class="mini-day${i === selectedDayIndex ? " active" : ""}" onclick="selectDay(${i})">
            ${d.day_label} <span class="icon">${d.icon}</span>
          </div>`;
      });
      document.getElementById("miniDaysBox").innerHTML = html;
    }

    function selectDay(dayIndex) {
      selectedDayIndex = dayIndex;
      renderAll();
    }

    function renderWind() {
      const d = DATA.days[selectedDayIndex];
      if (!d) return;
      
      const windSpeed = d.hourly_winds ? d.hourly_winds[new Date().getHours()] : d.wind_max || "--";
      const windDeg = d.hourly_wind_directions ? d.hourly_wind_directions[new Date().getHours()] : d.wind_dir || "--";
      const windDirTxt = windDirectionName(windDeg);
      const max = d.hourly_winds ? Math.max(...d.hourly_winds) : d.wind_max || "--";
      const min = d.hourly_winds ? Math.min(...d.hourly_winds) : d.wind_min || "--";
      const maxDir = d.hourly_wind_directions ? windDirectionName(Math.max(...d.hourly_wind_directions)) : windDirTxt;
      
      document.getElementById("windbox").innerHTML = `
        <div class="box-title">üå¨Ô∏è Vento</div>
        <p class="wind-info"><span class="wind-speed">üçÉ ${windSpeed} km/h</span><span class="wind-dir">‚éã ${windDeg}¬∞ ${windDirTxt}</span></p>
        <div class="folata-max">Folata max: <b>${d.wind_gust || d.wind_max || "--"} km/h</b></div>
        <button class="detail-btn" onclick="toggleDetail('wind-detail')">Dettagli / Grafico</button>
        <div class="detail-section" id="wind-detail"><div class="chart-wrap"><canvas id="windchart"></canvas></div></div>
        <div class="box-summary">
          <div class="box-summary-row">
            <span class="summary-label summary-max">Massimo: ${max} km/h</span>
            <span class="summary-label summary-min">Minimo: ${min} km/h</span>
          </div>
          <div class="box-summary-row2">
            <span class="summary-label summary-dir">Direzione max: ${maxDir}</span>
          </div>
        </div>
      `;
      
      if (windChart) windChart.destroy();
      const ctx = document.getElementById('windchart').getContext('2d');
      windChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: d.hourly_labels || [],
          datasets: [{
            label: 'Vento (km/h)',
            data: d.hourly_winds || [],
            borderColor: '#66E5FF',
            backgroundColor: 'rgba(90,184,255,0.12)',
            fill: true,
            tension: 0.21,
            pointRadius: 4,
            pointHoverRadius: 7,
            pointBackgroundColor: '#66E5FF',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointHoverBackgroundColor: '#66E5FF',
            pointHoverBorderColor: '#fff',
            pointHoverBorderWidth: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { 
            legend: { display: false },
            tooltip: {
              enabled: true,
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              titleFont: { size: 14, weight: 'bold' },
              bodyFont: { size: 13 },
              displayColors: true,
              borderColor: '#66E5FF',
              borderWidth: 2
            }
          },
          scales: { 
            y: { beginAtZero: true }, 
            x: {} 
          }
        }
      });
    }

    function renderRain() {
      const d = DATA.days[selectedDayIndex];
      if (!d) return;
      
      const pioggia = d.precipitation || 0;
      const max = d.hourly_precips ? Math.max(...d.hourly_precips) : 0;
      const oraMax = d.hourly_labels && d.hourly_precips ? d.hourly_labels[d.hourly_precips.indexOf(max)] : '--';
      
      document.getElementById("rainbox").innerHTML = `
        <div class="box-title">üåßÔ∏è Pioggia</div>
        <div class="main">Totale oggi: <b>${pioggia.toFixed(1)} mm</b> ${rainIcon(pioggia)}</div>
        <div class="desc"><b>Max oraria:</b> ${max.toFixed(1)} mm &nbsp; <b>Ora pi√π piovosa:</b> ${oraMax}</div>
        <button class="detail-btn" onclick="toggleDetail('rain-detail')">Dettagli / Grafico</button>
        <div class="detail-section" id="rain-detail"><div class="chart-wrap"><canvas id="rainchart"></canvas></div></div>
        <div class="box-summary">
          <div class="box-summary-row">
            <span class="summary-label summary-max">Max oraria: ${max.toFixed(1)} mm</span>
            <span class="summary-label summary-hour">Ora pi√π piovosa: ${oraMax}</span>
          </div>
        </div>
      `;
      
      if (rainChart) rainChart.destroy();
      const ctx = document.getElementById('rainchart').getContext('2d');
      rainChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: d.hourly_labels || [],
          datasets: [{
            label: 'Precipitazioni (mm)',
            data: d.hourly_precips || [],
            backgroundColor: '#52c5f7',
            borderColor: '#52afe7',
            borderWidth: 2,
            hoverBackgroundColor: '#6ed5ff',
            hoverBorderColor: '#52afe7',
            hoverBorderWidth: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { 
            legend: { display: false },
            tooltip: {
              enabled: true,
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              titleFont: { size: 14, weight: 'bold' },
              bodyFont: { size: 13 },
              displayColors: true,
              borderColor: '#52c5f7',
              borderWidth: 2
            }
          },
          scales: { 
            y: { beginAtZero: true }, 
            x: {} 
          }
        }
      });
    }

    function renderSea() {
      const merged = DATA.sea[selectedDayIndex] || [];
      const waveMean = calculateMean(merged.map(h => h.wave_height));
      const waveRange = calculateRange(merged.map(h => h.wave_height));
      const waveStdDev = calculateStdDev(merged.map(h => h.wave_height));
      const seaTemp = calculateMean(merged.map(h => h.sea_surface_temperature));
      
      document.getElementById("seabox").innerHTML = `
        <div class="box-title">üåä Mare</div>
        <div class="main">Altezza media onda: <b>${waveMean.toFixed(2)} m</b></div>
        <div class="desc">Temperatura mare: <b>${seaTemp.toFixed(1)} ¬∞C</b></div>
        <button class="detail-btn" onclick="toggleDetail('sea-detail')">Dettagli / Grafico</button>
        <div class="detail-section" id="sea-detail"><div class="chart-wrap"><canvas id="seachart"></canvas></div></div>
        <div class="box-summary">
          <div class="box-summary-row">
            <span class="summary-label summary-mean">Hsig: ${waveMean.toFixed(2)} m</span>
            <span class="summary-label summary-range">Range: ${waveRange.toFixed(2)} m</span>
            <span class="summary-label summary-std">Dev.Std.: ${waveStdDev.toFixed(2)} m</span>
          </div>
        </div>
      `;
      
      if (seaChart) seaChart.destroy();
      const ctx = document.getElementById('seachart').getContext('2d');
      seaChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: merged.map(h => h.time),
          datasets: [
            { 
              label: 'Onda (m)', 
              data: merged.map(h => h.wave_height), 
              borderColor: '#41f8bd', 
              backgroundColor: 'rgba(34,255,170,0.10)', 
              fill: true, 
              tension: 0.22, 
              pointRadius: 4, 
              pointHoverRadius: 7,
              pointBackgroundColor: '#25A9FA',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointHoverBackgroundColor: '#41f8bd',
              pointHoverBorderColor: '#fff',
              pointHoverBorderWidth: 3
            },
            { 
              label: 'Swell (m)', 
              data: merged.map(h => h.swell_height), 
              borderColor: '#21D08A', 
              backgroundColor: 'rgba(34,255,170,0.06)', 
              fill: true, 
              tension: 0.18, 
              pointRadius: 4, 
              pointHoverRadius: 7,
              pointBackgroundColor: '#21D08A',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointHoverBackgroundColor: '#21D08A',
              pointHoverBorderColor: '#fff',
              pointHoverBorderWidth: 3
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { 
            legend: { display: true },
            tooltip: {
              enabled: true,
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              titleFont: { size: 14, weight: 'bold' },
              bodyFont: { size: 13 },
              displayColors: true,
              borderColor: '#41f8bd',
              borderWidth: 2
            }
          },
          scales: { 
            y: { beginAtZero: true }, 
            x: {} 
          }
        }
      });
    }

    function renderPress() {
      const d = DATA.days[selectedDayIndex];
      if (!d) return;
      
      const arr = d.hourly_pressures || [];
      const pressMean = calculateMean(arr);
      
      document.getElementById("pressbox").innerHTML = `
        <div class="box-title">üîΩ Pressione</div>
        <div class="main">Media oggi: <b>${pressMean.toFixed(1)} hPa</b></div>
        <div class="desc">Tendenza: ${pressureTrend(arr)}</div>
        <button class="detail-btn" onclick="toggleDetail('press-detail')">Dettagli / Grafico</button>
        <div class="detail-section" id="press-detail"><div class="chart-wrap"><canvas id="presschart"></canvas></div></div>
        <div class="box-summary">
          <div class="box-summary-row">
            <span class="summary-label summary-max">Max: ${Math.max(...arr).toFixed(1)} hPa</span>
            <span class="summary-label summary-min">Min: ${Math.min(...arr).toFixed(1)} hPa</span>
          </div>
        </div>
      `;
      
      if (pressChart) pressChart.destroy();
      const ctx = document.getElementById('presschart').getContext('2d');
      pressChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: d.hourly_labels || [],
          datasets: [{
            label: 'Pressione (hPa)',
            data: arr,
            borderColor: '#ffd472',
            backgroundColor: 'rgba(255,240,51,0.10)',
            fill: true,
            tension: 0.22,
            pointRadius: 4,
            pointHoverRadius: 7,
            pointBackgroundColor: '#ffd472',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointHoverBackgroundColor: '#ffd472',
            pointHoverBorderColor: '#fff',
            pointHoverBorderWidth: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { 
            legend: { display: false },
            tooltip: {
              enabled: true,
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              titleFont: { size: 14, weight: 'bold' },
              bodyFont: { size: 13 },
              displayColors: true,
              borderColor: '#ffd472',
              borderWidth: 2
            }
          },
          scales: { 
            y: { beginAtZero: false }, 
            x: {} 
          }
        }
      });
    }

    function renderFooter() {
      const updateTime = DATA.updated_at || 'N/D';
      document.getElementById("footer").innerHTML = `Powered by Open-Meteo ‚Ä¢ UI by micheledv74 ‚Ä¢ Ultimo agg.: <span id="updated_stamp">${updateTime}</span>`;
    }

    function renderAll() {
      if (!DATA.days || DATA.days.length === 0) {
        console.error("Nessun dato disponibile");
        return;
      }
      renderWind();
      renderRain();
      renderSea();
      renderPress();
      renderMiniDays();
      renderFooter();
    }

    // Inizializza la dashboard
    renderAll();
  </script>
</body>
</html>
