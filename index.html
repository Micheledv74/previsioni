// ===================================================================
// NODO HTML - VERSIONE COMPLETA FUNZIONANTE
// ===================================================================

const inputData = $json;
const meteoData = Array.isArray(inputData) ? inputData[0] : inputData;

if (!meteoData || !meteoData.days) {
  throw new Error('Dati meteo mancanti!');
}

console.log('Dati meteo:', meteoData.days.length, 'giorni');

// ✅ FIX: Escape JSON per evitare syntax error
const weatherDataJSON = JSON.stringify(meteoData)
  .replace(/</g, '\\u003c')
  .replace(/>/g, '\\u003e')
  .replace(/\\/g, '\\\\')
  .replace(/'/g, "\\'");

const html = \`<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#012549">
  <title>Meteo Procida - Previsioni 7 Giorni</title>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"><\/script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #012549;
      --secondary: #1a4d7a;
      --accent: #3b82f6;
      --text-primary: #f8fafc;
      --text-secondary: #cbd5e1;
      --bg-card: rgba(255, 255, 255, 0.05);
      --bg-hover: rgba(255, 255, 255, 0.1);
      --border: rgba(255, 255, 255, 0.1);
      --shadow: rgba(0, 0, 0, 0.3);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 30px;
      padding: 20px;
      background: var(--bg-card);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      border: 1px solid var(--border);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo {
      width: 60px;
      height: 60px;
      background: white;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
    }

    .header-info h1 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .subtitle {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .header-actions {
      display: flex;
      gap: 10px;
    }

    .icon-btn {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text-primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      font-size: 20px;
    }

    .icon-btn:hover {
      background: var(--bg-hover);
      transform: translateY(-2px);
    }

    .hero-card {
      padding: 30px;
      background: var(--bg-card);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      border: 1px solid var(--border);
      margin-bottom: 20px;
    }

    .hero-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .hero-location {
      font-size: 18px;
      font-weight: 600;
    }

    .hero-date {
      font-size: 16px;
      color: var(--text-secondary);
    }

    .hero-content {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 30px;
      text-align: center;
    }

    .hero-icon {
      font-size: 120px;
    }

    .hero-temp {
      font-size: 72px;
      font-weight: 700;
    }

    .hero-summary {
      font-size: 16px;
      color: var(--text-secondary);
      margin-top: 10px;
    }

    .hero-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .hero-detail {
      text-align: center;
      padding: 15px;
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
    }

    .hero-detail-icon {
      font-size: 24px;
      margin-bottom: 5px;
    }

    .hero-detail-value {
      font-size: 20px;
      font-weight: 700;
      margin: 5px 0;
    }

    .hero-detail-label {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .mini-cards {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin: 20px 0;
    }

    .mini-card {
      padding: 20px;
      background: var(--bg-card);
      border-radius: 16px;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }

    .mini-card:hover {
      background: var(--bg-hover);
      transform: translateY(-4px);
    }

    .mini-card-icon {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .info-pills {
      display: flex;
      gap: 10px;
      margin: 20px 0;
      flex-wrap: wrap;
      justify-content: center;
    }

    .info-pill {
      padding: 12px 24px;
      background: var(--bg-card);
      border-radius: 20px;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }

    .info-pill:hover {
      background: var(--bg-hover);
      transform: scale(1.05);
    }

    .info-pill.has-alerts {
      border-color: #ef4444;
    }

    .alert-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #ef4444;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
    }

    .chart-section {
      margin: 20px 0;
      padding: 20px;
      background: var(--bg-card);
      border-radius: 20px;
      border: 1px solid var(--border);
    }

    .chart-section h3 {
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .stat-card {
      padding: 20px;
      background: var(--bg-card);
      border-radius: 16px;
      border: 1px solid var(--border);
      text-align: center;
    }

    .stat-icon {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 700;
      margin: 10px 0;
    }

    .stat-label {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .day-cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .day-card {
      padding: 20px;
      background: var(--bg-card);
      border-radius: 16px;
      border: 1px solid var(--border);
      transition: all 0.3s;
    }

    .day-card:hover {
      background: var(--bg-hover);
      transform: translateY(-4px);
    }

    .day-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .day-date {
      font-size: 16px;
      font-weight: 600;
    }

    .day-temp {
      font-size: 20px;
      font-weight: 700;
      color: #f59e0b;
    }

    .day-icon {
      font-size: 48px;
      text-align: center;
      margin: 15px 0;
    }

    .day-summary {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 15px;
      min-height: 60px;
    }

    .day-details {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .day-detail {
      text-align: center;
      font-size: 12px;
    }

    .day-detail-value {
      font-size: 16px;
      font-weight: 700;
      margin: 5px 0;
    }

    .popup-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .popup-overlay.active {
      display: flex;
    }

    .popup {
      background: var(--secondary);
      border-radius: 24px;
      padding: 30px;
      max-width: 700px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px var(--shadow);
    }

    .popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .popup-header h3 {
      font-size: 24px;
    }

    .close-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--bg-card);
      border: none;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 20px;
    }

    .popup-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 20px;
    }

    .popup-stat {
      text-align: center;
      padding: 20px;
      background: var(--bg-card);
      border-radius: 12px;
    }

    .popup-stat-icon {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .popup-stat-value {
      font-size: 32px;
      font-weight: 700;
      margin: 10px 0;
    }

    .popup-stat-label {
      font-size: 14px;
      color: var(--text-secondary);
    }

    footer {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
      font-size: 14px;
    }

    .notification-toggle {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--accent);
      border: none;
      color: white;
      font-size: 28px;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
      transition: all 0.3s;
      z-index: 999;
    }

    .notification-toggle:hover {
      transform: scale(1.1);
    }

    @media (max-width: 768px) {
      body { padding: 10px; }
      header { flex-direction: column; gap: 15px; }
      .hero-content { grid-template-columns: 1fr; }
      .hero-temp { font-size: 56px; }
      .hero-icon { font-size: 80px; }
      .hero-details { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-left">
        <div class="logo">☀️</div>
        <div class="header-info">
          <h1>Meteo Procida</h1>
          <div class="subtitle">⭐ Previsioni 7 giorni - Analisi AI</div>
        </div>
      </div>
      <div class="header-actions">
        <button class="icon-btn" onclick="window.print()">📄</button>
        <button class="icon-btn" onclick="shareWeather()">📤</button>
      </div>
    </header>

    <div id="hero" class="hero-card"></div>

    <div class="mini-cards">
      <div class="mini-card" onclick="showRainPopup()">
        <div class="mini-card-icon">💧</div>
        <div id="rain-info">Caricamento...</div>
      </div>
      <div class="mini-card" onclick="showWindPopup()">
        <div class="mini-card-icon">💨</div>
        <div id="wind-info">Caricamento...</div>
      </div>
    </div>

    <div class="info-pills">
      <div class="info-pill" id="summaryPill" onclick="showSummaryPopup()">📋 Riepilogo</div>
      <div class="info-pill" id="advicePill" onclick="showAdvicePopup()">💡 Consigli</div>
      <div class="info-pill" id="alertsPill" onclick="showAlertsPopup()">⚠️ Allerte</div>
    </div>

    <div class="chart-section">
      <h3>🌡️ Temperature & Precipitazioni - 7 Giorni</h3>
      <canvas id="tempRainChart" height="80"></canvas>
    </div>

    <div class="chart-section">
      <h3>💨 Pressione Atmosferica & Vento</h3>
      <canvas id="pressureWindChart" height="80"></canvas>
    </div>

    <div class="chart-section">
      <h3>🌊 Condizioni Meteomarine - 7 Giorni</h3>
      <canvas id="seaChart" height="80"></canvas>
    </div>

    <div class="stats-grid" id="stats"></div>

    <h2 style="margin: 30px 0 20px; text-align: center;">📅 Prossimi 6 giorni</h2>
    <div class="day-cards-container" id="forecast"></div>

    <footer>
      <p>Dati aggregati da Open-Meteo, Marine Open-Meteo, Weatherbit, Meteoblue e ilmeteo.it</p>
      <p>Analisi meteorologica professionale powered by AI</p>
      <p id="timestamp">Notifiche: Disattivate</p>
    </footer>
  </div>

  <button class="notification-toggle" onclick="toggleNotifications()">
    <span id="notif-icon">🔔</span>
  </button>

  <div id="rainPopup" class="popup-overlay" onclick="closePopup('rainPopup')">
    <div class="popup" onclick="event.stopPropagation()">
      <div class="popup-header">
        <h3>💧 Dettaglio Pioggia</h3>
        <button class="close-btn" onclick="closePopup('rainPopup')">×</button>
      </div>
      <canvas id="rainChart" height="250"></canvas>
      <div class="popup-stats" id="rainStats"></div>
    </div>
  </div>

  <div id="windPopup" class="popup-overlay" onclick="closePopup('windPopup')">
    <div class="popup" onclick="event.stopPropagation()">
      <div class="popup-header">
        <h3>💨 Dettaglio Vento</h3>
        <button class="close-btn" onclick="closePopup('windPopup')">×</button>
      </div>
      <canvas id="windChart" height="250"></canvas>
      <div class="popup-stats" id="windStats"></div>
    </div>
  </div>

  <div id="summaryPopup" class="popup-overlay" onclick="closePopup('summaryPopup')">
    <div class="popup" onclick="event.stopPropagation()">
      <div class="popup-header">
        <h3>📋 Riepilogo</h3>
        <button class="close-btn" onclick="closePopup('summaryPopup')">×</button>
      </div>
      <div id="summaryContent"></div>
    </div>
  </div>

  <div id="advicePopup" class="popup-overlay" onclick="closePopup('advicePopup')">
    <div class="popup" onclick="event.stopPropagation()">
      <div class="popup-header">
        <h3>💡 Consigli</h3>
        <button class="close-btn" onclick="closePopup('advicePopup')">×</button>
      </div>
      <div id="adviceContent"></div>
    </div>
  </div>

  <div id="alertsPopup" class="popup-overlay" onclick="closePopup('alertsPopup')">
    <div class="popup" onclick="event.stopPropagation()">
      <div class="popup-header">
        <h3>⚠️ Allerte</h3>
        <button class="close-btn" onclick="closePopup('alertsPopup')">×</button>
      </div>
      <div id="alertsContent"></div>
    </div>
  </div>

  <script>
    (function() {
      try {
        const weatherData = \${weatherDataJSON};
        
        console.log('✅ Weather data caricato:', weatherData);
        
        if (!weatherData || !weatherData.days) {
          throw new Error('Dati non validi');
        }

        let notificationsEnabled = false;
        let rainChartInstance = null;
        let windChartInstance = null;

        function getWeatherIcon(day) {
          if (!day || !day.rain) return '☀️';
          if (day.rain.total_mm > 10) return '🌧️';
          if (day.rain.total_mm > 0) return '🌦️';
          return '☀️';
        }

        function renderHero() {
          const today = weatherData.days[0];
          const date = new Date(today.date).toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' });
          const tempMax = Math.round(today.temp.max);
          const tempMin = Math.round(today.temp.min);
          
          const html = \\\`
            <div class="hero-header">
              <div>
                <div class="hero-location">📍 \\\${weatherData.location?.name || 'Procida'}, Italia</div>
                <div class="hero-date">\\\${date}</div>
              </div>
            </div>
            <div class="hero-content">
              <div>
                <div class="hero-temp">\\\${tempMax}°</div>
                <div style="color: #06b6d4; font-size: 24px;">\\\${tempMin}°</div>
              </div>
              <div class="hero-icon">\\\${getWeatherIcon(today)}</div>
              <div>
                <div class="hero-summary">\\\${today.summary || 'Previsioni meteo'}</div>
              </div>
            </div>
            <div class="hero-details">
              <div class="hero-detail">
                <div class="hero-detail-icon">💧</div>
                <div class="hero-detail-value">\\\${today.rain.probability}%</div>
                <div class="hero-detail-label">\\\${today.rain.total_mm}mm</div>
              </div>
              <div class="hero-detail">
                <div class="hero-detail-icon">💨</div>
                <div class="hero-detail-value">\\\${Math.max(...today.wind.periods.map(p => p.speed_kmh))}</div>
                <div class="hero-detail-label">km/h</div>
              </div>
              <div class="hero-detail">
                <div class="hero-detail-icon">💧</div>
                <div class="hero-detail-value">\\\${today.humidity}%</div>
                <div class="hero-detail-label">Umidità</div>
              </div>
              <div class="hero-detail">
                <div class="hero-detail-icon">☀️</div>
                <div class="hero-detail-value">\\\${today.uv_index}</div>
                <div class="hero-detail-label">UV Index</div>
              </div>
              <div class="hero-detail">
                <div class="hero-detail-icon">🌡️</div>
                <div class="hero-detail-value">\\\${today.pressure.value_hPa}</div>
                <div class="hero-detail-label">hPa</div>
              </div>
              <div class="hero-detail">
                <div class="hero-detail-icon">\\\${today.sea ? '🌊' : '💨'}</div>
                <div class="hero-detail-value">\\\${today.sea ? today.sea.wave_height_m + 'm' : '-'}</div>
                <div class="hero-detail-label">\\\${today.sea ? today.sea.condition : '-'}</div>
              </div>
              <div class="hero-detail">
                <div class="hero-detail-icon">🌅</div>
                <div class="hero-detail-value">\\\${today.sunrise}</div>
                <div class="hero-detail-label">Alba</div>
              </div>
              <div class="hero-detail">
                <div class="hero-detail-icon">🌇</div>
                <div class="hero-detail-value">\\\${today.sunset}</div>
                <div class="hero-detail-label">Tramonto</div>
              </div>
            </div>
          \\\`;
          document.getElementById('hero').innerHTML = html;
          
          document.getElementById('rain-info').innerHTML = \\\`<strong>\\\${today.rain.probability}%</strong><br>\\\${today.rain.total_mm}mm\\\`;
          const maxWind = Math.max(...today.wind.periods.map(p => p.speed_kmh));
          document.getElementById('wind-info').innerHTML = \\\`<strong>\\\${maxWind}km/h</strong><br>Max\\\`;

          if (today.alerts && today.alerts.length > 0) {
            document.getElementById('alertsPill').classList.add('has-alerts');
            document.getElementById('alertsPill').innerHTML = '⚠️ Allerte <span class="alert-badge">' + today.alerts.length + '</span>';
          }
        }

        function renderCharts() {
          const labels = weatherData.days.map(d => new Date(d.date).toLocaleDateString('it-IT', { weekday: 'short', day: 'numeric' }));
          
          new Chart(document.getElementById('tempRainChart'), {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Temp Max (°C)',
                data: weatherData.days.map(d => d.temp.max),
                borderColor: '#f59e0b',
                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                tension: 0.4,
                yAxisID: 'y'
              }, {
                label: 'Temp Min (°C)',
                data: weatherData.days.map(d => d.temp.min),
                borderColor: '#06b6d4',
                backgroundColor: 'rgba(6, 182, 212, 0.1)',
                tension: 0.4,
                yAxisID: 'y'
              }, {
                label: 'Pioggia (mm)',
                data: weatherData.days.map(d => d.rain.total_mm),
                type: 'bar',
                backgroundColor: 'rgba(59, 130, 246, 0.6)',
                yAxisID: 'y1'
              }]
            },
            options: {
              responsive: true,
              plugins: { legend: { labels: { color: '#f8fafc' }}},
              scales: {
                y: { type: 'linear', position: 'left', title: { display: true, text: 'Temperatura (°C)', color: '#f8fafc' }, ticks: { color: '#f8fafc' }, grid: { color: 'rgba(255,255,255,0.1)' }},
                y1: { type: 'linear', position: 'right', title: { display: true, text: 'Pioggia (mm)', color: '#f8fafc' }, ticks: { color: '#f8fafc' }, grid: { display: false }},
                x: { ticks: { color: '#f8fafc' }, grid: { color: 'rgba(255,255,255,0.1)' }}
              }
            }
          });

          new Chart(document.getElementById('pressureWindChart'), {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Pressione (hPa)',
                data: weatherData.days.map(d => d.pressure.value_hPa),
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                yAxisID: 'y'
              }, {
                label: 'Vento Max (km/h)',
                data: weatherData.days.map(d => Math.max(...d.wind.periods.map(p => p.speed_kmh))),
                borderColor: '#f59e0b',
                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                tension: 0.4,
                yAxisID: 'y1'
              }]
            },
            options: {
              responsive: true,
              plugins: { legend: { labels: { color: '#f8fafc' }}},
              scales: {
                y: { type: 'linear', position: 'left', title: { display: true, text: 'Pressione (hPa)', color: '#f8fafc' }, ticks: { color: '#f8fafc' }, grid: { color: 'rgba(255,255,255,0.1)' }},
                y1: { type: 'linear', position: 'right', title: { display: true, text: 'Vento (km/h)', color: '#f8fafc' }, ticks: { color: '#f8fafc' }, grid: { display: false }},
                x: { ticks: { color: '#f8fafc' }, grid: { color: 'rgba(255,255,255,0.1)' }}
              }
            }
          });

          if (weatherData.days[0].sea) {
            new Chart(document.getElementById('seaChart'), {
              type: 'line',
              data: {
                labels: labels,
                datasets: [{
                  label: 'Altezza Onde (m)',
                  data: weatherData.days.map(d => d.sea ? d.sea.wave_height_m : 0),
                  borderColor: '#06b6d4',
                  backgroundColor: 'rgba(6, 182, 212, 0.1)',
                  tension: 0.4,
                  yAxisID: 'y'
                }, {
                  label: 'Temp Mare (°C)',
                  data: weatherData.days.map(d => d.sea ? d.sea.temperature_c : 0),
                  borderColor: '#f59e0b',
                  backgroundColor: 'rgba(245, 158, 11, 0.1)',
                  tension: 0.4,
                  yAxisID: 'y1'
                }]
              },
              options: {
                responsive: true,
                plugins: { legend: { labels: { color: '#f8fafc' }}},
                scales: {
                  y: { type: 'linear', position: 'left', title: { display: true, text: 'Altezza Onde (m)', color: '#f8fafc' }, ticks: { color: '#f8fafc' }, grid: { color: 'rgba(255,255,255,0.1)' }},
                  y1: { type: 'linear', position: 'right', title: { display: true, text: 'Temperatura (°C)', color: '#f8fafc' }, ticks: { color: '#f8fafc' }, grid: { display: false }},
                  x: { ticks: { color: '#f8fafc' }, grid: { color: 'rgba(255,255,255,0.1)' }}
                }
              }
            });
          }
        }

        function renderStats() {
          if (!weatherData.weekStats) return;
          const html = \\\`
            <div class="stat-card">
              <div class="stat-icon">🌡️</div>
              <div class="stat-value">\\\${weatherData.weekStats.maxTemp}°C</div>
              <div class="stat-label">Max Settimana</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">❄️</div>
              <div class="stat-value">\\\${weatherData.weekStats.minTemp}°C</div>
              <div class="stat-label">Min Settimana</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">📊</div>
              <div class="stat-value">\\\${weatherData.weekStats.avgTemp}°C</div>
              <div class="stat-label">Media</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">💧</div>
              <div class="stat-value">\\\${weatherData.weekStats.rainyDays}</div>
              <div class="stat-label">Giorni Pioggia</div>
            </div>
          \\\`;
          document.getElementById('stats').innerHTML = html;
        }

        function renderForecast() {
          const html = weatherData.days.slice(1).map(day => {
            const date = new Date(day.date).toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'short' });
            const tempMax = Math.round(day.temp.max);
            const tempMin = Math.round(day.temp.min);
            const maxWind = Math.max(...day.wind.periods.map(p => p.speed_kmh));
            
            return \\\`
              <div class="day-card">
                <div class="day-header">
                  <div><div class="day-date">\\\${date}</div></div>
                  <div class="day-temp">\\\${tempMax}° <span style="color:#06b6d4;">\\\${tempMin}°</span></div>
                </div>
                <div class="day-icon">\\\${getWeatherIcon(day)}</div>
                <div class="day-summary">\\\${day.summary || ''}</div>
                <div class="day-details">
                  <div class="day-detail">
                    <div>💧</div>
                    <div class="day-detail-value">\\\${day.rain.probability}%</div>
                    <div>\\\${day.rain.total_mm}mm</div>
                  </div>
                  <div class="day-detail">
                    <div>💨</div>
                    <div class="day-detail-value">\\\${maxWind}</div>
                    <div>km/h</div>
                  </div>
                  <div class="day-detail">
                    <div>🌡️</div>
                    <div class="day-detail-value">\\\${day.humidity}%</div>
                    <div>Umidità</div>
                  </div>
                </div>
              </div>
            \\\`;
          }).join('');
          document.getElementById('forecast').innerHTML = html;
        }

        function showRainPopup() {
          document.getElementById('rainPopup').classList.add('active');
          if (rainChartInstance) rainChartInstance.destroy();
          
          const today = weatherData.days[0];
          const hours = Array.from({length: 24}, (_, i) => \\\`\\\${i}:00\\\`);
          const rainData = new Array(24).fill(0);
          
          today.rain.periods.forEach(period => {
            const start = parseInt(period.start.split(':')[0]);
            const end = parseInt(period.end.split(':')[0]);
            const intensity = period.intensity === 'forte' ? 10 : period.intensity === 'moderata' ? 5 : 2;
            for (let h = start; h <= end; h++) {
              if (h < 24) rainData[h] = intensity;
            }
          });

          rainChartInstance = new Chart(document.getElementById('rainChart'), {
            type: 'bar',
            data: {
              labels: hours,
              datasets: [{
                label: 'Intensità Pioggia (mm/h)',
                data: rainData,
                backgroundColor: 'rgba(59, 130, 246, 0.6)',
                borderColor: '#3b82f6',
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { labels: { color: '#f8fafc' }}},
              scales: {
                y: { ticks: { color: '#f8fafc' }, grid: { color: 'rgba(255,255,255,0.1)' }, title: { display: true, text: 'Intensità (mm/h)', color: '#f8fafc' }},
                x: { ticks: { color: '#f8fafc' }, grid: { color: 'rgba(255,255,255,0.1)' }}
              }
            }
          });

          const totalRain = today.rain.total_mm;
          const maxIntensity = Math.max(...rainData);
          const duration = rainData.filter(r => r > 0).length;
          
          document.getElementById('rainStats').innerHTML = \\\`
            <div class="popup-stat">
              <div class="popup-stat-icon">💧</div>
              <div class="popup-stat-value">\\\${totalRain.toFixed(1)}mm</div>
              <div class="popup-stat-label">TOTALE MM</div>
            </div>
            <div class="popup-stat">
              <div class="popup-stat-icon">💧</div>
              <div class="popup-stat-value">\\\${maxIntensity.toFixed(1)}mm/h</div>
              <div class="popup-stat-label">PICCO MM/H</div>
            </div>
            <div class="popup-stat">
              <div class="popup-stat-icon">⏱️</div>
              <div class="popup-stat-value">\\\${duration}h</div>
              <div class="popup-stat-label">DURATA ORE</div>
            </div>
            <div class="popup-stat">
              <div class="popup-stat-icon">📊</div>
              <div class="popup-stat-value">\\\${today.rain.probability}%</div>
              <div class="popup-stat-label">PROBABILITÀ</div>
            </div>
          \\\`;
        }

        function showWindPopup() {
          document.getElementById('windPopup').classList.add('active');
          if (windChartInstance) windChartInstance.destroy();
          
          const today = weatherData.days[0];
          const hours = today.wind.periods.map(p => p.time);
          const speeds = today.wind.periods.map(p => p.speed_kmh);

          windChartInstance = new Chart(document.getElementById('windChart'), {
            type: 'line',
            data: {
              labels: hours,
              datasets: [{
                label: 'Velocità Vento (km/h)',
                data: speeds,
                borderColor: '#f59e0b',
                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                fill: true,
                tension: 0.4
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { labels: { color: '#f8fafc' }}},
              scales: {
                y: { ticks: { color: '#f8fafc' }, grid: { color: 'rgba(255,255,255,0.1)' }, title: { display: true, text: 'Velocità (km/h)', color: '#f8fafc' }},
                x: { ticks: { color: '#f8fafc' }, grid: { color: 'rgba(255,255,255,0.1)' }}
              }
            }
          });

          const maxSpeed = Math.max(...speeds);
          const avgSpeed = Math.round(speeds.reduce((a,b) => a+b, 0) / speeds.length);
          const maxTime = today.wind.periods[speeds.indexOf(maxSpeed)].time;
          const dominantDir = today.wind.periods[speeds.indexOf(maxSpeed)].direction;
          
          document.getElementById('windStats').innerHTML = \\\`
            <div class="popup-stat">
              <div class="popup-stat-icon">💨</div>
              <div class="popup-stat-value">\\\${avgSpeed} km/h</div>
              <div class="popup-stat-label">MEDIA KM/H</div>
            </div>
            <div class="popup-stat">
              <div class="popup-stat-icon">💨</div>
              <div class="popup-stat-value">\\\${maxSpeed} (\\\${maxTime})</div>
              <div class="popup-stat-label">RAFFICA MAX</div>
            </div>
            <div class="popup-stat">
              <div class="popup-stat-icon">🧭</div>
              <div class="popup-stat-value">3 Bft</div>
              <div class="popup-stat-label">BEAUFORT MAX</div>
            </div>
            <div class="popup-stat">
              <div class="popup-stat-icon">🧭</div>
              <div class="popup-stat-value">\\\${dominantDir}</div>
              <div class="popup-stat-label">DIREZIONE</div>
            </div>
          \\\`;
        }

        function showSummaryPopup() {
          document.getElementById('summaryPopup').classList.add('active');
          const today = weatherData.days[0];
          document.getElementById('summaryContent').innerHTML = \\\`
            <p style="font-size: 16px; line-height: 1.8; padding: 20px; background: var(--bg-card); border-radius: 12px;">
              \\\${today.summary}
            </p>
          \\\`;
        }

        function showAdvicePopup() {
          document.getElementById('advicePopup').classList.add('active');
          const today = weatherData.days[0];
          const html = today.advice.map(adv => \\\`
            <p style="padding: 15px; background: var(--bg-card); border-radius: 12px; margin: 10px 0;">
              \\\${adv}
            </p>
          \\\`).join('');
          document.getElementById('adviceContent').innerHTML = html;
        }

        function showAlertsPopup() {
          document.getElementById('alertsPopup').classList.add('active');
          const today = weatherData.days[0];
          const html = today.alerts.length > 0 
            ? today.alerts.map(alert => \\\`
                <p style="padding: 15px; background: rgba(239, 68, 68, 0.2); border-radius: 12px; margin: 10px 0; border-left: 4px solid #ef4444;">
                  \\\${alert}
                </p>
              \\\`).join('')
            : '<p style="text-align: center; padding: 30px;">✅ Nessuna allerta meteo attiva</p>';
          document.getElementById('alertsContent').innerHTML = html;
        }

        function closePopup(id) {
          document.getElementById(id).classList.remove('active');
        }

        function toggleNotifications() {
          notificationsEnabled = !notificationsEnabled;
          document.getElementById('notif-icon').textContent = notificationsEnabled ? '🔕' : '🔔';
          document.getElementById('timestamp').textContent = 'Notifiche: ' + (notificationsEnabled ? 'Attivate' : 'Disattivate');
        }

        function shareWeather() {
          if (navigator.share) {
            navigator.share({
              title: 'Meteo Procida',
              text: weatherData.days[0].summary,
              url: window.location.href
            });
          } else {
            alert('Condivisione non supportata su questo dispositivo');
          }
        }

        function updateTimestamp() {
          const now = new Date(weatherData.generated_at).toLocaleString('it-IT', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
          });
          document.getElementById('timestamp').innerHTML += '<br>Ultimo aggiornamento: ' + now;
        }

        window.showRainPopup = showRainPopup;
        window.showWindPopup = showWindPopup;
        window.showSummaryPopup = showSummaryPopup;
        window.showAdvicePopup = showAdvicePopup;
        window.showAlertsPopup = showAlertsPopup;
        window.closePopup = closePopup;
        window.toggleNotifications = toggleNotifications;
        window.shareWeather = shareWeather;

        console.log('✅ Inizializzazione UI');
        renderHero();
        renderCharts();
        renderStats();
        renderForecast();
        updateTimestamp();
        
      } catch (error) {
        console.error('❌ Errore:', error);
        document.body.innerHTML = '<div style="text-align:center; margin-top: 50px; padding: 20px;"><h1 style="color:#ef4444;">❌ Errore Dati Meteo</h1><p>' + error.message + '</p></div>';
      }
    })();
  <\/script>
</body>
</html>\`;

return [{ json: { content: html }}];
