<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#012549">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <meta name="description" content="Previsioni meteo dettagliate per Procida - Analisi AI multi-fonte">
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Meteo Procida">
  <link rel="icon" type="image/png" href="apple-touch-icon.png">
  
  <title>Meteo Procida - Previsioni 7 Giorni</title>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary-blue: #012549;
      --primary-blue-light: #003d6b;
      --accent-orange: #faa202;
      --accent-cyan: #08a5e8;
      --bg-gradient-start: #012549;
      --bg-gradient-end: #003d6b;
      --card-bg: rgba(255, 255, 255, 0.1);
      --card-border: rgba(255, 255, 255, 0.2);
      --text-primary: #ffffff;
      --text-secondary: #a0c4d8;
      --text-tertiary: #6a8da8;
      --accent-green: #34c759;
      --accent-red: #ff3b30;
      --accent-yellow: #ffcc00;
      --spacing-xs: 8px;
      --spacing-sm: 12px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
    }
        }
  </style>
</head>
<body>
  <div class="notification-toggle" id="notificationToggle" onclick="toggleNotifications()" title="Gestisci notifiche meteo">
    <img id="notifIcon" src="https://raw.githubusercontent.com/Micheledv74/previsioni/main/notifiche-disabilitate.svg" style="width: 28px; height: 28px; object-fit: contain;">
  </div>

  <div class="container">
    <header>
      <div class="header-logo">
        <img src="apple-touch-icon.png" alt="Meteo Procida Logo" class="logo-img">
        <div>
          <h1>Meteo Procida</h1>
          <div class="header-subtitle">
            <span>☀️ Previsioni 7 giorni - Analisi AI</span>
          </div>
        </div>
      </div>
      <div class="header-actions">
        <button class="action-button secondary" onclick="shareWeather()" title="Condividi previsioni">
          <img src="https://raw.githubusercontent.com/Micheledv74/previsioni/main/condividi.svg" style="width: 22px; height: 22px; object-fit: contain; filter: brightness(0) invert(1);">
        </button>
        <button class="action-button" onclick="exportToPDF()" title="Esporta PDF">
          <img src="https://raw.githubusercontent.com/Micheledv74/previsioni/main/pdf.svg" style="width: 22px; height: 22px; object-fit: contain; filter: brightness(0) invert(1);">
        </button>
      </div>
    </header>

    <div id="hero-container"></div>

    <div class="charts-section">
      <div class="chart-title">
        <img src="https://raw.githubusercontent.com/Micheledv74/previsioni/main/icons/meteocons/thermometer-celsius.svg" alt="Temperatura">
        Temperature & Precipitazioni - 7 Giorni
      </div>
      <canvas id="weatherChart" class="chart-canvas"></canvas>
    </div>

    <div class="charts-section">
      <div class="chart-title">
        <img src="https://raw.githubusercontent.com/Micheledv74/previsioni/main/icons/meteocons/barometer.svg" alt="Pressione">
        Pressione Atmosferica & Vento
      </div>
      <canvas id="pressureWindChart" class="chart-canvas"></canvas>
    </div>

    <div class="charts-section">
      <div class="chart-title">
        <img src="https://raw.githubusercontent.com/Micheledv74/previsioni/main/icons/meteocons/tide-high.svg" alt="Mare">
        Condizioni Meteomarine - 7 Giorni
      </div>
      <canvas id="marineChart" class="chart-canvas"></canvas>
    </div>

    <div id="stats-container"></div>

    <h2 class="section-title">📅 Prossimi 6 giorni</h2>
    <div id="forecast-container"></div>

    <footer>
      <p>Dati aggregati da Open-Meteo, Marine Open-Meteo, Weatherbit, Meteoblue e ilmeteo.it</p>
      <p>Analisi meteorologica professionale powered by AI</p>
      <p id="last-update"></p>
      <p style="margin-top: 10px; opacity: 0.6;">
        <span id="notification-status">Notifiche: Disattivate</span>
      </p>
    </footer>
  </div>
  <!-- MODAL RIEPILOGO/CONSIGLI/ALLERTE -->
  <div class="modal-overlay" id="modalOverlay" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-icon" id="modalIcon"></div>
        <h3 id="modalTitle"></h3>
        <button class="modal-close" onclick="closeModal()" aria-label="Chiudi">×</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

<!-- MODAL PIOGGIA -->
<div class="modal-overlay" id="rainModal" onclick="closeRainModal()">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-icon" style="color: #08a5e8;">
        <img src="https://raw.githubusercontent.com/Micheledv74/previsioni/main/icons/meteocons/raindrops.svg" style="width: 28px; height: 28px;">
      </div>
      <h3>Pioggia Oggi - <span id="rainModalDate"></span></h3>
      <button class="modal-close" onclick="closeRainModal()" aria-label="Chiudi">×</button>
    </div>
    <div class="modal-body">
      <canvas id="rainChart" style="max-height: 300px;"></canvas>
    <div id="rainviewer-alert" style="margin:8px 0;font-size:1.2em;"></div>
<div id="rainviewer-radar" style="margin-bottom:14px;"></div>
<script>
  // --- Rainviewer Alert/Radar POPUP su weatherData.rainviewer
  (function() {
    if (!window.weatherData || !weatherData.rainviewer) {
      document.getElementById("rainviewer-alert").innerHTML = "❌ Radar pioggia non disponibile";
      return;
    }
    var rv = weatherData.rainviewer;
    var rain = rv.nowcast_summary;
    var frame = rv.nowcast_frames && rv.nowcast_frames[0];
    if (!rain) {
      document.getElementById("rainviewer-alert").innerHTML = "❌ Dato radar mancante";
      return;
    }
    document.getElementById('rainviewer-alert').innerHTML =
      rain.has_rain_incoming
        ? "🚨 Pioggia in arrivo tra " + rain.rain_in_minutes + " minuti!"
        : "✅ Nessuna pioggia imminente rilevata";
    if (frame && frame.tile_url) {
      var img = document.createElement('img');
      img.src = frame.tile_url.replace('https://https://', 'https://');
      img.width = 256;
      img.height = 256;
      img.className = "radar-img";
      document.getElementById('rainviewer-radar').appendChild(img);
      var timeInfo = document.createElement('div');
      timeInfo.style="font-size:11px;color:#a0c4d8;margin-top:6px;";
      timeInfo.innerText = 'Ultima scansione radar: ' + frame.timestamp;
      document.getElementById('rainviewer-radar').appendChild(timeInfo);
    }
  })();
</script>
      <div class="rain-stats">
        <div class="rain-stat">
          <img src="https://raw.githubusercontent.com/Micheledv74/previsioni/main/icons/meteocons/raindrops.svg" class="rain-stat-icon" alt="Totale">
          <div class="rain-stat-value" id="rainTotalValue">--</div>
          <div class="rain-stat-label">Totale mm</div>
        </div>
        <div class="rain-stat">
          <img src="https://raw.githubusercontent.com/Micheledv74/previsioni/main/icons/meteocons/raindrop-measure.svg" class="rain-stat-icon" alt="Picco">
          <div class="rain-stat-value" id="rainPeakValue">--</div>
          <div class="rain-stat-label">Picco mm/h</div>
        </div>
        <div class="rain-stat">
          <img src="https://raw.githubusercontent.com/Micheledv74/previsioni/main/icons/meteocons/wi-time-2.svg" class="rain-stat-icon" alt="Durata">
          <div class="rain-stat-value" id="rainDurationValue">--</div>
          <div class="rain-stat-label">Durata ore</div>
        </div>
        <div class="rain-stat">
          <img src="https://raw.githubusercontent.com/Micheledv74/previsioni/main/icons/meteocons/barometer.svg" class="rain-stat-icon" alt="Probabilità">
          <div class="rain-stat-value" id="rainProbValue">--</div>
          <div class="rain-stat-label">Probabilità</div>
        </div>
      </div>
    </div>
  </div>
</div>
 </div>

  <!-- MODAL VENTO -->
  <div class="modal-overlay" id="windModal" onclick="closeWindModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-icon" style="color: #08a5e8;">
          <img src="https://raw.githubusercontent.com/Micheledv74/previsioni/main/icons/meteocons/wind.svg" style="width: 28px; height: 28px;">
        </div>
        <h3>Vento Oggi - <span id="windModalDate"></span></h3>
        <button class="modal-close" onclick="closeWindModal()" aria-label="Chiudi">×</button>
      </div>
      <div class="modal-body">
        <canvas id="windChart" style="max-height: 300px;"></canvas>
        
        <div class="rain-stats">
          <div class="rain-stat">
            <img src="https://raw.githubusercontent.com/Micheledv74/previsioni/main/icons/meteocons/wind.svg" class="rain-stat-icon" alt="Media">
            <div class="rain-stat-value" id="windAvgValue">--</div>
            <div class="rain-stat-label">Media Km/h</div>
          </div>
          <div class="rain-stat">
            <img src="https://raw.githubusercontent.com/Micheledv74/previsioni/main/icons/meteocons/wind-beaufort-12.svg" class="rain-stat-icon" alt="Max">
            <div class="rain-stat-value" id="windMaxValue">--</div>
            <div class="rain-stat-label">Raffica Max</div>
          </div>
          <div class="rain-stat">
            <img src="https://raw.githubusercontent.com/Micheledv74/previsioni/main/icons/meteocons/compass.svg" class="rain-stat-icon" alt="Beaufort">
            <div class="rain-stat-value" id="windBeaufortValue">--</div>
            <div class="rain-stat-label">Beaufort Max</div>
          </div>
          <div class="rain-stat">
            <img src="https://raw.githubusercontent.com/Micheledv74/previsioni/main/icons/meteocons/wind.svg" class="rain-stat-icon" alt="Dir">
            <div class="rain-stat-value" id="windDirValue">--</div>
            <div class="rain-stat-label">Direzione</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
   // FIX universale per ARRAY o OGGETTO:
let weatherDataRaw = {"ai":{}};
let weatherData;
if (Array.isArray(weatherDataRaw)) {
  weatherData = weatherDataRaw[0];
} else if (typeof weatherDataRaw === 'string') {
  try {
    const parsed = JSON.parse(weatherDataRaw);
    weatherData = Array.isArray(parsed) ? parsed[0] : parsed;
  } catch(e) {
    weatherData = null;
  }
} else {
  weatherData = weatherDataRaw;
}

    let notificationsEnabled = false;
    let rainChartInstance = null;
    let windChartInstance = null;

    const METEOCONS_CDN = 'https://raw.githubusercontent.com/Micheledv74/previsioni/main/icons/meteocons';

    const ICONS = {
      summary: `<img src="https://raw.githubusercontent.com/Micheledv74/previsioni/main/Riepilogo.svg" style="width: 1.8rem; height: 1.8rem; object-fit: contain; filter: brightness(0) saturate(100%) invert(56%) sepia(91%) saturate(2664%) hue-rotate(175deg) brightness(96%) contrast(93%);">`,
      advice: `<img src="https://raw.githubusercontent.com/Micheledv74/previsioni/main/Consigli.svg" style="width: 1.8rem; height: 1.8rem; object-fit: contain; filter: brightness(0) saturate(100%) invert(71%) sepia(98%) saturate(1714%) hue-rotate(358deg) brightness(101%) contrast(98%);">`,
      alert: `<img src="https://raw.githubusercontent.com/Micheledv74/previsioni/main/Allerte.svg" style="width: 1.8rem; height: 1.8rem; object-fit: contain; filter: brightness(0) saturate(100%) invert(28%) sepia(86%) saturate(4586%) hue-rotate(351deg) brightness(102%) contrast(105%);">`
    };

    function getWeatherIcon(summary) {
      const text = (summary || '').toLowerCase();
      let iconName = 'partly-cloudy-day.svg';
      
      if (text.includes('temporale') || text.includes('thunderstorm')) {
        iconName = 'thunderstorms-rain.svg';
      } else if (text.includes('pioggia forte') || text.includes('heavy rain')) {
        iconName = 'rain.svg';
      } else if (text.includes('pioggia') || text.includes('rain')) {
        iconName = 'drizzle.svg';
      } else if (text.includes('neve') || text.includes('snow')) {
        iconName = 'snow.svg';
      } else if (text.includes('nebbia') || text.includes('fog')) {
        iconName = 'fog.svg';
      } else if (text.includes('nuvoloso') || text.includes('cloudy')) {
        iconName = 'cloudy.svg';
      } else if (text.includes('parzialmente') || text.includes('partly')) {
        iconName = 'partly-cloudy-day.svg';
      } else if (text.includes('sereno') || text.includes('clear') || text.includes('sunny')) {
        iconName = 'clear-day.svg';
      }
      
      return `${METEOCONS_CDN}/${iconName}`;
    }

    function getBeaufortIcon(speed_kmh) {
      if (speed_kmh < 2) return 'wind-beaufort-0.svg';
      if (speed_kmh < 6) return 'wind-beaufort-1.svg';
      if (speed_kmh < 12) return 'wind-beaufort-2.svg';
      if (speed_kmh < 20) return 'wind-beaufort-3.svg';
      if (speed_kmh < 29) return 'wind-beaufort-4.svg';
      if (speed_kmh < 39) return 'wind-beaufort-5.svg';
      if (speed_kmh < 50) return 'wind-beaufort-6.svg';
      if (speed_kmh < 62) return 'wind-beaufort-7.svg';
      if (speed_kmh < 75) return 'wind-beaufort-8.svg';
      if (speed_kmh < 89) return 'wind-beaufort-9.svg';
      if (speed_kmh < 103) return 'wind-beaufort-10.svg';
      if (speed_kmh < 118) return 'wind-beaufort-11.svg';
      return 'wind-beaufort-12.svg';
    }

// ... altre utility omesse per brevità fino alla funzione openAdviceModal ...

function openSummaryModal() {
  if (!weatherData || !weatherData.days || weatherData.days.length === 0) return;
  const today = weatherData.days[0];

  // --- PRIORITÀ DATO: .ai.summary se presente! ---
  const summary = (weatherData.ai && weatherData.ai.summary) ? weatherData.ai.summary : (today.summary || 'Nessun riepilogo disponibile per oggi.');

  const content = `<p>${summary}</p>`;
  openModal('summary', 'Riepilogo Giornata', `<div style="color: #08a5e8">${ICONS.summary}</div>`, content);
}

function openAdviceModal() {
  if (!weatherData || !weatherData.days || weatherData.days.length === 0) return;
  const today = weatherData.days[0];

  // --- PRIORITÀ DATO: .ai.advice SE disponibile, SE no fallback a today.advice ---

  const adviceArr = (weatherData.ai && Array.isArray(weatherData.ai.advice)) ? weatherData.ai.advice : (today.advice || []);

  let content = '';
  if (adviceArr.length > 0) {
    content = '<ul>';
    adviceArr.forEach(adv => {
      content += `<li>${adv}</li>`;
    });
    content += '</ul>';
  } else {
    content = '<p>Nessun consiglio particolare per oggi.</p>';
  }

  openModal('advice', 'Consigli del Giorno', `<div style="color: #faa202">${ICONS.advice}</div>`, content);
}

function openAlertModal() {
  if (!weatherData || !weatherData.days || weatherData.days.length === 0) return;
  const today = weatherData.days[0];

  // --- PRIORITÀ DATO: .ai.alerts SE presente, fallback a today.alerts ---
  const alertsArr = (weatherData.ai && Array.isArray(weatherData.ai.alerts)) ? weatherData.ai.alerts : (today.alerts || []);

  let content = '';
  if (alertsArr.length > 0) {
    content = '<ul>';
    alertsArr.forEach(alert => {
      content += `<li>${alert}</li>`;
    });
    content += '</ul>';
  } else {
    content = '<p style="color: var(--accent-green);">✅ Nessuna allerta meteo attiva per oggi.</p>';
  }

  openModal('alert', 'Allerte Meteo', `<div style="color: #ff3b30">${ICONS.alert}</div>`, content);
}
function renderHero() {
  if (!weatherData || !weatherData.days || weatherData.days.length === 0) return;
  const today = weatherData.days[0];
  const tempClass = getTempClass(today.temp?.max || 20);
  const weatherIcon = getWeatherIcon(today.summary);

  // --- PRIORITÀ AI AGENT SUL RIASSUNTO NELLA HERO (box principale) ---
  const summary = (weatherData.ai && weatherData.ai.summary) ? weatherData.ai.summary : (today.summary || '');

  // puoi aggiungere altre modifiche sui consigli/allerte se vuoi riportarli in hero
  // const advices = ...  (come sopra, logic fallback)
  // const alertsArr = ...

  // ... Originale, struttura card, rimane invariata:
  // ... vedi blocchi precedenti già forniti per la hero-card ...
}

function renderStats() {
  if (!weatherData || !weatherData.weekStats) return;
  const stats = weatherData.weekStats;
  // ... tutto invariato per le stats settimanali ...
}

function renderForecast() {
  if (!weatherData || !weatherData.days || weatherData.days.length < 2) {
    document.getElementById('forecast-container').innerHTML = `
      <div class="error-message">
        <h2>⚠️ Errore nel caricamento dei dati</h2>
        <p>Impossibile recuperare le previsioni meteo. Riprova più tardi.</p>
      </div>
    `;
    return;
  }

  const futureDays = weatherData.days.slice(1);
  const html = futureDays.map(day => {
    const moonEmoji = getMoonPhaseEmoji(day.moon_phase);
    const dayIcon = getWeatherIcon(day.summary);

    return `
    <div class="day-card-compact">
      <div class="day-card-header">
        <div class="day-name">
          <img src="${dayIcon}" class="day-weather-icon" alt="Meteo">
          ${formatDate(day.date)}
        </div>
        <div class="day-temps-compact">
          <span class="temp-max">${Math.round(day.temp?.max || 20)}°</span>
          <span class="temp-min">${Math.round(day.temp?.min || 15)}°</span>
        </div>
      </div>

      ${day.summary ? `<div class="day-summary-short">${day.summary}</div>` : ''}

      <div class="day-details-row">
        ${day.rain && day.rain.probability > 0 ? `
          <div class="detail-compact">
            <img src="${METEOCONS_CDN}/raindrops.svg" alt="Pioggia">
            <div class="value">${day.rain.probability}%</div>
            <div class="label">${day.rain.total_mm}mm</div>
          </div>
        ` : ''}
        ${day.wind && day.wind.periods && day.wind.periods[0] ? `
          <div class="detail-compact">
            <img src="${METEOCONS_CDN}/${getBeaufortIcon(day.wind.periods[0].speed_kmh)}" alt="Vento">
            <div class="value">${day.wind.periods[0].speed_kmh} km/h</div>
            <div class="label">${getWindDegrees(day.wind.periods[0].direction)}° ${day.wind.periods[0].direction}</div>
          </div>
        ` : ''}
        ...
      </div>
    </div>
  `}).join('');

  document.getElementById('forecast-container').innerHTML = `<div class="days-grid">${html}</div>`;
}

function updateTimestamp() {
  if (weatherData && weatherData.generatedAt) {
    const date = new Date(weatherData.generatedAt);
    document.getElementById('last-update').textContent = 
      `Ultimo aggiornamento: ${date.toLocaleString('it-IT')}`;
  }
}

// --- Setup --- (rimane uguale)
renderHero();
renderCharts();
renderStats();
renderForecast();
updateTimestamp();

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js')
    .then(reg => console.log('Service Worker registrato'))
    .catch(err => console.log('Service Worker errore:', err));
}
</script>
</body>
</html>


