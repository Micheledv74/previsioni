<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes" />
  <title>Test Grafico Mare Dinamico</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background:#22365c; color:#f0f8ff; font-family:Roboto,Arial,sans-serif;}
    .mini-day { cursor:pointer; padding:8px 12px; background:#355088; border-radius:7px; margin:3px; display:inline-block; }
    .mini-day.active { background:#4fa9df; font-weight:700; color:#fff;}
    .sea-box { max-width:410px; margin:30px auto; padding:22px; background:rgba(37,59,102,0.22); border-radius:16px;}
  </style>
</head>
<body>
  <div id="miniDaysBox"></div>
  <div class="sea-box" id="seabox"></div>
<script>
const DATA = {
  days: [
    { day_label:"14/10", icon:"☀️" },
    { day_label:"15/10", icon:"⛅" }
  ],
  sea:[
    [ // mergedHourly per 14/10
      {time:"00:00",wave_height:0.08,sea_surface_temperature:21.9,swell_height:0.04},
      {time:"03:00",wave_height:0.09,sea_surface_temperature:22.0,swell_height:0.05},
      {time:"06:00",wave_height:0.07,sea_surface_temperature:22.3,swell_height:0.05},
      {time:"09:00",wave_height:0.06,sea_surface_temperature:22.5,swell_height:0.03},
      {time:"12:00",wave_height:0.12,sea_surface_temperature:22.6,swell_height:0.06}
    ],
    [ // mergedHourly per 15/10
      {time:"00:00",wave_height:0.04,sea_surface_temperature:21.2,swell_height:0.02},
      {time:"03:00",wave_height:0.05,sea_surface_temperature:21.7,swell_height:0.02},
      {time:"06:00",wave_height:0.05,sea_surface_temperature:21.8,swell_height:0.01},
      {time:"09:00",wave_height:0.06,sea_surface_temperature:21.9,swell_height:0.02},
      {time:"12:00",wave_height:0.10,sea_surface_temperature:22.0,swell_height:0.04}
    ]
  ]
};
let selectedDayIndex = 0;
let seaChart;

function renderMiniDays() {
  let html = "";
  DATA.days.forEach((d, i) => {
    html += `<div class="mini-day${i === selectedDayIndex ? " active" : ""}" onclick="selectDay(${i})">
        ${d.day_label} <span>${d.icon}</span>
      </div>`;
  });
  document.getElementById("miniDaysBox").innerHTML = html;
}

function selectDay(dayIndex) {
  selectedDayIndex = dayIndex;
  renderSea();
  renderMiniDays();
}
function calculateMean(arr){if(!arr.length)return 0;return arr.reduce((a,b)=>a+b,0)/arr.length;}
function calculateRange(arr){if(!arr.length)return 0;return Math.max(...arr)-Math.min(...arr);}
function calculateStdDev(arr){if(!arr.length)return 0;const m=calculateMean(arr);return Math.sqrt(arr.reduce((a,b)=>a+(b-m)**2,0)/arr.length);}

function renderSea() {
  const merged = DATA.sea[selectedDayIndex] || [];
  const waveMean = calculateMean(merged.map(h=>h.wave_height));
  const waveRange = calculateRange(merged.map(h=>h.wave_height));
  const waveStdDev = calculateStdDev(merged.map(h=>h.wave_height));
  const seaTemp = calculateMean(merged.map(h=>h.sea_surface_temperature));
  document.getElementById("seabox").innerHTML = `
    <h3>🌊 Mare ${DATA.days[selectedDayIndex].day_label}</h3>
    <div>Altezza media onda: <b>${waveMean.toFixed(2)} m</b></div>
    <div>Temperatura mare: <b>${seaTemp.toFixed(1)} °C</b></div>
    <button onclick="toggleSeaDetail()">Dettagli / Grafico</button>
    <div id="sea-detail" style="display:none;">
      <canvas id="seachart"></canvas>
    </div>
  `;
}
function toggleSeaDetail() {
  const el = document.getElementById('sea-detail');
  el.style.display = el.style.display === "none" ? "block" : "none";
  if (el.style.display === "block") {
    renderSeaChart();
  } else {
    if(seaChart) seaChart.destroy();
  }
}
function renderSeaChart() {
  const merged = DATA.sea[selectedDayIndex] || [];
  if (seaChart) seaChart.destroy();
  const ctx = document.getElementById('seachart').getContext('2d');
  seaChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: merged.map(h=>h.time),
      datasets: [
        {label:'Onda (m)',data:merged.map(h=>h.wave_height),borderColor:'#41f8bd',backgroundColor:'rgba(34,255,170,0.10)',fill:true,tension:0.22,pointRadius:2,pointBackgroundColor:'#25A9FA'},
        {label:'Swell (m)',data:merged.map(h=>h.swell_height),borderColor:'#21D08A',backgroundColor:'rgba(34,255,170,0.06)',fill:true,tension:0.18,pointRadius:2,pointBackgroundColor:'#21D08A'}
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {legend: {display: true}},
      scales: {y: {beginAtZero: true}, x:{}}
    }
  });
}

renderMiniDays();
renderSea();
</script>
</body>
</html>
