<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#012549">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <meta name="description" content="Previsioni meteo dettagliate per Procida - Analisi AI multi-fonte">
  
  <!-- PWA Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Meteo Procida">
  
  <!-- Icons per PWA -->
  <link rel="icon" type="image/png" href="apple-touch-icon.png">
  
  <title>Meteo Procida - Previsioni 7 Giorni</title>
  
  <!-- Weather Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/weather-icons/2.0.12/css/weather-icons.min.css">
  
  <!-- Chart.js Library -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      /* === COLORI DAL LOGO METEO PROCIDA === */
      --primary-blue: #012549;
      --primary-blue-light: #003d6b;
      --accent-orange: #faa202;
      --accent-cyan: #08a5e8;
      
      /* Gradazioni */
      --bg-gradient-start: #012549;
      --bg-gradient-end: #003d6b;
      --card-bg: rgba(255, 255, 255, 0.1);
      --card-border: rgba(255, 255, 255, 0.2);
      
      /* Testo */
      --text-primary: #ffffff;
      --text-secondary: #a0c4d8;
      --text-tertiary: #6a8da8;
      
      /* Accenti semantici */
      --accent-green: #34c759;
      --accent-red: #ff3b30;
      --accent-yellow: #ffcc00;
      
      /* Spacing */
      --spacing-xs: 8px;
      --spacing-sm: 12px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 0;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: var(--spacing-md);
    }

    /* === NOTIFICATION TOGGLE === */
    .notification-toggle {
      position: fixed;
      bottom: var(--spacing-lg);
      right: var(--spacing-lg);
      background: linear-gradient(135deg, var(--accent-cyan) 0%, #0077cc 100%);
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 16px rgba(8, 165, 232, 0.4);
      cursor: pointer;
      z-index: 999;
      transition: all 0.3s ease;
      font-size: 1.5rem;
    }

    .notification-toggle:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(8, 165, 232, 0.6);
    }

    .notification-toggle.active {
      background: linear-gradient(135deg, var(--accent-green) 0%, #2ea043 100%);
      animation: pulse 2s infinite;
    }

    /* === HEADER === */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-lg);
      padding: var(--spacing-md);
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      border: 1px solid var(--card-border);
      animation: fadeInUp 0.6s ease-out;
    }

    .header-logo {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
    }

    /* MODIFICA: Logo immagine al posto dell'emoji */
    .logo-img {
      width: 60px;
      height: 60px;
      object-fit: contain;
      border-radius: 12px;
      background: white;
      padding: 4px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    /* MODIFICA: Titolo pi√π grande, grassetto e azzurro */
    .header-title h1 {
      font-size: 2.2rem;
      font-weight: 800;
      color: var(--accent-cyan);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .header-subtitle {
      font-size: 0.9rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .header-actions {
      display: flex;
      gap: var(--spacing-sm);
    }

    .action-button {
      background: linear-gradient(135deg, var(--accent-orange) 0%, #ff8800 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(250, 162, 2, 0.3);
    }

    .action-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(250, 162, 2, 0.5);
    }

    .action-button.secondary {
      background: linear-gradient(135deg, var(--accent-cyan) 0%, #0077cc 100%);
      box-shadow: 0 4px 12px rgba(8, 165, 232, 0.3);
    }

    .action-button.secondary:hover {
      box-shadow: 0 6px 20px rgba(8, 165, 232, 0.5);
    }

    /* === ANIMATIONS === */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideInLeft {
      from { opacity: 0; transform: translateX(-30px); }
      to { opacity: 1; transform: translateX(0); }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }

    /* === HERO CARD === */
    .hero-card {
      background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);
      border-radius: 24px;
      padding: var(--spacing-xl);
      margin-bottom: var(--spacing-lg);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
      position: relative;
      overflow: hidden;
      min-height: 50vh;
      animation: fadeInUp 0.8s ease-out;
      border: 1px solid rgba(8, 165, 232, 0.2);
    }

    .hero-card.hot { background: linear-gradient(135deg, #ff6b6b 0%, var(--accent-orange) 100%); }
    .hero-card.warm { background: linear-gradient(135deg, var(--accent-orange) 0%, #ff6348 100%); }
    .hero-card.mild { background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%); }
    .hero-card.cool { background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--primary-blue-light) 100%); }
    .hero-card.cold { background: linear-gradient(135deg, #a8edea 0%, var(--accent-cyan) 100%); }

    .hero-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-lg);
    }

    .hero-location {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      font-size: 1.1rem;
      font-weight: 500;
      opacity: 0.9;
    }

    .hero-date {
      font-size: 0.95rem;
      opacity: 0.8;
    }

    .hero-main {
      text-align: center;
      margin: var(--spacing-xl) 0;
    }

    .hero-temp {
      font-size: 80px;
      font-weight: 700;
      line-height: 1;
      margin-bottom: var(--spacing-sm);
      text-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      animation: fadeIn 1s ease-out;
    }

    .hero-condition {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-sm);
      font-size: 1.5rem;
      font-weight: 500;
      margin-bottom: var(--spacing-md);
    }

    .hero-condition i {
      font-size: 3rem;
      animation: fadeIn 1.2s ease-out;
    }

    .hero-minmax {
      display: flex;
      justify-content: center;
      gap: var(--spacing-lg);
      font-size: 1.2rem;
      margin-bottom: var(--spacing-lg);
    }

    .hero-minmax span {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      transition: transform 0.3s ease;
    }

    .hero-minmax span:hover {
      transform: translateY(-2px);
    }

    .hero-summary {
      background: rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: var(--spacing-md);
      font-size: 1.05rem;
      line-height: 1.6;
      margin-bottom: var(--spacing-md);
      animation: slideInLeft 0.8s ease-out;
    }

    /* === ADVICE PILLS === */
    .advice-pills {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-xs);
      margin-bottom: var(--spacing-md);
    }

    .advice-pill {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: var(--spacing-xs) var(--spacing-md);
      font-size: 0.9rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .advice-pill:hover {
      background: rgba(255, 255, 255, 0.35);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    /* === DETAILS PILLS === */
    .details-pills {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: var(--spacing-sm);
    }

    .detail-pill {
      background: rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: var(--spacing-sm);
      text-align: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .detail-pill:hover {
      background: rgba(0, 0, 0, 0.3);
      transform: translateY(-4px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    .detail-pill i {
      font-size: 1.8rem;
      display: block;
      margin-bottom: 4px;
      opacity: 0.9;
      transition: transform 0.3s ease;
    }

    .detail-pill:hover i {
      transform: scale(1.1);
    }

    .detail-pill .value {
      font-size: 1.1rem;
      font-weight: 600;
      display: block;
      margin-bottom: 2px;
    }

    .detail-pill .label {
      font-size: 0.75rem;
      opacity: 0.8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .detail-pill.rain-detail i { color: var(--accent-cyan); }
    .detail-pill.temp-detail i { color: var(--accent-orange); }
    
    /* MODIFICA: AQI come minicard con colori dinamici */
    .detail-pill.aqi-pill {
      cursor: default;
    }
    
    .detail-pill.aqi-pill.good i { color: var(--accent-green); }
    .detail-pill.aqi-pill.moderate i { color: var(--accent-yellow); }
    .detail-pill.aqi-pill.unhealthy i { color: var(--accent-orange); }
    .detail-pill.aqi-pill.bad i { color: var(--accent-red); }

    /* === MOON PHASE === */
    .moon-phase-pill {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .moon-emoji {
      font-size: 2rem;
      display: block;
      margin-bottom: 4px;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    /* === WIND ROSE === */
    .wind-rose-container {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .wind-rose-svg {
      width: 100%;
      height: 100%;
      transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .detail-pill:hover .wind-rose-svg {
      transform: rotate(15deg);
    }

    /* === CHARTS CONTAINER === */
    .charts-section {
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
      animation: fadeInUp 0.6s ease-out;
      animation-delay: 0.3s;
      opacity: 0;
      animation-fill-mode: forwards;
    }

    .chart-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: var(--spacing-md);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      color: var(--accent-cyan);
    }

    .chart-canvas {
      max-height: 300px;
    }

    /* === STATS GRID === */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-lg);
    }

    .stat-card {
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: var(--spacing-md);
      text-align: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      opacity: 0;
      animation: fadeInUp 0.6s ease-out forwards;
    }

    .stat-card:nth-child(1) { animation-delay: 0.5s; }
    .stat-card:nth-child(2) { animation-delay: 0.6s; }
    .stat-card:nth-child(3) { animation-delay: 0.7s; }
    .stat-card:nth-child(4) { animation-delay: 0.8s; }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      background: rgba(255, 255, 255, 0.12);
    }

    .stat-card i {
      font-size: 2rem;
      margin-bottom: var(--spacing-xs);
      display: block;
      transition: transform 0.3s ease;
    }

    .stat-card:hover i {
      transform: scale(1.1) rotate(5deg);
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      margin: var(--spacing-xs) 0;
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    /* === SECTION TITLE === */
    .section-title {
      font-size: 1.3rem;
      font-weight: 600;
      margin: var(--spacing-xl) 0 var(--spacing-md) 0;
      padding-left: var(--spacing-xs);
      animation: slideInLeft 0.6s ease-out;
    }

    /* === DAY CARDS === */
    .days-grid {
      display: grid;
      gap: var(--spacing-md);
    }

    .day-card-compact {
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--card-border);
      border-radius: 20px;
      padding: var(--spacing-lg);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      opacity: 0;
      animation: fadeInUp 0.6s ease-out forwards;
    }

    .day-card-compact:nth-child(1) { animation-delay: 0.9s; }
    .day-card-compact:nth-child(2) { animation-delay: 1.0s; }
    .day-card-compact:nth-child(3) { animation-delay: 1.1s; }
    .day-card-compact:nth-child(4) { animation-delay: 1.2s; }
    .day-card-compact:nth-child(5) { animation-delay: 1.3s; }
    .day-card-compact:nth-child(6) { animation-delay: 1.4s; }

    .day-card-compact:hover {
      transform: translateY(-6px);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.4);
      background: rgba(255, 255, 255, 0.14);
      border-color: rgba(8, 165, 232, 0.4);
    }

    .day-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
    }

    .day-name {
      font-size: 1.2rem;
      font-weight: 600;
      transition: color 0.3s ease;
    }

    .day-card-compact:hover .day-name {
      color: var(--accent-cyan);
    }

    .day-temps-compact {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      font-size: 1.5rem;
    }

    .temp-max { 
      font-weight: 700; 
      color: var(--accent-orange);
      transition: transform 0.3s ease;
    }

    .day-card-compact:hover .temp-max {
      transform: scale(1.1);
    }

    .temp-min { 
      color: var(--text-secondary); 
    }

    .day-summary-short {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-md);
      line-height: 1.5;
    }

    .day-details-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: var(--spacing-sm);
      margin-top: var(--spacing-md);
    }

    .detail-compact {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      padding: var(--spacing-sm);
      text-align: center;
      font-size: 0.85rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .detail-compact:hover {
      background: rgba(0, 0, 0, 0.35);
      transform: translateY(-2px);
    }

    .detail-compact i {
      display: block;
      font-size: 1.3rem;
      margin-bottom: 4px;
      opacity: 0.8;
      transition: transform 0.3s ease;
    }

    .detail-compact:hover i {
      transform: scale(1.15);
    }

    .detail-compact .value {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .detail-compact .label {
      font-size: 0.75rem;
      opacity: 0.7;
    }

    /* === ALERTS === */
    .alerts {
      background: rgba(255, 59, 48, 0.15);
      border-left: 4px solid var(--accent-red);
      border-radius: 12px;
      padding: var(--spacing-md);
      margin: var(--spacing-md) 0;
      font-size: 0.9rem;
      animation: pulse 2s ease-in-out infinite;
    }

    .alerts strong {
      display: block;
      margin-bottom: var(--spacing-xs);
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    /* === FOOTER === */
    footer {
      text-align: center;
      margin-top: var(--spacing-xl);
      padding: var(--spacing-lg);
      color: var(--text-secondary);
      font-size: 0.85rem;
      opacity: 0;
      animation: fadeIn 1s ease-out forwards;
      animation-delay: 1.5s;
    }

    footer p {
      margin: 6px 0;
    }

    .error-message {
      background: rgba(255, 59, 48, 0.2);
      border: 1px solid var(--accent-red);
      border-radius: 20px;
      padding: var(--spacing-xl);
      text-align: center;
      margin: var(--spacing-lg) 0;
      animation: fadeInUp 0.6s ease-out;
    }

    /* === RESPONSIVE === */
    @media (max-width: 768px) {
      .container { padding: var(--spacing-sm); }
      header { flex-direction: column; gap: var(--spacing-md); }
      .header-actions { width: 100%; }
      .action-button { flex: 1; justify-content: center; }
      .logo-img { width: 50px; height: 50px; }
      .header-title h1 { font-size: 1.8rem; }
      .hero-card { padding: var(--spacing-lg); min-height: 60vh; }
      .hero-temp { font-size: 72px; }
      .hero-condition { font-size: 1.3rem; }
      .hero-condition i { font-size: 2.5rem; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .details-pills { grid-template-columns: repeat(3, 1fr); }
      .day-details-row { grid-template-columns: repeat(2, 1fr); }
      .notification-toggle { bottom: 100px; }
    }

    @media (max-width: 390px) {
      .hero-temp { font-size: 64px; }
      .details-pills { grid-template-columns: repeat(2, 1fr); }
    }

    /* === PRINT STYLES === */
    @media print {
      body { background: white; color: black; }
      header .action-button, footer, .notification-toggle { display: none; }
      .hero-card, .day-card-compact { page-break-inside: avoid; border: 1px solid #ddd; }
      * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
  </style>
</head>
<body>
  <!-- Notification Toggle Button -->
  <div class="notification-toggle" id="notificationToggle" onclick="toggleNotifications()" title="Attiva notifiche meteo">
    üîî
  </div>

  <div class="container">
    <!-- HEADER con Logo Immagine -->
    <header>
      <div class="header-logo">
        <img src="apple-touch-icon.png" alt="Meteo Procida Logo" class="logo-img">
        <div>
          <h1>Meteo Procida</h1>
          <div class="header-subtitle">
            <i class="wi wi-day-sunny"></i>
            <span>Previsioni 7 giorni - Analisi AI</span>
          </div>
        </div>
      </div>
      <div class="header-actions">
        <button class="action-button secondary" onclick="shareWeather()">
          üì§ Condividi
        </button>
        <button class="action-button" onclick="exportToPDF()">
          üì• PDF
        </button>
      </div>
    </header>

    <!-- HERO CARD -->
    <div id="hero-container"></div>

    <!-- CHARTS AVANZATI (Chart.js) -->
    <div class="charts-section">
      <div class="chart-title">
        <i class="wi wi-thermometer"></i>
        Temperature & Precipitazioni - 7 Giorni
      </div>
      <canvas id="weatherChart" class="chart-canvas"></canvas>
    </div>

    <div class="charts-section">
      <div class="chart-title">
        <i class="wi wi-barometer"></i>
        Pressione Atmosferica & Vento
      </div>
      <canvas id="pressureWindChart" class="chart-canvas"></canvas>
    </div>

    <!-- SEZIONE: GRAFICI CONDIZIONI MARINE -->
    <div class="charts-section">
      <div class="chart-title">
        <i class="wi wi-tsunami"></i>
        Condizioni Meteomarine - 7 Giorni
      </div>
      <canvas id="marineChart" class="chart-canvas"></canvas>
    </div>

    <!-- STATS -->
    <div id="stats-container"></div>

    <!-- GIORNI 2-7 -->
    <h2 class="section-title">üìÖ Prossimi 6 giorni</h2>
    <div id="forecast-container"></div>

    <footer>
      <p>Dati aggregati da Open-Meteo, Marine Open-Meteo, Weatherbit, Meteoblue e ilmeteo.it</p>
      <p>Analisi meteorologica professionale powered by AI</p>
      <p id="last-update"></p>
      <p style="margin-top: 10px; opacity: 0.6;">
        <span id="notification-status">Notifiche: Disattivate</span>
      </p>
    </footer>
  </div>

  <script>
    // === DATI METEO ===
    const weatherData = {"location":"Procida, Italia","generatedAt":"2023-10-27T10:00:00Z","totalDays":7,"weekStats":{"maxTemp":22,"minTemp":15,"avgTemp":"19.8","rainyDays":4},"days":[{"date":"2025-10-21","temp":{"min":17.6,"max":19.3,"feels_like":18.5},"rain":{"probability":85,"total_mm":13,"periods":[{"start":"09:00","end":"12:00","intensity":"moderata"},{"start":"15:00","end":"18:30","intensity":"leggera"}]},"wind":{"periods":[{"start":"00:00","end":"10:00","speed_kmh":15,"gusts_kmh":25,"direction":"SE","intensity":"moderato"},{"start":"10:00","end":"23:59","speed_kmh":28,"gusts_kmh":45,"direction":"S","intensity":"forte"}]},"pressure":{"value_hPa":1010,"trend":"in calo"},"sea":{"condition":"mosso","wave_height_m":1.5,"swell_direction":"Sud","temperature_c":19.5},"humidity":85,"uv_index":3,"sunrise":"07:15","sunset":"18:25","moon_phase":"Luna nuova","air_quality":{"aqi":150,"level":"Malsana per sensibili","pm25":30,"pm10":50,"no2":25,"o3":60},"summary":"La giornata si preannuncia con cielo coperto e piogge moderate a partire dalle 09:00 fino a mezzogiorno. Un temporaneo miglioramento √® previsto nel primo pomeriggio, ma le precipitazioni, di intensit√† pi√π leggera, torneranno a interessare l'isola dalle 15:00 fino alle 18:30. Il vento rinforzer√† gradualmente da Sud-Est nel corso della mattinata, diventando forte dal pomeriggio con raffiche che potranno toccare i 45 km/h. Le condizioni del mare saranno mosse, con onde fino a 1.5 metri, rendendo sconsigliabile la navigazione per le imbarcazioni di piccola e media stazza. La qualit√† dell'aria √® classificata come malsana per i soggetti sensibili.","advice":["√à consigliabile portare con s√© un ombrello e indossare abbigliamento impermeabile per gran parte della giornata, specialmente al mattino e nel tardo pomeriggio.","Evitare attivit√† nautiche e prestare massima attenzione lungo le coste, data la condizione di mare mosso e le onde significative.","Assicurare tutti gli oggetti esterni come vasi, arredi da giardino e ombrelloni a causa delle raffiche di vento previste.","Qualit√† aria malsana per soggetti sensibili: si consiglia di limitare l'attivit√† fisica all'aperto, specialmente per bambini, anziani e persone con problemi respiratori."],"alerts":[]},{"date":"2025-10-22","temp":{"min":16,"max":18.5,"feels_like":17},"rain":{"probability":70,"total_mm":8.5,"periods":[{"start":"06:00","end":"10:00","intensity":"leggera"},{"start":"20:00","end":"23:00","intensity":"moderata"}]},"wind":{"periods":[{"start":"00:00","end":"12:00","speed_kmh":20,"gusts_kmh":30,"direction":"SW","intensity":"moderato"},{"start":"12:00","end":"23:59","speed_kmh":10,"gusts_kmh":20,"direction":"NW","intensity":"leggero"}]},"pressure":{"value_hPa":1012,"trend":"stabile"},"sea":{"condition":"poco mosso","wave_height_m":0.8,"swell_direction":"Sud-Ovest","temperature_c":19.3},"humidity":80,"uv_index":2,"sunrise":"07:16","sunset":"18:24","moon_phase":"Luna crescente","summary":"La giornata di marted√¨ inizier√† con piogge leggere tra le 06:00 e le 10:00, seguite da un'ampia finestra di tempo variabile con ampie schiarite e nuvolosit√† sparsa. In serata, le precipitazioni torneranno a farsi sentire con intensit√† moderata tra le 20:00 e le 23:00. Il vento, inizialmente moderato da Sud-Ovest, tender√† a diminuire nel pomeriggio, girando a Nord-Ovest e diventando leggero. Il mare sar√† poco mosso, con onde intorno agli 0.8 metri, offrendo condizioni migliori rispetto al giorno precedente per le attivit√† marittime.","advice":["Un impermeabile leggero sar√† utile al mattino e in tarda serata. Le ore centrali della giornata potrebbero essere pi√π gradevoli.","Le condizioni del mare migliorano, ma √® sempre consigliabile cautela per le piccole imbarcazioni.","Approfittare delle ore centrali per attivit√† all'aperto, ma tenere d'occhio il cielo per le piogge serali."],"alerts":[]},{"date":"2025-10-23","temp":{"min":15,"max":19,"feels_like":16.5},"rain":{"probability":10,"total_mm":0,"periods":[]},"wind":{"periods":[{"start":"00:00","end":"23:59","speed_kmh":8,"gusts_kmh":15,"direction":"N","intensity":"leggero"}]},"pressure":{"value_hPa":1015,"trend":"in aumento"},"sea":{"condition":"calmo","wave_height_m":0.4,"swell_direction":"Nord","temperature_c":19.1},"humidity":75,"uv_index":4,"sunrise":"07:17","sunset":"18:22","moon_phase":"Primo quarto","summary":"Mercoled√¨ si prospetta una giornata prevalentemente soleggiata su Procida. Dopo una mattinata fresca, le temperature massime raggiungeranno i 19¬∞C. Non sono previste precipitazioni. Il vento sar√† leggero per tutta la giornata, proveniente da Nord, garantendo condizioni piacevoli. Il mare si presenter√† calmo, con onde minime inferiori ai 0.5 metri, ideale per la navigazione e le attivit√† acquatiche. L'indice UV sar√† moderato, indicando la necessit√† di una leggera protezione solare nelle ore centrali.","advice":["Ottima giornata per le passeggiate e le attivit√† all'aperto. Non sono necessari particolari accorgimenti per la pioggia.","Le condizioni di mare calmo sono perfette per la navigazione, la pesca o altre attivit√† in barca.","Considerare una leggera protezione solare nelle ore pi√π calde, nonostante l'autunno."],"alerts":[]},{"date":"2025-10-24","temp":{"min":15.5,"max":20,"feels_like":17.5},"rain":{"probability":20,"total_mm":0,"periods":[]},"wind":{"periods":[{"start":"00:00","end":"08:00","speed_kmh":10,"gusts_kmh":18,"direction":"NE","intensity":"leggero"},{"start":"08:00","end":"23:59","speed_kmh":22,"gusts_kmh":35,"direction":"E","intensity":"moderato"}]},"pressure":{"value_hPa":1014,"trend":"stabile"},"sea":{"condition":"poco mosso","wave_height_m":0.7,"swell_direction":"Est","temperature_c":19},"humidity":70,"uv_index":3,"sunrise":"07:18","sunset":"18:21","moon_phase":"Primo quarto","summary":"Gioved√¨ vedr√† un cielo parzialmente nuvoloso con ampi spazi di sereno. Le temperature si manterranno miti, con massime intorno ai 20¬∞C. La probabilit√† di pioggia √® molto bassa, quindi la giornata sar√† asciutta. Il vento, inizialmente leggero da Nord-Est, tender√† a rinforzare nel corso della mattinata, diventando moderato da Est con raffiche fino a 35 km/h. Il mare sar√† poco mosso, con un leggero aumento dell'altezza delle onde rispetto al giorno precedente. Le condizioni generali saranno comunque buone per le attivit√† all'aperto.","advice":["La giornata sar√† piacevole per attivit√† esterne. Non √® richiesto l'ombrello.","Il vento moderato da Est potrebbe influenzare leggermente la navigazione, specialmente per le piccole imbarcazioni che si dirigono verso Est.","Approfittare del clima mite, ma prestare attenzione al vento in rinforzo nel pomeriggio."],"alerts":[]},{"date":"2025-10-25","temp":{"min":17,"max":22,"feels_like":19},"rain":{"probability":90,"total_mm":20,"periods":[{"start":"03:00","end":"08:00","intensity":"forte"},{"start":"13:00","end":"17:00","intensity":"moderata"}]},"wind":{"periods":[{"start":"00:00","end":"12:00","speed_kmh":30,"gusts_kmh":48,"direction":"SE","intensity":"forte"},{"start":"12:00","end":"23:59","speed_kmh":40,"gusts_kmh":60,"direction":"S","intensity":"molto forte"}]},"pressure":{"value_hPa":1005,"trend":"in forte calo"},"sea":{"condition":"molto mosso","wave_height_m":2.5,"swell_direction":"Sud-Est","temperature_c":19},"humidity":90,"uv_index":1,"sunrise":"07:19","sunset":"18:20","moon_phase":"Gibbosa crescente","summary":"Venerd√¨ sar√† una giornata di maltempo significativo. Sono previste piogge forti nelle prime ore del mattino (dalle 03:00 alle 08:00) e successivamente piogge moderate nel pomeriggio (dalle 13:00 alle 17:00). Le temperature massime raggiungeranno i 22¬∞C, ma l'umidit√† sar√† molto elevata. Il vento sar√† forte da Sud-Est al mattino, per poi intensificarsi ulteriormente nel pomeriggio, diventando molto forte da Sud con raffiche che potranno superare i 60 km/h. Il mare sar√† molto mosso, con onde fino a 2.5 metri, rendendo le condizioni estremamente pericolose per la navigazione.","advice":["Si raccomanda di rimanere al riparo. Le piogge saranno intense e persistenti, e il vento molto forte.","Evitare assolutamente qualsiasi attivit√† nautica. Il mare sar√† molto agitato e pericoloso.","Mettere in sicurezza oggetti esposti a vento e pioggia; sono possibili disagi e raffiche dannose."],"alerts":["Allerta meteo: piogge abbondanti e forti raffiche di vento. Si raccomanda la massima cautela e di limitare gli spostamenti."]},{"date":"2025-10-26","temp":{"min":16.5,"max":19.5,"feels_like":17},"rain":{"probability":60,"total_mm":5,"periods":[{"start":"09:00","end":"13:00","intensity":"leggera"}]},"wind":{"periods":[{"start":"00:00","end":"06:00","speed_kmh":35,"gusts_kmh":55,"direction":"S","intensity":"molto forte"},{"start":"06:00","end":"18:00","speed_kmh":25,"gusts_kmh":40,"direction":"SW","intensity":"forte"},{"start":"18:00","end":"23:59","speed_kmh":18,"gusts_kmh":28,"direction":"W","intensity":"moderato"}]},"pressure":{"value_hPa":1010,"trend":"in aumento"},"sea":{"condition":"molto mosso","wave_height_m":2.2,"swell_direction":"Sud-Ovest","temperature_c":18.8},"humidity":85,"uv_index":2,"sunrise":"07:20","sunset":"18:19","moon_phase":"Gibbosa crescente","summary":"Sabato si aprir√† con condizioni ancora instabili. Il vento, molto forte da Sud nelle prime ore del mattino, tender√† a calare gradualmente, diventando forte da Sud-Ovest fino al pomeriggio e poi moderato da Ovest in serata. Sono previste piogge leggere tra le 09:00 e le 13:00. Il mare rimarr√† molto mosso, seppur con un lieve calo dell'altezza delle onde rispetto a venerd√¨. Le temperature si manterranno fresche, con massime intorno ai 19.5¬∞C. La giornata sar√† caratterizzata da una progressiva, lenta diminuzione dell'intensit√† dei fenomeni.","advice":["Nonostante un miglioramento, il vento sar√† ancora significativo nelle prime ore e il mare molto mosso. Prestare massima attenzione.","Le piogge saranno pi√π leggere e limitate. Un ombrello o un k-way potrebbero essere ancora utili al mattino.","Continuare a monitorare le condizioni marine; la navigazione √® ancora sconsigliata per le piccole imbarcazioni."],"alerts":[]},{"date":"2025-10-27","temp":{"min":16,"max":20,"feels_like":17.5},"rain":{"probability":15,"total_mm":0,"periods":[]},"wind":{"periods":[{"start":"00:00","end":"23:59","speed_kmh":12,"gusts_kmh":22,"direction":"W","intensity":"leggero"}]},"pressure":{"value_hPa":1013,"trend":"stabile"},"sea":{"condition":"poco mosso","wave_height_m":0.9,"swell_direction":"Ovest","temperature_c":18.7},"humidity":78,"uv_index":3,"sunrise":"07:21","sunset":"18:18","moon_phase":"Luna piena","summary":"Domenica si prevede una giornata con tempo in deciso miglioramento. Il cielo sar√† parzialmente nuvoloso, ma senza previsioni di pioggia. Le temperature si manterranno gradevoli, con massime intorno ai 20¬∞C. Il vento sar√† leggero per tutto il giorno, proveniente da Ovest, contribuendo a rendere l'atmosfera pi√π mite. Le condizioni del mare saranno poco mosse, con onde contenute sotto il metro, rendendo il fine settimana pi√π favorevole per le attivit√† all'aperto e marittime rispetto ai giorni precedenti. La pressione atmosferica sar√† stabile.","advice":["Giornata ideale per godersi l'isola e le attivit√† all'aperto, senza preoccupazioni per la pioggia.","Le condizioni del mare sono favorevoli per la navigazione e per piccole escursioni in barca, ma √® sempre buona norma consultare i bollettini locali.","Approfittare del clima mite e del vento leggero per passeggiate panoramiche o relax in spiaggia."],"alerts":[]}],"processedAt":"2025-10-22T06:05:55.906Z"};

    // === GLOBALS ===
    let notificationsEnabled = false;

    // === HELPER FUNCTIONS ===
    function formatDate(dateStr) {
      const date = new Date(dateStr);
      const giorni = ['Domenica', 'Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨', 'Sabato'];
      const mesi = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
      
      if (isNaN(date.getTime())) {
        console.error('Data non valida:', dateStr);
        return 'Data non valida';
      }
      
      return `${giorni[date.getDay()]} ${date.getDate()} ${mesi[date.getMonth()]}`;
    }

    function getShortDate(dateStr) {
      const date = new Date(dateStr);
      const giorni = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];
      
      if (isNaN(date.getTime())) {
        console.error('Data non valida:', dateStr);
        return '---';
      }
      
      return giorni[date.getDay()];
    }

    function getWeatherIcon(summary) {
      const text = (summary || '').toLowerCase();
      if (text.includes('temporale')) return 'wi-thunderstorm';
      if (text.includes('pioggia forte')) return 'wi-rain';
      if (text.includes('pioggia')) return 'wi-showers';
      if (text.includes('neve')) return 'wi-snow';
      if (text.includes('nebbia')) return 'wi-fog';
      if (text.includes('nuvoloso')) return 'wi-cloudy';
      if (text.includes('parzialmente')) return 'wi-day-cloudy';
      if (text.includes('sereno')) return 'wi-day-sunny';
      return 'wi-day-cloudy';
    }

    function getTempClass(temp) {
      if (temp >= 28) return 'hot';
      if (temp >= 22) return 'warm';
      if (temp >= 15) return 'mild';
      if (temp >= 8) return 'cool';
      return 'cold';
    }

    // MODIFICA: Mapping migliorato fasi lunari
    function getMoonPhaseEmoji(phaseText) {
      if (!phaseText) return 'üåï';
      const phase = phaseText.toLowerCase();
      
      // Luna nuova
      if (phase.includes('nuova') || phase.includes('new moon')) return 'üåë';
      
      // Crescente
      if (phase.includes('primo quarto') || phase.includes('first quarter')) return 'üåì';
      if (phase.includes('crescente')) return 'üåí';
      if (phase.includes('gibbosa crescente') || phase.includes('waxing gibbous')) return 'üåî';
      
      // Luna piena
      if (phase.includes('piena') || phase.includes('full moon')) return 'üåï';
      
      // Calante
      if (phase.includes('gibbosa calante') || phase.includes('waning gibbous')) return 'üåñ';
      if (phase.includes('ultimo quarto') || phase.includes('last quarter')) return 'üåó';
      if (phase.includes('calante')) return 'üåò';
      
      // Fallback basato su percentuale illuminazione (se presente nel testo)
      if (phase.match(/\d+%/)) {
        const percentage = parseInt(phase.match(/\d+/)[0]);
        if (percentage < 10) return 'üåë';
        if (percentage < 40) return 'üåí';
        if (percentage < 60) return 'üåì';
        if (percentage < 90) return 'üåî';
        if (percentage < 110) return 'üåï';
        if (percentage < 140) return 'üåñ';
        if (percentage < 160) return 'üåó';
        return 'üåò';
      }
      
      return 'üåï';
    }

    function createWindRoseSVG(direction, speed) {
      const angle = getWindAngle(direction);
      return `
        <svg class="wind-rose-svg" viewBox="0 0 100 100" style="transform: rotate(${angle}deg)">
          <circle cx="50" cy="50" r="48" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="2"/>
          <text x="50" y="12" text-anchor="middle" fill="rgba(255,255,255,0.6)" font-size="10" font-weight="600">N</text>
          <path d="M 50 20 L 55 40 L 50 35 L 45 40 Z" fill="#08a5e8" opacity="0.9"/>
          <path d="M 50 35 L 50 70" stroke="#08a5e8" stroke-width="3" stroke-linecap="round"/>
          <circle cx="50" cy="50" r="5" fill="#08a5e8"/>
        </svg>
      `;
    }

    function getWindAngle(direction) {
      const directions = {
        'N': 0, 'NE': 45, 'E': 90, 'SE': 135, 'S': 180, 'SW': 225, 'W': 270, 'NW': 315,
        'NNE': 22.5, 'ENE': 67.5, 'ESE': 112.5, 'SSE': 157.5,
        'SSW': 202.5, 'WSW': 247.5, 'WNW': 292.5, 'NNW': 337.5,
        'SSO': 202.5, 'SO': 225, 'OSO': 247.5, 'O': 270, 'ONO': 292.5, 'NO': 315, 'NNO': 337.5
      };
      return directions[direction?.toUpperCase()] || 0;
    }

    // MODIFICA: Funzioni AQI per minicard
    function getAQIClass(aqi) {
      if (aqi <= 50) return 'good';
      if (aqi <= 100) return 'moderate';
      if (aqi <= 150) return 'unhealthy';
      return 'bad';
    }

    function getAQILevel(aqi) {
      if (aqi <= 50) return 'Buona';
      if (aqi <= 100) return 'Moderata';
      if (aqi <= 150) return 'Sensibili';
      return 'Malsana';
    }

    function getAQIEmoji(aqi) {
      if (aqi <= 50) return 'üòä';
      if (aqi <= 100) return 'üòê';
      if (aqi <= 150) return 'üò∑';
      return 'üò®';
    }

    // === FUNCTIONS ===
    function exportToPDF() {
      window.print();
    }

    async function shareWeather() {
      if (!weatherData || !weatherData.days || weatherData.days.length === 0) return;
      const today = weatherData.days[0];
      const text = `Meteo Procida oggi: ${Math.round(today.temp?.max || 20)}¬∞C\n${today.summary || 'Consulta le previsioni complete'}`;
      
      if (navigator.share) {
        try {
          await navigator.share({
            title: 'Meteo Procida',
            text: text,
            url: window.location.href
          });
        } catch (err) {
          console.log('Share cancelled');
        }
      } else {
        alert('Condivisione non supportata su questo browser');
      }
    }

    // === NOTIFICHE ===
    async function toggleNotifications() {
      if (!('Notification' in window)) {
        alert('Notifiche non supportate su questo browser');
        return;
      }

      if (Notification.permission === 'granted') {
        notificationsEnabled = !notificationsEnabled;
        updateNotificationUI();
        if (notificationsEnabled) {
          sendTestNotification();
        }
      } else if (Notification.permission !== 'denied') {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
          notificationsEnabled = true;
          updateNotificationUI();
          sendTestNotification();
        }
      } else {
        alert('Notifiche bloccate. Abilitale dalle impostazioni del browser.');
      }
    }

    function updateNotificationUI() {
      const toggle = document.getElementById('notificationToggle');
      const status = document.getElementById('notification-status');
      
      if (notificationsEnabled) {
        toggle.classList.add('active');
        toggle.innerHTML = 'üîî';
        status.textContent = 'Notifiche: Attive ‚úì';
      } else {
        toggle.classList.remove('active');
        toggle.innerHTML = 'üîï';
        status.textContent = 'Notifiche: Disattivate';
      }
    }

    function sendTestNotification() {
      if (!weatherData || !weatherData.days || weatherData.days.length === 0) return;
      const today = weatherData.days[0];
      
      new Notification('Meteo Procida', {
        body: `Oggi: ${Math.round(today.temp?.max || 20)}¬∞C - ${today.summary?.substring(0, 100) || 'Consulta le previsioni'}`,
        icon: 'apple-touch-icon.png',
        badge: 'apple-touch-icon.png',
        tag: 'meteo-update'
      });
    }

    function checkWeatherAlerts() {
      if (!notificationsEnabled || !weatherData) return;
      
      weatherData.days.forEach((day, index) => {
        if (day.alerts && day.alerts.length > 0 && index === 0) {
          new Notification('‚ö†Ô∏è Allerta Meteo Procida', {
            body: day.alerts[0],
            icon: 'apple-touch-icon.png',
            tag: 'weather-alert',
            requireInteraction: true
          });
        }
      });
    }

    // === RENDER HERO ===
    function renderHero() {
      if (!weatherData || !weatherData.days || weatherData.days.length === 0) return;
      
      const today = weatherData.days[0];
      const tempClass = getTempClass(today.temp?.max || 20);
      const weatherIcon = getWeatherIcon(today.summary);
      const moonEmoji = getMoonPhaseEmoji(today.moon_phase);
      
      const html = `
        <div class="hero-card ${tempClass}">
          <div class="hero-header">
            <div class="hero-location">
              <i class="wi wi-horizon"></i>
              ${weatherData.location || 'Procida'}
            </div>
            <div class="hero-date">${formatDate(today.date)}</div>
          </div>

          <div class="hero-main">
            <div class="hero-temp">${Math.round(today.temp?.max || 20)}¬∞</div>
            <div class="hero-condition">
              <i class="wi ${weatherIcon}"></i>
              <span>${getConditionText(today)}</span>
            </div>
            <div class="hero-minmax">
              <span><i class="wi wi-direction-down"></i>${Math.round(today.temp?.min || 15)}¬∞</span>
              <span><i class="wi wi-direction-up"></i>${Math.round(today.temp?.max || 20)}¬∞</span>
            </div>
          </div>

          ${today.summary ? `<div class="hero-summary">${today.summary}</div>` : ''}

          ${today.advice && today.advice.length > 0 ? `
            <div class="advice-pills">
              ${today.advice.map(a => `<div class="advice-pill">üí° ${a}</div>`).join('')}
            </div>
          ` : ''}

          ${today.alerts && today.alerts.length > 0 ? `
            <div class="alerts">
              <strong>‚ö†Ô∏è ALLERTE METEO</strong>
              ${today.alerts.map(a => `<p>${a}</p>`).join('')}
            </div>
          ` : ''}

          <div class="details-pills">
            ${today.rain && today.rain.probability > 0 ? `
              <div class="detail-pill rain-detail">
                <i class="wi wi-raindrop"></i>
                <span class="value">${today.rain.probability}%</span>
                <span class="label">Pioggia</span>
              </div>
            ` : ''}
            
            ${today.wind && today.wind.periods && today.wind.periods[0] ? `
              <div class="detail-pill">
                <div class="wind-rose-container">
                  ${createWindRoseSVG(today.wind.periods[0].direction, today.wind.periods[0].speed_kmh)}
                </div>
                <span class="value">${today.wind.periods[0].speed_kmh} km/h</span>
                <span class="label">${today.wind.periods[0].direction}</span>
              </div>
            ` : ''}

            ${today.humidity ? `
              <div class="detail-pill">
                <i class="wi wi-humidity"></i>
                <span class="value">${today.humidity}%</span>
                <span class="label">Umidit√†</span>
              </div>
            ` : ''}

            ${today.uv_index ? `
              <div class="detail-pill temp-detail">
                <i class="wi wi-day-sunny"></i>
                <span class="value">${today.uv_index}</span>
                <span class="label">UV</span>
              </div>
            ` : ''}

            ${today.pressure ? `
              <div class="detail-pill">
                <i class="wi wi-barometer"></i>
                <span class="value">${today.pressure.value_hPa}</span>
                <span class="label">hPa</span>
              </div>
            ` : ''}

            ${today.sea ? `
              <div class="detail-pill rain-detail">
                <i class="wi wi-tsunami"></i>
                <span class="value">${today.sea.wave_height_m}m</span>
                <span class="label">${today.sea.condition}</span>
              </div>
            ` : ''}

            ${today.sunrise ? `
              <div class="detail-pill temp-detail">
                <i class="wi wi-sunrise"></i>
                <span class="value">${today.sunrise}</span>
                <span class="label">Alba</span>
              </div>
            ` : ''}

            ${today.sunset ? `
              <div class="detail-pill temp-detail">
                <i class="wi wi-sunset"></i>
                <span class="value">${today.sunset}</span>
                <span class="label">Tramonto</span>
              </div>
            ` : ''}

            ${today.moon_phase ? `
              <div class="detail-pill moon-phase-pill">
                <span class="moon-emoji">${moonEmoji}</span>
                <span class="label">${today.moon_phase}</span>
              </div>
            ` : ''}

            ${today.air_quality && today.air_quality.aqi ? `
              <div class="detail-pill aqi-pill ${getAQIClass(today.air_quality.aqi)}">
                <i class="wi wi-dust"></i>
                <span class="value">${today.air_quality.aqi}</span>
                <span class="label">${getAQILevel(today.air_quality.aqi)}</span>
              </div>
            ` : ''}
          </div>
        </div>
      `;
      
      document.getElementById('hero-container').innerHTML = html;
    }

    function getConditionText(day) {
      if (day.rain && day.rain.probability > 70) return 'Pioggia';
      if (day.rain && day.rain.probability > 40) return 'Possibile pioggia';
      const summary = (day.summary || '').toLowerCase();
      if (summary.includes('sereno')) return 'Sereno';
      if (summary.includes('nuvoloso')) return 'Nuvoloso';
      return 'Variabile';
    }

    // === CHART.JS GRAFICI ===
    function renderCharts() {
      if (!weatherData || !weatherData.days || weatherData.days.length === 0) {
        console.warn('‚ùå Dati meteo non disponibili per i grafici');
        return;
      }

      console.log('üé® Creazione grafici...', weatherData.days.length, 'giorni');

      const labels = weatherData.days.map(d => getShortDate(d.date));
      const temps = weatherData.days.map(d => d.temp?.max || 20);
      const tempsMins = weatherData.days.map(d => d.temp?.min || 15);
      const rains = weatherData.days.map(d => d.rain?.total_mm || 0);
      const pressures = weatherData.days.map(d => d.pressure?.value_hPa || 1013);
      const winds = weatherData.days.map(d => d.wind?.periods?.[0]?.speed_kmh || 0);
      const waveHeights = weatherData.days.map(d => d.sea?.wave_height_m || 0);
      const seaTemps = weatherData.days.map(d => d.sea?.temperature_c || 18);

      try {
        // Grafico 1: Temperature & Precipitazioni
        const ctx1 = document.getElementById('weatherChart');
        if (!ctx1) return;
        
        new Chart(ctx1.getContext('2d'), {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'Temp Max (¬∞C)',
                data: temps,
                borderColor: '#faa202',
                backgroundColor: 'rgba(250, 162, 2, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 7
              },
              {
                label: 'Temp Min (¬∞C)',
                data: tempsMins,
                borderColor: '#08a5e8',
                backgroundColor: 'rgba(8, 165, 232, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 7
              },
              {
                label: 'Pioggia (mm)',
                data: rains,
                type: 'bar',
                backgroundColor: 'rgba(8, 165, 232, 0.6)',
                borderColor: '#08a5e8',
                borderWidth: 2,
                yAxisID: 'y1'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { labels: { color: '#a0c4d8', font: { size: 12 } } },
              tooltip: {
                backgroundColor: 'rgba(1, 37, 73, 0.9)',
                titleColor: '#fff',
                bodyColor: '#a0c4d8',
                borderColor: '#08a5e8',
                borderWidth: 1
              }
            },
            scales: {
              y: {
                type: 'linear',
                display: true,
                position: 'left',
                ticks: { color: '#a0c4d8' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
              },
              y1: {
                type: 'linear',
                display: true,
                position: 'right',
                ticks: { color: '#08a5e8' },
                grid: { drawOnChartArea: false }
              },
              x: {
                ticks: { color: '#a0c4d8' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
              }
            }
          }
        });
        console.log('‚úÖ Grafico Temperature creato');
      } catch (error) {
        console.error('‚ùå Errore grafico Temperature:', error);
      }

      try {
        // Grafico 2: Pressione & Vento
        const ctx2 = document.getElementById('pressureWindChart');
        if (!ctx2) return;
        
        new Chart(ctx2.getContext('2d'), {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'Pressione (hPa)',
                data: pressures,
                borderColor: '#34c759',
                backgroundColor: 'rgba(52, 199, 89, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 7
              },
              {
                label: 'Vento (km/h)',
                data: winds,
                borderColor: '#faa202',
                backgroundColor: 'rgba(250, 162, 2, 0.1)',
                borderWidth: 3,
                fill: false,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 7,
                yAxisID: 'y1'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { labels: { color: '#a0c4d8', font: { size: 12 } } },
              tooltip: {
                backgroundColor: 'rgba(1, 37, 73, 0.9)',
                titleColor: '#fff',
                bodyColor: '#a0c4d8',
                borderColor: '#08a5e8',
                borderWidth: 1
              }
            },
            scales: {
              y: {
                ticks: { color: '#34c759' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
              },
              y1: {
                type: 'linear',
                display: true,
                position: 'right',
                ticks: { color: '#faa202' },
                grid: { drawOnChartArea: false }
              },
              x: {
                ticks: { color: '#a0c4d8' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
              }
            }
          }
        });
        console.log('‚úÖ Grafico Pressione creato');
      } catch (error) {
        console.error('‚ùå Errore grafico Pressione:', error);
      }

      try {
        // Grafico 3: Condizioni Meteomarine
        const ctx3 = document.getElementById('marineChart');
        if (!ctx3) return;
        
        new Chart(ctx3.getContext('2d'), {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'Altezza Onde (m)',
                data: waveHeights,
                borderColor: '#08a5e8',
                backgroundColor: 'rgba(8, 165, 232, 0.2)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 7
              },
              {
                label: 'Temperatura Mare (¬∞C)',
                data: seaTemps,
                borderColor: '#faa202',
                backgroundColor: 'rgba(250, 162, 2, 0.1)',
                borderWidth: 3,
                fill: false,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 7,
                yAxisID: 'y1'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { labels: { color: '#a0c4d8', font: { size: 12 } } },
              tooltip: {
                backgroundColor: 'rgba(1, 37, 73, 0.9)',
                titleColor: '#fff',
                bodyColor: '#a0c4d8',
                borderColor: '#08a5e8',
                borderWidth: 1
              }
            },
            scales: {
              y: {
                ticks: { color: '#08a5e8' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                title: { display: true, text: 'Altezza Onde (m)', color: '#08a5e8' }
              },
              y1: {
                type: 'linear',
                display: true,
                position: 'right',
                ticks: { color: '#faa202' },
                grid: { drawOnChartArea: false },
                title: { display: true, text: 'Temperatura (¬∞C)', color: '#faa202' }
              },
              x: {
                ticks: { color: '#a0c4d8' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
              }
            }
          }
        });
        console.log('‚úÖ Grafico Mare creato');
      } catch (error) {
        console.error('‚ùå Errore grafico Mare:', error);
      }
    }

    // === RENDER STATS ===
    function renderStats() {
      if (!weatherData || !weatherData.weekStats) return;
      const stats = weatherData.weekStats;
      
      const html = `
        <div class="stats-grid">
          <div class="stat-card">
            <i class="wi wi-thermometer" style="color: var(--accent-orange);"></i>
            <div class="stat-value">${stats.maxTemp}¬∞C</div>
            <div class="stat-label">Max Settimana</div>
          </div>
          <div class="stat-card">
            <i class="wi wi-thermometer-exterior" style="color: var(--accent-cyan);"></i>
            <div class="stat-value">${stats.minTemp}¬∞C</div>
            <div class="stat-label">Min Settimana</div>
          </div>
          <div class="stat-card">
            <i class="wi wi-thermometer" style="color: var(--accent-green);"></i>
            <div class="stat-value">${stats.avgTemp}¬∞C</div>
            <div class="stat-label">Media</div>
          </div>
          <div class="stat-card">
            <i class="wi wi-rain" style="color: var(--accent-cyan);"></i>
            <div class="stat-value">${stats.rainyDays}</div>
            <div class="stat-label">Giorni Pioggia</div>
          </div>
        </div>
      `;
      
      document.getElementById('stats-container').innerHTML = html;
    }

    // === RENDER FORECAST ===
    function renderForecast() {
      if (!weatherData || !weatherData.days || weatherData.days.length < 2) {
        document.getElementById('forecast-container').innerHTML = `
          <div class="error-message">
            <h2>‚ö†Ô∏è Errore nel caricamento dei dati</h2>
            <p>Impossibile recuperare le previsioni meteo. Riprova pi√π tardi.</p>
          </div>
        `;
        return;
      }

      const futureDays = weatherData.days.slice(1);
      const html = futureDays.map(day => {
        const moonEmoji = getMoonPhaseEmoji(day.moon_phase);
        
        return `
        <div class="day-card-compact">
          <div class="day-card-header">
            <div class="day-name">${formatDate(day.date)}</div>
            <div class="day-temps-compact">
              <span class="temp-max">${Math.round(day.temp?.max || 20)}¬∞</span>
              <span class="temp-min">${Math.round(day.temp?.min || 15)}¬∞</span>
            </div>
          </div>

          ${day.summary ? `<div class="day-summary-short">${day.summary}</div>` : ''}

          ${day.advice && day.advice.length > 0 ? `
            <div class="advice-pills">
              ${day.advice.slice(0, 2).map(a => `<div class="advice-pill">üí° ${a}</div>`).join('')}
            </div>
          ` : ''}

          ${day.alerts && day.alerts.length > 0 ? `
            <div class="alerts">
              <strong>‚ö†Ô∏è ALLERTE</strong>
              ${day.alerts.map(a => `<p>${a}</p>`).join('')}
            </div>
          ` : ''}

          <div class="day-details-row">
            ${day.rain && day.rain.probability > 0 ? `
              <div class="detail-compact">
                <i class="wi wi-raindrop" style="color: var(--accent-cyan);"></i>
                <div class="value">${day.rain.probability}%</div>
                <div class="label">${day.rain.total_mm}mm</div>
              </div>
            ` : ''}

            ${day.wind && day.wind.periods && day.wind.periods[0] ? `
              <div class="detail-compact">
                <div style="width: 40px; height: 40px; margin: 0 auto 4px;">
                  ${createWindRoseSVG(day.wind.periods[0].direction, day.wind.periods[0].speed_kmh)}
                </div>
                <div class="value">${day.wind.periods[0].speed_kmh} km/h</div>
                <div class="label">${day.wind.periods[0].direction}</div>
              </div>
            ` : ''}

            ${day.sea ? `
              <div class="detail-compact">
                <i class="wi wi-tsunami" style="color: var(--accent-cyan);"></i>
                <div class="value">${day.sea.wave_height_m}m</div>
                <div class="label">${day.sea.condition}</div>
              </div>
            ` : ''}

            ${day.humidity ? `
              <div class="detail-compact">
                <i class="wi wi-humidity"></i>
                <div class="value">${day.humidity}%</div>
                <div class="label">Umidit√†</div>
              </div>
            ` : ''}

            ${day.uv_index ? `
              <div class="detail-compact">
                <i class="wi wi-day-sunny" style="color: var(--accent-orange);"></i>
                <div class="value">${day.uv_index}</div>
                <div class="label">UV Index</div>
              </div>
            ` : ''}

            ${day.pressure ? `
              <div class="detail-compact">
                <i class="wi wi-barometer"></i>
                <div class="value">${day.pressure.value_hPa}</div>
                <div class="label">${day.pressure.trend || 'hPa'}</div>
              </div>
            ` : ''}

            ${day.moon_phase ? `
              <div class="detail-compact">
                <span style="font-size: 1.5rem; display: block; margin-bottom: 4px;">${moonEmoji}</span>
                <div class="label">${day.moon_phase}</div>
              </div>
            ` : ''}
          </div>
        </div>
      `}).join('');

      document.getElementById('forecast-container').innerHTML = `<div class="days-grid">${html}</div>`;
    }

    function updateTimestamp() {
      if (weatherData && weatherData.generatedAt) {
        const date = new Date(weatherData.generatedAt);
        document.getElementById('last-update').textContent = 
          `Ultimo aggiornamento: ${date.toLocaleString('it-IT')}`;
      }
    }

    // === INIZIALIZZAZIONE ===
    renderHero();
    renderCharts();
    renderStats();
    renderForecast();
    updateTimestamp();
    
    setTimeout(checkWeatherAlerts, 2000);

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(reg => console.log('Service Worker registrato'))
        .catch(err => console.log('Service Worker errore:', err));
    }
  </script>
</body>
</html>
