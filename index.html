<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Previsioni Procida - Stile AccuWeather</title>
  <style>
    body { font-family: Arial, max-width: 920px; margin: auto; background: linear-gradient(#182948,#374058); color: #fff; padding: 30px;}
    .tabs { display: flex; gap: 8px; margin-bottom: 24px; }
    .tab { background: rgba(255,255,255,0.12); border: 1px solid #333b4a; padding: 16px 28px; border-radius: 8px; cursor: pointer;}
    .tab.active { background: #0580ff; color: #fff; border-bottom: 3px solid #fff;}
    .card { background: rgba(255,255,255,0.08); border-radius:16px; padding:24px; margin-bottom:18px; }
    .bigicon { font-size:68px; }
    .tempmax { font-size:32px; font-weight:bold; }
    .tempmin { font-size:20px; color:#9bdfff; }
    .details { font-size:17px; color:#b2b9cd;}
    .underline { border-bottom: 1.5px solid #224;}
    canvas { background: rgba(255,255,255,0.12); border-radius:8px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div id="tabbar" class="tabs"></div>
  <div id="daycard"></div>
  <div id="chartcontainer"></div>
  <script>
    // Mappa dei codici Open-Meteo → emoji
    function iconFromCode(code, hour) {
      if (code === 0) return hour >= 6 && hour < 20 ? "☀️" : "🌙";
      if (code === 1) return hour >= 6 && hour < 20 ? "🌤️" : "☁️";
      if ([2,3].includes(code)) return "⛅";
      if ([45,48].includes(code)) return "🌫️";
      if ([51,53,55].includes(code)) return "🌦️";
      if ([56,57].includes(code)) return "🌧️";
      if ([61,63,65].includes(code)) return "🌦️";
      if ([66,67].includes(code)) return "🌧️";
      if ([71,73,75,77,85,86].includes(code)) return "❄️";
      if ([80,81,82].includes(code)) return "🌧️";
      if ([95,96,99].includes(code)) return "🌩️";
      return "☁️";
    }

    // Estrai dati dal backend n8n
    const days = [{"day_label":"08/10","temp_max":"20.2","temp_min":"19.9","precipitation":"0.00","icon":"☁️","hourly_labels":["22:00","23:00"],"hourly_temps":[20.2,19.9],"hourly_winds":[8.2,10],"hourly_precips":[0,0]},{"day_label":"09/10","temp_max":"20.5","temp_min":"18.8","precipitation":"0.00","icon":"🌤️","hourly_labels":["00:00","01:00","02:00","03:00","04:00","05:00","06:00","07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"],"hourly_temps":[19.8,19.7,19.6,19.1,19.1,18.9,18.8,18.9,19.2,19.5,19.9,20.2,20.3,20.4,20.4,20.5,20.5,20.5,20.5,20.4,20.3,20.3,20.2,20.2],"hourly_winds":[10.6,10.2,10,10.5,11,10.3,10.2,9.7,9.2,8.9,9.7,10.5,11.1,10.5,10,9.5,8,6.5,5,4.4,4,3.8,3.4,4.2],"hourly_precips":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},{"day_label":"10/10","temp_max":"21.5","temp_min":"19.2","precipitation":"0.00","icon":"⛅","hourly_labels":["00:00","01:00","02:00","03:00","04:00","05:00","06:00","07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"],"hourly_temps":[20.1,19.8,19.6,19.5,19.4,19.3,19.2,19.2,19.6,19.9,20.2,20.8,21,21.1,21.2,21.3,21.4,21.5,21,21.1,21.2,21,20.7,20.6],"hourly_winds":[5.5,6.6,7.3,7,5.8,5.8,6.9,6,5.8,4.9,4.6,3.3,3,4.6,3.9,2.8,3,3.6,8.3,7.8,7.9,8.7,8.7,7.4],"hourly_precips":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},{"day_label":"11/10","temp_max":"23.6","temp_min":"20.2","precipitation":"0.00","icon":"☀️","hourly_labels":["00:00","01:00","02:00","03:00","04:00","05:00","06:00","07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"],"hourly_temps":[20.6,20.4,20.2,20.2,20.3,20.2,20.2,20.3,20.7,21.3,22,22.7,23.2,23.6,23.4,22.8,21.9,21.7,21.6,21.7,21.7,21.4,21,20.8],"hourly_winds":[6.9,6.9,6.8,7.7,7.9,7.9,8.2,8.7,9.7,9.3,9.3,7.7,6.1,3.5,4,6.5,10.2,10.5,10.8,10.1,8.7,7.7,8.4,9.6],"hourly_precips":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},{"day_label":"12/10","temp_max":"21.4","temp_min":"19.5","precipitation":"0.00","icon":"☀️","hourly_labels":["00:00","01:00","02:00","03:00","04:00","05:00","06:00","07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"],"hourly_temps":[20.6,20.4,20.1,19.9,19.7,19.6,19.5,19.7,20,20.3,20.6,20.9,21.2,21.3,21.4,21.3,21.2,20.9,20.8,20.7,20.8,20.8,20.7,20.6],"hourly_winds":[10.3,10.2,9.5,8.9,8.9,9.2,8.7,8.2,7.2,5.8,3.3,2.1,3.8,5.4,7.1,8,7.6,6.5,5.8,5.4,5.1,4.4,3.2,1.1],"hourly_precips":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},{"day_label":"13/10","temp_max":"20.9","temp_min":"19.8","precipitation":"0.00","icon":"🌤️","hourly_labels":["00:00","01:00","02:00","03:00","04:00","05:00","06:00","07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"],"hourly_temps":[20.5,20.3,20.1,20,19.9,19.8,19.8,19.8,19.9,20,20.2,20.6,20.8,20.9,20.8,20.7,20.6,20.6,20.5,20.4,20.4,20.3,20.2,20.1],"hourly_winds":[0.4,1.3,1.8,2.1,1.5,0.8,1.3,1.5,1.6,1.1,0.5,2.6,4.8,6.6,8.4,9.4,9.5,8.8,7.8,6,3.8,1.9,0.4,1.3],"hourly_precips":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},{"day_label":"14/10","temp_max":"21.2","temp_min":"19.1","precipitation":"0.00","icon":"⛅","hourly_labels":["00:00","01:00","02:00","03:00","04:00","05:00","06:00","07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"],"hourly_temps":[20.1,20.1,19.8,19.5,19.3,19.1,19.1,19.3,19.6,19.9,20.3,20.6,20.9,21.1,21.2,21.2,21.1,20.9,20.7,20.6,20.5,20.4,20.2,19.9],"hourly_winds":[2.3,4,5.9,7,7.7,8.4,8.7,9.4,9.8,10.1,10.2,10.2,10.6,10.4,10,9.5,8.4,7.1,7.3,10,15.1,19.3,22.2,24],"hourly_precips":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},{"day_label":"15/10","temp_max":"19.6","temp_min":"16.0","precipitation":"40.20","icon":"🌧️","hourly_labels":["00:00","01:00","02:00","03:00","04:00","05:00","06:00","07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00"],"hourly_temps":[19.6,19.4,19.2,19,18.6,18.1,17.6,17.3,17,16.7,16.4,16.2,16,16,16.1,16.2,16.4,16.6,16.8,16.9,16.8,16.8],"hourly_winds":[24.8,23.4,21.1,20.2,22.1,25.5,28.8,30.6,31.7,32.7,33.5,34.3,34.9,35.4,35.4,35.4,34.6,33.6,32.8,32.6,32.1,31.6],"hourly_precips":[0,0,0,0,0.9,0.9,0.9,3.1,3.1,3.1,2.4,2.4,2.4,4.3,4.3,4.3,1.3,1.3,1.3,1.4,1.4,1.4]}];
    let current = 0;

    // Tab interattivi
    function renderTabs() {
      const tabbar = document.getElementById('tabbar');
      tabbar.innerHTML = '';
      days.forEach((d, idx) => {
        // Scegli l'ora delle 14 come ora centrale per l'icona (se disponibile)
        const middayIdx = d.hourly_labels.findIndex(h => h.startsWith('14')) !== -1
          ? d.hourly_labels.findIndex(h => h.startsWith('14'))
          : Math.floor(d.icons ? d.icons.length/2 : d.hourly_labels.length/2);
        const baseIcon = d.icons ? d.icons[middayIdx] : iconFromCode(d.weather_code ? d.weather_code : 0, 14);
        el = document.createElement('div');
        el.className = idx === current ? 'tab active' : 'tab';
        el.innerHTML = `<div class="bigicon">${d.icon || baseIcon}</div>
          <div>${d.day_label}</div>
          <div><span class="tempmax">${d.temp_max}°</span> <span class="tempmin">${d.temp_min}°</span></div>`;
        el.onclick = () => { current = idx; renderAll(); };
        tabbar.appendChild(el);
      });
    }

    // Card giorno
    function renderCard() {
      const d = days[current];
      document.getElementById('daycard').innerHTML = `<div class="card underline">
        <div style="display:flex;align-items:center;">
          <div class="bigicon">${d.icon}</div>
          <div style="margin-left:20px;">
            <div class="tempmax">${d.temp_max}°C <span class="tempmin">${d.temp_min}°C</span></div>
            <div class="details">Precipitazioni: ${d.precipitation} mm<br>
            Aggiornamento: 09/10/2025, 09:37:01</div>
          </div>
        </div>
      </div>`;
    }

    // Grafico temperatura, labels → bianche
    let chart = null;
    function renderChart() {
      const d = days[current];
      const chartDiv = document.getElementById('chartcontainer');
      chartDiv.innerHTML = `<div class="card"><canvas id="chart" width="775" height="240"></canvas></div>`;
      const ctx = document.getElementById('chart').getContext('2d');
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: d.hourly_labels,
          datasets: [{
            label: 'Temperatura (°C)',
            data: d.hourly_temps,
            borderColor: 'rgba(255,214,91,1)',
            backgroundColor: 'rgba(255,214,91,0.15)',
            fill: true,
            tension: 0.3,
            pointRadius: 2
          }]
        },
        options: {
          plugins: { 
            legend: { display:true, labels: { color:'#fff', font: {weight:'bold', size:16} } }
          },
          scales: {
            y: { beginAtZero: false, title: { display: true, text: '°C', color: '#fff' }, ticks: { color:'#fff', font: {weight:'bold'} }},
            x: { title: { display: true, text: 'Ora locale', color:'#fff' }, ticks: { color: '#fff', font: {weight:'bold', size:16}, maxRotation:0, minRotation:0 } }
          }
        }
      });
    }

    // Render
    function renderAll() {
      if (!days || days.length === 0) {
        document.body.innerHTML = "<h2 style='color:#fff'>Nessun dato meteo disponibile!</h2>";
        return;
      }
      renderTabs();
      renderCard();
      renderChart();
    }
    renderAll();
  </script>
</body>
</html>
