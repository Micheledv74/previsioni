<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes" />
  <title>Previsioni Procida - Dashboard Meteo</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Roboto&display=swap');
    html { box-sizing: border-box;} *,*:before,*:after { box-sizing: inherit; }
    body { font-family: 'Roboto', Arial, sans-serif; max-width: 1150px; margin: 0 auto; background: linear-gradient(135deg, #24325a, #3498db 95%); color: #e0f6ff; padding: 14px 2px 22px 2px; overflow-x: hidden; min-height: 100vh; }
    .header { font-family: 'Montserrat', sans-serif; font-size: 2.7em; font-weight: 900; text-align: center; color: #e7f7ff; text-shadow: 1px 2px 17px #09172a; letter-spacing: 2px; user-select: none; margin-bottom: 22px; }
    .dashboard { display: flex; flex-wrap: wrap; gap: 18px 26px; justify-content: center; }
    .box { background: rgba(37,59,102,0.25); border-radius: 18px; box-shadow: 0 5px 26px #06214661; padding: 17px 14px 35px 14px; flex: 1 1 270px; max-width: 360px; min-width: 215px; display: flex; flex-direction: column; align-items: center; margin-bottom: 5px; position: relative;}
    .box-title { font-size: 1.17rem; font-weight: 900; color: #a6e9ff; letter-spacing: 1px; margin-bottom: 11px; font-family: 'Montserrat', sans-serif; }
    .box .main { font-weight: 700; font-size: 1.13em; color:#84dbff;}
    .box .desc { margin: 2px 0 0 0; font-size:1.01em; color:#c3ccdf;}
    button.detail-btn { margin-top:11px; background: #127af7; color: #fff; font-weight:700; border: none; border-radius: 8px; padding: 11px 24px; cursor: pointer; transition: background 0.12s;}
    button.detail-btn.active, button.detail-btn:hover { background: #45bafe;}
    .detail-section { max-height: 0; opacity: 0; overflow: hidden; transition: max-height 0.34s, opacity 0.2s; margin-top: 13px;width: 100%;}
    .detail-section.active { max-height: 430px; opacity: 1; }
    .chart-wrap { width: 99%; max-width: 370px; margin: 0 auto 16px auto; border-radius: 13px; background: #213260d0; padding: 11px 5px 7px 5px;}
    .fixed-info { width: 98%; position: absolute; bottom: 16px; left: 0; display: flex; justify-content: space-around; font-weight:700; font-size:1em;}
    .fixed-info .info { padding: 4px 12px; border-radius: 7px; margin: 0 2px;}
    .info-wind { background: #41d7e595; color:#16345c;}
    .info-sea { background: #62fae382; color:#1a3f44;}
    .info-press { background: #ffd472a3; color:#55430a;}
    .info-rain { background: #45bafea6; color:#194058;}
    .wind-rose { margin-top: 9px; width: 88px; height: 88px; display: flex;justify-content:center;align-items:center; background: #fff2; border-radius: 50%; position: relative;}
    .wind-arrow { width:38px; height:38px; position: absolute; left:50%;top:50%;transform:translate(-50%,-50%) rotate(0deg); transform-origin: 50% 80%;transition:transform 0.18s;}
    .wind-arrow svg { width:100%; height:100%;}
    .wind-rose-label { position: absolute; font-size:0.70em;color:#ffffffd8;font-family:'Montserrat';}
    .wind-rose-label.n { top:6px; left:50%; transform:translateX(-50%);}
    .wind-rose-label.s { bottom:6px; left:50%; transform:translateX(-50%);}
    .wind-rose-label.e { left:70px; top:50%; transform:translateY(-50%);}
    .wind-rose-label.w { left:5px; top:50%; transform:translateY(-50%);}
    .today-wide-card { width:99.7%; max-width: 1050px; margin:18px auto 16px auto; background: #144879f5; box-shadow:0 0 20px #0ab7e755; border-radius:18px; padding:16px 33px 20px 28px;color:#fdf7e7;font-weight:600;display:flex;flex-direction:row;align-items:center;justify-content:space-between;font-size:1.14em;transition:background 0.19s;}
    .today-wide-card .icon {font-size:2.6em; margin-right:25px;}
    .today-wide-card .meta {display:inline-block;}
    .today-wide-card .tmax {color:#ffd472;}
    .today-wide-card .tmin {color:#7edbff;}
    .today-wide-card .wind {color:#86caff;}
    .today-wide-card .rain {color:#9fffe1;}
    .mini-days-grid { width:99%; margin:0 auto 4px auto; display: grid; grid-template-columns: repeat(3,1fr); grid-gap:19px 19px;}
    .mini-day { background: #0b1333b0; color: #c6f3ff; border-radius:13px; padding:14px 13px; font-size:1.10em; min-width:90px; box-shadow: 0 2px 8px #202b3b44;cursor: pointer;transition:background 0.21s, color 0.17s;}
    .mini-day.selected { background: #61cfff; color: #fff2c2; box-shadow:0 0 13px #75eafd88; font-weight:900;}
    .mini-day .daylabel { font-weight:700; color:#fff;}
    .mini-day .icon {font-size:1.22em; vertical-align:-3px;}
    .mini-day .tmax {color:#ffd472;}
    .mini-day .tmin {color:#6fd7f8;}
    .mini-day .wind {color:#86caff;}
    .mini-day .rain {color:#7fffd4;}
    .advice-box {width: 90%;margin:9px auto 8px auto;font-size:1.08em;border-radius:7px;padding:9px 12px;text-align:center;font-weight:700;background:#c2fff842;color:#1a7352;}
    .alert-box {width: 90%;margin:0 auto 14px auto;font-size:1.08em;border-radius:7px;padding:8px 13px;text-align:center;font-weight:700;background:#fff3c258;color:#7a3d14;}
    .footer { margin-top: 35px; text-align: center; color: #dbefff; font-size:17px; font-weight:500; text-shadow:0 2px 6px #283c5880;}
    @media (max-width:1100px){ body{max-width:99vw;} .today-wide-card{font-size:1em;} .mini-days-grid{grid-template-columns:repeat(2,1fr);} }
    @media (max-width:820px){ .dashboard{gap:12px;} .box{min-width:170px;max-width:95vw;} .today-wide-card{padding:12px 8px;font-size:0.97em;} }
    @media (max-width:700px){ .dashboard{flex-direction:column;align-items:center;gap:17px;} .box{width:100%;max-width:97vw;} .header{font-size:1.13em;} .today-wide-card{flex-direction:column;align-items:flex-start;} }
    @media (max-width:570px){ .mini-days-grid{grid-template-columns:repeat(1,1fr);} .mini-day{padding:9px 6px;} .today-wide-card{padding:9px 5px;font-size:0.94em;} }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="header">PREVISIONI METEO PROCIDA</div>
  <div class="dashboard" id="dashboard">
    <section class="box vento" id="windbox"></section>
    <section class="box pioggia" id="rainbox"></section>
    <section class="box mare" id="seabox"></section>
    <section class="box pressione" id="pressbox"></section>
  </div>
  <div id="todayCard"></div>
  <div class="mini-days-grid" id="miniDaysGrid"></div>
  <div class="footer" id="footer"></div>
<script>
// Inserisci qui il tuo oggetto dati JSON reale di n8n:
const DATA = /* Il tuo JSON n8n fornito in modo asincrono o statico, esempio:
{
  "days": [...],
  "mergedHourly": [...],
  "alerts": [...],
  "advice": "...",
  "updated_at": "..."
}
*/ ;

// Permetti la selezione del giorno e la propagazione su tutti i box
let selectedDayIndex = 0;
let windChart, rainChart, seaChart, pressChart;

function windDirectionName(deg){if(deg==null)return "--";const winds=[{name:"Tramontana",abbr:"N"},{name:"Grecale",abbr:"NE"},{name:"Levante",abbr:"E"},{name:"Scirocco",abbr:"SE"},{name:"Ostro",abbr:"S"},{name:"Libeccio",abbr:"SO"},{name:"Ponente",abbr:"O"},{name:"Maestrale",abbr:"NO"}];const idx=Math.floor(((deg+22.5)%360)/45);return winds[idx]?winds[idx].name+" ("+winds[idx].abbr+")":"N/D";}
function calculateMean(arr){if(!arr.length)return 0;return arr.reduce((a,b)=>a+b,0)/arr.length;}
function calculateRange(arr){if(!arr.length)return 0;return Math.max(...arr)-Math.min(...arr);}
function calculateStdDev(arr){if(!arr.length)return 0;const m=calculateMean(arr);return Math.sqrt(arr.reduce((a,b)=>a+(b-m)**2,0)/arr.length);}
function rainIcon(valmm){if(valmm<0.1)return'';if(valmm<0.5)return'üíß';if(valmm<1)return'üíßüíß';if(valmm<3)return'üíßüíßüíß';if(valmm<10)return'üíßüíßüíßüíß';return'üíßüíßüíßüíßüíß';}
function pressureTrend(arr){if(!arr||arr.length<5)return "N/D";const meanStart=(arr[0]+arr[1]+arr[2])/3,meanEnd=(arr[arr.length-3]+arr[arr.length-2]+arr[arr.length-1])/3;if(meanEnd>meanStart+1)return'in aumento ‚¨ÜÔ∏è (alta)';if(meanStart>meanEnd+1)return'in calo ‚¨áÔ∏è (bassa)';return'stabile ‚óºÔ∏è';}

function toggleDetail(id) {
  const section = document.getElementById(id);
  const btn = section.previousElementSibling;
  document.querySelectorAll('.detail-section').forEach(e=>e.id!==id&&e.classList.remove('active'));
  document.querySelectorAll('.detail-btn').forEach(b=>b!==btn&&b.classList.remove('active'));
  section.classList.toggle('active');
  btn.classList.toggle('active', section.classList.contains('active'));
}

// Gestione selezione card giorno/meteo
function selectDay(idx){
  selectedDayIndex = idx;
  renderAll();
}
// --- Render Vento con rosa e grafico tooltip interattivi ---
function renderWind() {
  const d = DATA.days[selectedDayIndex];
  const currentHour = new Date().getHours();
  const windSpeed = d.hourlywinds ? d.hourlywinds[currentHour] : d.wind_max || "--";
  const windDeg = d.hourlywinddirections ? d.hourlywinddirections[currentHour] : d.wind_dir || "--";
  const windDirTxt = windDirectionName(windDeg);
  document.getElementById("windbox").innerHTML = `
    <div class="box-title">üå¨Ô∏è Vento</div>
    <div class="main">Corrente: <b>${windSpeed} km/h</b></div>
    <div class="desc">Direzione: <b>${windDeg}¬∞</b> ${windDirTxt}</div>
    <div class="wind-rose" id="windRose">
      <span class="wind-rose-label n">N</span>
      <span class="wind-rose-label s">S</span>
      <span class="wind-rose-label e">E</span>
      <span class="wind-rose-label w">O</span>
      <div class="wind-arrow" id="windArrow">
        <svg viewBox="0 0 32 32"><polygon points="16,2 22,22 16,18 10,22" fill="#61cfff" stroke="#145377" stroke-width="1"/></svg>
      </div>
    </div>
    <div class="main">Folata max: <b>${d.wind_gust || d.wind_max || "--"} km/h</b></div>
    <button class="detail-btn" onclick="toggleDetail('wind-detail')">Dettagli / Grafico</button>
    <div class="detail-section" id="wind-detail">
      <div class="chart-wrap"><canvas id="windchart"></canvas></div>
      <div class="fixed-info">
        <span class="info info-wind">Massimo: ${d.hourlywinds ? Math.max(...d.hourlywinds) : "--"} km/h</span>
        <span class="info info-wind">Minimo: ${d.hourlywinds ? Math.min(...d.hourlywinds) : "--"} km/h</span>
        <span class="info info-wind">Dir. max: ${windDirectionName(d.hourlywinddirections ? Math.max(...d.hourlywinddirections) : d.wind_dir)}</span>
      </div>
    </div>
  `;
  document.getElementById("windArrow").style.transform = `translate(-50%,-50%) rotate(${windDeg}deg)`;
  setTimeout(() => {
    if (windChart) { windChart.destroy(); }
    const ctx = document.getElementById('windchart').getContext('2d');
    windChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: d.hourlylabels || [],
        datasets: [{
          label: 'Vento (km/h)', data: d.hourlywinds || [],
          borderColor: '#66E5FF', backgroundColor: 'rgba(90,184,255,0.12)',
          fill: true, tension: 0.21, pointRadius: 1
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false }, tooltip: { enabled: true, mode: 'nearest', intersect: false } },
        onHover: event => {
          const points = windChart.getElementsAtEventForMode(event, 'nearest', { intersect: false }, false);
          if (points.length) {
            const idx = points[0].index;
            document.getElementById("windArrow").style.transform = `translate(-50%,-50%) rotate(${d.hourlywinddirections[idx]}deg)`;
          }
        },
        scales: { y: { beginAtZero: true }, x: {} }
      }
    });
  }, 130);
}

// --- Render Pioggia ---
function renderRain() {
  const d = DATA.days[selectedDayIndex];
  const pioggia = d.precipitation || 0;
  document.getElementById("rainbox").innerHTML = `
    <div class="box-title">üåßÔ∏è Pioggia</div>
    <div class="main">Totale oggi: <b>${pioggia.toFixed(1)} mm</b> ${rainIcon(pioggia)}</div>
    <div class="desc">Previsione: ${pioggia > 0 ? "Possibile precipitazione" : "Nessuna pioggia significativa"}</div>
    <button class="detail-btn" onclick="toggleDetail('rain-detail')">Dettagli / Grafico</button>
    <div class="detail-section" id="rain-detail">
      <div class="chart-wrap"><canvas id="rainchart"></canvas></div>
      <div class="fixed-info">
        <span class="info info-rain">Ora pi√π piovosa: ${d.hourlylabels && d.hourlyprecips ? d.hourlylabels[d.hourlyprecips.indexOf(Math.max(...d.hourlyprecips))] : "--"}</span>
        <span class="info info-rain">Max: ${d.hourlyprecips ? Math.max(...d.hourlyprecips) : "--"} mm</span>
      </div>
    </div>
  `;
  setTimeout(() => {
    if (rainChart) { rainChart.destroy(); }
    const ctx = document.getElementById('rainchart').getContext('2d');
    rainChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: d.hourlylabels || [],
        datasets: [{
          label: 'Precipitazioni (mm)', data: d.hourlyprecips || [],
          backgroundColor: '#45bafe', borderColor: '#52afe7', borderWidth: 2
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false }, tooltip: { enabled: true, mode: 'nearest', intersect: false } },
        scales: { y: { beginAtZero: true }, x: {} }
      }
    });
  }, 100);
}

// --- Render Mare ---
function renderSea() {
  const arr = DATA.mergedHourly || [];
  const waveMean = calculateMean(arr.map(h => h.waveheight));
  const waveRange = calculateRange(arr.map(h => h.waveheight));
  const waveStdDev = calculateStdDev(arr.map(h => h.waveheight));
  const seaTemp = calculateMean(arr.map(h => h.seasurfacetemperature));
  document.getElementById("seabox").innerHTML = `
    <div class="box-title">üåä Mare</div>
    <div class="main">Altezza media onda: <b>${waveMean.toFixed(2)} m</b></div>
    <div class="desc">Temperatura mare: <b>${seaTemp.toFixed(1)} ¬∞C</b></div>
    <button class="detail-btn" onclick="toggleDetail('sea-detail')">Dettagli / Grafico</button>
    <div class="detail-section" id="sea-detail">
      <div class="chart-wrap"><canvas id="seachart"></canvas></div>
      <div class="fixed-info">
        <span class="info info-sea">Hsig: ${waveMean.toFixed(2)} m</span>
        <span class="info info-sea">Range: ${waveRange.toFixed(2)} m</span>
        <span class="info info-sea">Dev Std: ${waveStdDev.toFixed(2)} m</span>
      </div>
    </div>
  `;
  setTimeout(() => {
    if (seaChart) { seaChart.destroy(); }
    const ctx = document.getElementById('seachart').getContext('2d');
    seaChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: arr.map(h => h.time.slice(11, 16)),
        datasets: [
          { label: 'Onda (m)', data: arr.map(h => h.waveheight), borderColor: '#41f8bd', backgroundColor: 'rgba(34,255,170,0.10)', fill: true, tension: 0.22, pointRadius: 2, pointBackgroundColor: '#25A9FA' },
          { label: 'Swell (m)', data: arr.map(h => h.swellheight), borderColor: '#21D08A', backgroundColor: 'rgba(34,255,170,0.06)', fill: true, tension: 0.18, pointRadius: 2, pointBackgroundColor: '#21D08A' }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: true }, tooltip: { enabled: true, mode: 'nearest', intersect: false } },
        scales: { y: { beginAtZero: true }, x: {} }
      }
    });
  }, 100);
}

// --- Render Pressione ---
function renderPress() {
  const d = DATA.days[selectedDayIndex];
  const arr = d.hourlypressures || [];
  const pressMean = calculateMean(arr);
  const pressTrendTxt = pressureTrend(arr);
  document.getElementById("pressbox").innerHTML = `
    <div class="box-title">üîΩ Pressione</div>
    <div class="main">Media oggi: <b>${pressMean.toFixed(1)} hPa</b></div>
    <div class="desc">Tendenza: ${pressTrendTxt}</div>
    <button class="detail-btn" onclick="toggleDetail('press-detail')">Dettagli / Grafico</button>
    <div class="detail-section" id="press-detail">
      <div class="chart-wrap"><canvas id="presschart"></canvas></div>
      <div class="fixed-info">
        <span class="info info-press">Max: ${arr.length ? Math.max(...arr) : "--"} hPa</span>
        <span class="info info-press">Min: ${arr.length ? Math.min(...arr) : "--"} hPa</span>
      </div>
    </div>
  `;
  setTimeout(() => {
    if (pressChart) { pressChart.destroy(); }
    const ctx = document.getElementById('presschart').getContext('2d');
    pressChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: d.hourlylabels || [],
        datasets: [{ label: 'Pressione (hPa)', data: arr, borderColor: '#ffd472', backgroundColor: 'rgba(255,240,51,0.10)', fill: true, tension: 0.22, pointRadius: 1 }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false }, tooltip: { enabled: true, mode: 'nearest', intersect: false } },
        scales: { y: { beginAtZero: false }, x: {} }
      }
    });
  }, 100);
}

// --- Render Card ampia oggi ---
function renderTodayCard() {
  const d = DATA.days[0];
  document.getElementById('todayCard').innerHTML = `
  <div class="today-wide-card">
    <div class="icon">${d.icon}</div>
    <div class="meta">
      <div><span class="daylabel">${d.day_label}</span> ‚Ä¢ <span class="tmax">‚Üë${d.temp_max}¬∞</span> <span class="tmin">‚Üì${d.temp_min}¬∞</span></div>
      <div><span class="wind">üí® ${d.wind_max} km/h</span> <span class="rain">${rainIcon(d.precipitation || 0)} ${d.precipitation || 0}mm</span></div>
    </div>
    <div>
      <div class="advice-box">${DATA.advice || ''}</div>
      <div class="alert-box">${DATA.alerts && DATA.alerts[0] ? DATA.alerts[0] : ''}</div>
    </div>
  </div>
  `;
}

// --- Render griglia giorni successivi ---
function renderMiniDaysGrid() {
  let html = "";
  DATA.days.slice(1, 7).forEach((d, idx) => {
    html += `
      <div class="mini-day${selectedDayIndex === (idx + 1) ? ' selected' : ''}" onclick="selectDay(${idx + 1})">
        <div class="daylabel">${d.day_label} <span class="icon">${d.icon}</span></div>
        <div><span class="tmax">‚Üë ${d.temp_max}¬∞</span> <span class="tmin">‚Üì ${d.temp_min}¬∞</span></div>
        <div><span class="wind">üí® ${d.wind_max} km/h</span> <span class="rain">${rainIcon(d.precipitation || 0)} ${d.precipitation || 0}mm</span></div>
      </div>
    `;
  });
  document.getElementById('miniDaysGrid').innerHTML = html;
}

// --- Footer dinamico trimestre ---
function renderFooter() {
  document.getElementById("footer").innerHTML = `Powered by Open-Meteo ‚Ä¢ UI by micheledv74 ‚Ä¢ Ultimo agg.: <span id="updated_stamp">${DATA.updated_at}</span>`;
}

// --- Render completo ---
function renderAll() {
  renderWind();
  renderRain();
  renderSea();
  renderPress();
  renderTodayCard();
  renderMiniDaysGrid();
  renderFooter();
}

renderAll();
</script>
</body>
</html>
